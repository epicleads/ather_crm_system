{% extends "base.html" %}

{% block title %}PS Dashboard - Ather CRM{% endblock %}

<style>
    /* Overdue lead highlighting */
    .table-danger {
        background-color: #f8d7da !important;
        border-left: 4px solid #dc3545 !important;
    }
    
    .table-danger:hover {
        background-color: #f5c6cb !important;
    }
    
    .table-danger td {
        border-color: #f5c6cb !important;
    }
    
    /* Overdue badge styling */
    .badge.bg-danger {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Followup summary styling */
    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }
    
    .alert-info strong {
        color: #0c5460;
    }
</style>

{% block content %}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-user-tie text-info"></i> Product Specialist Dashboard</h2>
                <p class="text-muted">Welcome, {{ ps_name or session.ps_name or 'Unknown' }} | Branch: {{ session.branch or 'Unknown' }}</p>
            </div>
            <div class="btn-group">
                <a href="{{ url_for('ps_analytics') }}" class="btn btn-outline-primary">
                    <i class="fas fa-chart-line"></i> Analytics
                </a>
                <button type="button" class="btn btn-primary" id="psAddWalkinBtn" onclick="window.location.href='{{ url_for('add_walkin_lead') }}'">
                    <i class="fas fa-plus"></i> Add Walk-in Lead
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-2" id="fresh-leads-stats">
        <div class="stats-card bg-primary text-white p-3 rounded h-100">
            <div class="d-flex flex-column h-100">
                <div class="mb-2">
                    <h6 class="mb-1 fw-bold text-white">Fresh Leads</h6>
                    <div class="fs-4 fw-bold text-white">{{ total_fresh_leads }}</div>
                </div>
                <div class="d-flex justify-content-between mt-auto">
                    <div class="flex-fill mx-1 rounded p-2" style="background: #d4edda; color: #155724;">
                        <div class="fw-semibold">{{ untouched_count }}</div>
                    </div>
                    <div class="flex-fill mx-1 rounded p-2" style="background: #ffe5b4; color: #b26a00;">
                        <div class="fw-semibold">{{ called_count }}</div>
                    </div>
                    <div class="flex-fill mx-1 rounded p-2" style="background: #fff3cd; color: #856404;">
                        <div class="fw-semibold">{{ follow_up_count }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stats-card bg-warning text-dark p-3 rounded h-100">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1 text-white">{{ todays_followups|length }}</h4>
                    <small class="text-white">Today's Follow-ups</small>
                </div>
                <i class="fas fa-calendar-check fa-2x text-white"></i>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stats-card bg-success text-white p-3 rounded h-100">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1 text-white">{{ pending_leads|length }}</h4>
                    <small class="text-white">Pending Leads</small>
                </div>
                <i class="fas fa-check-circle fa-2x text-white"></i>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stats-card bg-info text-white p-3 rounded h-100">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1 text-white" id="kpiWonCount">{{ won_leads|length }}</h4>
                    <small class="text-white">Won Leads</small>
                </div>
                <i class="fas fa-trophy fa-2x text-white"></i>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="stats-card bg-danger text-white p-3 rounded h-100">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-1 text-white" id="kpiLostCount">{{ lost_leads|length }}</h4>
                    <small class="text-white">Lost Leads</small>
                </div>
                <i class="fas fa-ban fa-2x text-white"></i>
            </div>
        </div>
    </div>
</div>



<!-- Tabs for different lead views -->
<div class="card shadow mb-4">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="psLeadTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="fresh-leads-tab" data-bs-toggle="tab" data-bs-target="#fresh-leads" type="button" role="tab" aria-controls="fresh-leads" aria-selected="true">
                    <i class="fas fa-clock me-2"></i>Fresh Leads
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="followups-tab" data-bs-toggle="tab" data-bs-target="#followups" type="button" role="tab" aria-controls="followups" aria-selected="false">
                    <i class="fas fa-calendar-check me-2"></i>Today's Follow-ups
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" aria-controls="pending" aria-selected="false">
                    <i class="fas fa-phone-slash me-2"></i>Pending Leads
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="won-lost-tab" data-bs-toggle="tab" data-bs-target="#won-lost" type="button" role="tab" aria-controls="won-lost" aria-selected="false" tabindex="-1">
                    <i class="fas fa-trophy me-2"></i>Won/Lost
                </button>
            </li>

            <!-- Event Leads Tab -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="event-leads-tab" data-bs-toggle="tab" data-bs-target="#event-leads" type="button" role="tab" aria-controls="event-leads" aria-selected="false" tabindex="-1">
                    <i class="fas fa-calendar-alt me-2"></i>Event Leads
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="walkin-leads-tab" data-bs-toggle="tab" data-bs-target="#walkin-leads" type="button" role="tab" aria-controls="walkin-leads" aria-selected="false" tabindex="-1">
                    <i class="fas fa-store me-2"></i>Walkin Leads
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="psLeadTabsContent">
            <!-- Fresh Leads Tab -->
            <div class="tab-pane fade show active" id="fresh-leads" role="tabpanel" aria-labelledby="fresh-leads-tab">
                <div class="d-flex align-items-center mb-3 date-filter-controls" id="psFilterBar-fresh">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="freshFilterDropdown">
                            {% if filter_type == 'today' %}Today{% elif filter_type == 'range' %}Date Range{% else %}All Time{% endif %}
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item fresh-filter-option" href="#" data-filter="today">Today</a></li>
                            <li><a class="dropdown-item fresh-filter-option" href="#" data-filter="all">All Time</a></li>
                            <li><a class="dropdown-item fresh-filter-option" href="#" data-filter="range">Date Range</a></li>
                        </ul>
                    </div>
                    <input type="date" class="form-control me-2 {% if filter_type != 'range' %}d-none{% endif %}" id="freshFilterStartDate" value="{{ start_date or '' }}" style="width: 160px;">
                    <input type="date" class="form-control me-2 {% if filter_type != 'range' %}d-none{% endif %}" id="freshFilterEndDate" value="{{ end_date or '' }}" style="width: 160px;">
                    <button class="btn btn-outline-secondary ms-2" id="freshFilterClearBtn" title="Clear date filter">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Fresh Leads ({{ total_fresh_leads }})</h5>
                    <div class="d-flex gap-2">
                        <div class="input-group" style="max-width: 300px;">
                            <input type="text" class="form-control" id="freshLeadSearchInput" placeholder="Search by UID, name, mobile...">
                            <button class="btn btn-outline-secondary" type="button" id="freshLeadSearchButton">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-warning" type="button" id="freshLeadClearButton">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Fresh Leads Subsection Navigation -->
                <ul class="nav nav-tabs mb-3" id="freshLeadsSubTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="untouched-leads-tab" data-bs-toggle="tab" data-bs-target="#untouched-leads" type="button" role="tab" aria-controls="untouched-leads" aria-selected="true">
                            Untouched <span class="badge bg-secondary">{{ untouched_count }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="called-leads-tab" data-bs-toggle="tab" data-bs-target="#called-leads" type="button" role="tab" aria-controls="called-leads" aria-selected="false">
                            Called <span class="badge bg-secondary">{{ called_count }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="follow-up-leads-tab" data-bs-toggle="tab" data-bs-target="#follow-up-leads" type="button" role="tab" aria-controls="follow-up-leads" aria-selected="false">
                            Follow Up <span class="badge bg-warning">{{ follow_up_count }}</span>
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="freshLeadsSubTabContent">
                    <!-- Untouched Leads Table -->
                    <div class="tab-pane fade show active" id="untouched-leads" role="tabpanel" aria-labelledby="untouched-leads-tab">
                        {% if untouched_leads %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="untouchedLeadsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Action</th>
                                        <th>Lead Status</th>
                                        <th>Customer Name</th>
                                        <th>Mobile</th>
                                        <th>Source</th>
                                        <th>CRE Name</th>
                                        <th>Category</th>
                                        <th>Model Interested</th>
                                        <th>Created Date</th>
                                        <th>UID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lead in untouched_leads %}
                                    <tr class="untouched-lead-row" data-created="{{ (lead.ps_assigned_at[:10] if lead.ps_assigned_at else lead.created_at[:10] if lead.created_at else '') }}"
                                        data-search="{{ ((lead.lead_uid or '') + ' ' + (lead.customer_name or '') + ' ' + (lead.customer_mobile_number or '') + ' ' + (lead.source or '') + ' ' + (lead.cre_name or ''))|lower }}">
                                        <td>
                                            {% if lead.activity_uid %}
                                                <a href="{{ url_for('update_event_lead', activity_uid=lead.activity_uid, return_tab='fresh-leads') }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i> Update
                                                </a>
                                            {% elif lead.is_walkin %}
                                                <a href="{{ url_for('update_walkin_lead', walkin_id=lead.walkin_id) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i> Update
                                                </a>
                                            {% else %}
                                                <a href="{{ url_for('update_ps_lead', uid=lead.lead_uid, return_tab='fresh-leads') }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i> Update
                                                </a>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if lead.lead_status %}
                                                <span class="badge bg-info">{{ lead.lead_status }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Not Set</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ lead.customer_name }}</td>
                                        <td>{{ lead.customer_mobile_number }}</td>
                                        <td><span class="badge bg-secondary">{{ lead.source or 'N/A' }}</span></td>
                                        <td>{{ lead.cre_name }}</td>
                                        <td>
                                            {% if lead.lead_category and lead.lead_category|lower == 'hot' %}
                                                <span class="badge bg-danger">{{ lead.lead_category }}</span>
                                            {% elif lead.lead_category and lead.lead_category|lower == 'warm' %}
                                                <span class="badge bg-warning">{{ lead.lead_category }}</span>
                                            {% elif lead.lead_category and lead.lead_category|lower == 'cold' %}
                                                <span class="badge bg-info">{{ lead.lead_category }}</span>
                                            {% else %}
                                                <span class="badge bg-dark">{{ lead.lead_category or 'Not Set' }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ lead.model_interested or 'Not specified' }}</td>
                                        <td>{{ (lead.ps_assigned_at[:10] if lead.ps_assigned_at else lead.created_at[:10] if lead.created_at else 'N/A') }}</td>
                                        <td><span class="badge bg-primary">{{ lead.lead_uid }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No untouched leads</h5>
                            <p class="text-muted">All assigned leads have been attended</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Called Leads Table -->
                    <div class="tab-pane fade" id="called-leads" role="tabpanel" aria-labelledby="called-leads-tab">
                        {% if called_leads %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="calledLeadsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Action</th>
                                        <th>Lead Status</th>
                                        <th>Customer Name</th>
                                        <th>Mobile</th>
                                        <th>Source</th>
                                        <th>CRE Name</th>
                                        <th>Category</th>
                                        <th>Model Interested</th>
                                        <th>Created Date</th>
                                        <th>UID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lead in called_leads %}
                                    <tr class="called-lead-row" data-created="{{ (lead.ps_assigned_at[:10] if lead.ps_assigned_at else lead.created_at[:10] if lead.created_at else '') }}"
                                        data-search="{{ ((lead.lead_uid or '') + ' ' + (lead.customer_name or '') + ' ' + (lead.customer_mobile_number or '') + ' ' + (lead.source or '') + ' ' + (lead.cre_name or ''))|lower }}">
                                        <td>
                                            {% if lead.activity_uid %}
                                                <a href="{{ url_for('update_event_lead', activity_uid=lead.activity_uid, return_tab='fresh-leads') }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i> Update
                                                </a>
                                            {% elif lead.is_walkin %}
                                                <a href="{{ url_for('update_walkin_lead', walkin_id=lead.walkin_id) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i> Update
                                                </a>
                                            {% else %}
                                                <a href="{{ url_for('update_ps_lead', uid=lead.lead_uid, return_tab='fresh-leads') }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i> Update
                                                </a>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if lead.lead_status %}
                                                <span class="badge bg-info">{{ lead.lead_status }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Not Set</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ lead.customer_name }}</td>
                                        <td>{{ lead.customer_mobile_number }}</td>
                                        <td><span class="badge bg-secondary">{{ lead.source or 'N/A' }}</span></td>
                                        <td>{{ lead.cre_name }}</td>
                                        <td>
                                            {% if lead.lead_category and lead.lead_category|lower == 'hot' %}
                                                <span class="badge bg-danger">{{ lead.lead_category }}</span>
                                            {% elif lead.lead_category and lead.lead_category|lower == 'warm' %}
                                                <span class="badge bg-warning">{{ lead.lead_category }}</span>
                                            {% elif lead.lead_category and lead.lead_category|lower == 'cold' %}
                                                <span class="badge bg-info">{{ lead.lead_category }}</span>
                                            {% else %}
                                                <span class="badge bg-dark">{{ lead.lead_category or 'Not Set' }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ lead.model_interested or 'Not specified' }}</td>
                                        <td>{{ (lead.ps_assigned_at[:10] if lead.ps_assigned_at else lead.created_at[:10] if lead.created_at else 'N/A') }}</td>
                                        <td><span class="badge bg-primary">{{ lead.lead_uid }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-phone fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No called leads</h5>
                            <p class="text-muted">No leads have been called yet</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Follow Up Leads Table -->
                    <div class="tab-pane fade" id="follow-up-leads" role="tabpanel" aria-labelledby="follow-up-leads-tab">
                        {% if follow_up_leads %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="followUpLeadsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Action</th>
                                        <th>Lead Status</th>
                                        <th>Customer Name</th>
                                        <th>Mobile</th>
                                        <th>Source</th>
                                        <th>CRE Name</th>
                                        <th>Category</th>
                                        <th>Model Interested</th>
                                        <th>Created Date</th>
                                        <th>UID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lead in follow_up_leads %}
                                    <tr class="follow-up-lead-row" data-created="{{ (lead.ps_assigned_at[:10] if lead.ps_assigned_at else lead.created_at[:10] if lead.created_at else '') }}"
                                        data-search="{{ ((lead.lead_uid or '') + ' ' + (lead.customer_name or '') + ' ' + (lead.customer_mobile_number or '') + ' ' + (lead.source or '') + ' ' + (lead.cre_name or ''))|lower }}">
                                        <td>
                                            {% if lead.activity_uid %}
                                                <a href="{{ url_for('update_event_lead', activity_uid=lead.activity_uid, return_tab='fresh-leads') }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i> Update
                                                </a>
                                            {% elif lead.is_walkin %}
                                                <a href="{{ url_for('update_walkin_lead', walkin_id=lead.walkin_id) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i> Update
                                                </a>
                                            {% else %}
                                                <a href="{{ url_for('update_ps_lead', uid=lead.lead_uid, return_tab='fresh-leads') }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i> Update
                                                </a>
                                            {% endif %}
                                        </td>
                                        <td><span class="badge bg-warning">{{ lead.lead_status }}</span></td>
                                        <td>{{ lead.customer_name }}</td>
                                        <td>{{ lead.customer_mobile_number }}</td>
                                        <td><span class="badge bg-secondary">{{ lead.source or 'N/A' }}</span></td>
                                        <td>{{ lead.cre_name }}</td>
                                        <td>
                                            {% if lead.lead_category and lead.lead_category|lower == 'hot' %}
                                                <span class="badge bg-danger">{{ lead.lead_category }}</span>
                                            {% elif lead.lead_category and lead.lead_category|lower == 'warm' %}
                                                <span class="badge bg-warning">{{ lead.lead_category }}</span>
                                            {% elif lead.lead_category and lead.lead_category|lower == 'cold' %}
                                                <span class="badge bg-info">{{ lead.lead_category }}</span>
                                            {% else %}
                                                <span class="badge bg-dark">{{ lead.lead_category or 'Not Set' }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ lead.model_interested or 'Not specified' }}</td>
                                        <td>{{ (lead.ps_assigned_at[:10] if lead.assigned_at else lead.created_at[:10] if lead.created_at else 'N/A') }}</td>
                                        <td><span class="badge bg-primary">{{ lead.lead_uid }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No follow-up leads</h5>
                            <p class="text-muted">No leads require follow-up</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if fresh_leads %}
                <!-- This section is now handled by the three subsections above -->
                {% endif %}

            </div>

            <!-- Today's Follow-ups Tab -->
            <div class="tab-pane fade" id="followups" role="tabpanel" aria-labelledby="followups-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Today's Follow-ups ({{ todays_followups|length }})</h5>
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control" id="followupSearchInput" placeholder="Search by UID, name, mobile...">
                        <button class="btn btn-outline-secondary" type="button" id="followupSearchButton">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="btn btn-outline-warning" type="button" id="followupClearButton">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                {% if todays_followups %}
                <!-- Followup Summary -->
                {% set overdue_count = todays_followups | selectattr('is_overdue', 'equalto', true) | list | length %}
                {% set today_count = todays_followups | selectattr('is_overdue', 'equalto', false) | list | length %}
                <div class="alert alert-info mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <strong><i class="fas fa-calendar-check text-success"></i> Today's Followups:</strong> {{ today_count }}
                        </div>
                        <div class="col-md-6">
                            <strong><i class="fas fa-exclamation-triangle text-danger"></i> Overdue Followups:</strong> {{ overdue_count }}
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="followupTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Action</th>
                                <th>Lead Status</th>
                                <th>Customer Name</th>
                                <th>Mobile</th>
                                <th>Category</th>
                                <th>Model Interested</th>
                                <th>Follow-up Date</th>
                                <th>UID</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in todays_followups %}
                            <tr class="{% if lead.is_overdue %}table-danger{% endif %}" 
                                data-search="{{ ((lead.lead_uid or '') + ' ' + (lead.customer_name or '') + ' ' + (lead.customer_mobile_number or '') + ' ' + (lead.source or ''))|lower }}"
                                {% if lead.is_overdue %}title="OVERDUE: {{ lead.overdue_days }} day(s) past due"{% endif %}>
                                <td>
                                    {% if lead.activity_uid %}
                                        <a href="{{ url_for('update_event_lead', activity_uid=lead.activity_uid, return_tab='followups') }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i> Update
                                        </a>
                                    {% elif lead.is_walkin %}
                                        <a href="{{ url_for('update_walkin_lead', walkin_id=lead.walkin_id, return_tab='followups') }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i> Update
                                        </a>
                                    {% else %}
                                        <a href="{{ url_for('update_ps_lead', uid=lead.lead_uid, return_tab='followups') }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i> Update
                                        </a>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if lead.lead_status %}
                                        <span class="badge bg-info">{{ lead.lead_status }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Not Set</span>
                                    {% endif %}
                                </td>
                                <td>{{ lead.customer_name }}</td>
                                <td>{{ lead.customer_mobile_number }}</td>
                                <td>
                                    {% if lead.lead_category and lead.lead_category|lower == 'hot' %}
                                        <span class="badge bg-danger">{{ lead.lead_category }}</span>
                                    {% elif lead.lead_category and lead.lead_category|lower == 'warm' %}
                                        <span class="badge bg-warning">{{ lead.lead_category }}</span>
                                    {% elif lead.lead_category and lead.lead_category|lower == 'cold' %}
                                        <span class="badge bg-info">{{ lead.lead_category }}</span>
                                    {% else %}
                                        <span class="badge bg-dark">{{ lead.lead_category or 'Not Set' }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ lead.model_interested or 'Not specified' }}</td>
                                <td>
                                    {% if lead.follow_up_date %}
                                        {% if lead.is_overdue %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                OVERDUE: {{ lead.overdue_days }} day(s)
                                            </span>
                                            <br><small class="text-muted">{{ lead.follow_up_date.replace('T', ' ')[:16] }}</small>
                                        {% else %}
                                            <span class="badge bg-warning">{{ lead.follow_up_date.replace('T', ' ')[:16] }}</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-primary">{{ lead.lead_uid }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No follow-ups scheduled for today</h5>
                    <p class="text-muted">Set follow-up dates when updating leads</p>
                </div>
                {% endif %}
            </div>

            <!-- Pending Leads Tab -->
            <div class="tab-pane fade" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Pending Leads ({{ pending_leads|length }})</h5>
                    <div class="d-flex gap-2">
                        <!-- Lead Category Toggle Buttons -->
                        <div class="btn-group me-2" role="group" aria-label="Lead Category Filters">
                            <button type="button" class="btn btn-outline-danger category-toggle" data-category="Hot" id="hotToggle">
                                <i class="fas fa-fire"></i> H
                            </button>
                            <button type="button" class="btn btn-outline-warning category-toggle" data-category="Warm" id="warmToggle">
                                <i class="fas fa-sun"></i> W
                            </button>
                            <button type="button" class="btn btn-outline-info category-toggle" data-category="Cold" id="coldToggle">
                                <i class="fas fa-snowflake"></i> C
                            </button>
                        </div>
                        <div class="input-group" style="max-width: 300px;">
                            <input type="text" class="form-control" id="pendingSearchInput" placeholder="Search by UID, name, mobile...">
                            <button class="btn btn-outline-secondary" type="button" id="pendingSearchButton">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-warning" type="button" id="pendingClearButton">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                {% if pending_leads %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="pendingLeadsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Action</th>
                                <th>Lead Status</th>
                                <th>Customer Name</th>
                                <th>Mobile</th>
                                <th>Source</th>
                                <th>Category</th>
                                <th>Model Interested</th>
                                <th>Created Date</th>
                                <th>UID</th>
                                <th>Call History</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in pending_leads %}
                            <tr class="pending-lead-row"
                                data-search="{{ ((lead.lead_uid or '') + ' ' + (lead.customer_name or '') + ' ' + (lead.customer_mobile_number or '') + ' ' + (lead.source or ''))|lower }}">
                                <td>
                                    {% if lead.activity_uid %}
                                        <a href="{{ url_for('update_event_lead', activity_uid=lead.activity_uid, return_tab='pending') }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i> Update
                                        </a>
                                    {% elif lead.is_walkin %}
                                        <a href="{{ url_for('update_walkin_lead', walkin_id=lead.walkin_id, return_tab='pending') }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i> Update
                                        </a>
                                    {% else %}
                                        <a href="{{ url_for('update_ps_lead', uid=lead.lead_uid, return_tab='pending', category_filter=lead.lead_category) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i> Update
                                        </a>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if lead.lead_status %}
                                        <span class="badge bg-info">{{ lead.lead_status }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Not Set</span>
                                    {% endif %}
                                </td>
                                <td>{{ lead.customer_name }}</td>
                                <td>{{ lead.customer_mobile_number }}</td>
                                <td><span class="badge bg-secondary">{{ lead.source or 'N/A' }}</span></td>
                                <td>
                                    {% if lead.lead_category and lead.lead_category|lower == 'hot' %}
                                        <span class="badge bg-danger">{{ lead.lead_category }}</span>
                                    {% elif lead.lead_category and lead.lead_category|lower == 'warm' %}
                                        <span class="badge bg-warning">{{ lead.lead_category }}</span>
                                    {% elif lead.lead_category and lead.lead_category|lower == 'cold' %}
                                        <span class="badge bg-info">{{ lead.lead_category }}</span>
                                    {% elif lead.lead_category and lead.lead_category|lower == 'not interested' %}
                                        <span class="badge bg-secondary">{{ lead.lead_category }}</span>
                                    {% else %}
                                        <span class="badge bg-dark">{{ lead.lead_category or 'Not Set' }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ lead.model_interested or 'Not specified' }}</td>
                                <td>{{ (lead.ps_assigned_at[:10] if lead.ps_assigned_at else lead.created_at[:10] if lead.created_at else 'N/A') }}</td>
                                <td><span class="badge bg-primary">{{ lead.lead_uid }}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info view-call-history-btn" data-uid="{{ lead.lead_uid }}" title="View Call History">
                                        <i class="fas fa-history"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-phone-slash fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No pending leads</h5>
                    <p class="text-muted">Leads will appear here after your first call</p>
                </div>
                {% endif %}
            </div>

            <!-- Won/Lost Leads Toggle Tab -->
            <div class="tab-pane fade" id="won-lost" role="tabpanel" aria-labelledby="won-lost-tab">
                <div class="d-flex align-items-center mb-3 justify-content-between">
                    <div class="d-flex align-items-center flex-wrap gap-3">
                        <h5 class="mb-0 me-1" id="wonLostHeader">{{ 'Won' if status == 'won' else 'Lost' }} Leads ({{ (won_leads if status == 'won' else lost_leads)|length }})</h5>
                        <!-- Counts -->
                        <span class="badge bg-success" id="wonCountBadge" title="Won count">Won: <span id="wonCountValue">-</span></span>
                        <span class="badge bg-danger" id="lostCountBadge" title="Lost count">Lost: <span id="lostCountValue">-</span></span>
                        <!-- Modern Slider Toggle -->
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="wonLostToggle" {% if status == 'won' %}checked{% endif %}>
                                <span class="slider"></span>
                                <span class="toggle-label-left">Lost</span>
                                <span class="toggle-label-right">Won</span>
                            </label>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap align-items-center gap-2">
                        <!-- Filter Bar: MTD (default), Today, All Time, Date Range -->
                        <div class="btn-group" role="group" aria-label="Won/Lost Date Filters">
                            <button class="btn btn-outline-primary active" id="filterMtdBtn" data-filter="mtd">MTD</button>
                            <button class="btn btn-outline-primary" id="filterTodayBtn" data-filter="today">Today</button>
                            <button class="btn btn-outline-primary" id="filterAllBtn" data-filter="all">All Time</button>
                        </div>
                        <div class="d-flex align-items-center gap-1">
                            <input type="date" class="form-control form-control-sm" id="filterFromDate" placeholder="From">
                            <span class="mx-1">to</span>
                            <input type="date" class="form-control form-control-sm" id="filterToDate" placeholder="To">
                            <button class="btn btn-sm btn-secondary" id="filterRangeApply">Apply</button>
                        </div>
                        <div class="input-group" style="max-width: 300px;">
                            <input type="text" class="form-control" id="wonLostLeadSearchInput" placeholder="Search by UID, name, mobile...">
                            <button class="btn btn-outline-secondary" type="button" id="wonLostLeadSearchButton">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-warning" type="button" id="wonLostLeadClearButton">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% set leads_list = won_leads if status == 'won' else lost_leads %}
                {% include 'ps_dashboard_leads_table.html' %}
            </div>


            <!-- Event Leads Tab Content -->
            <div class="tab-pane fade" id="event-leads" role="tabpanel" aria-labelledby="event-leads-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <h5 class="mb-0">Event Leads ({{ event_leads|length }})</h5>
                        <a href="{{ url_for('activity_event') }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-1"></i>Add Event Lead
                        </a>
                        <a href="{{ url_for('view_event_leads') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-list me-1"></i>View All
                        </a>
                    </div>
                    <div class="d-flex gap-2">
                        <div class="input-group" style="max-width: 300px;">
                            <input type="text" class="form-control" id="eventLeadSearchInput" placeholder="Search by UID, name, mobile, model...">
                            <button class="btn btn-outline-secondary" type="button" id="eventLeadSearchButton">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-warning" type="button" id="eventLeadClearButton">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% if event_leads %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="eventLeadsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Action</th>
                                <th>UID</th>
                                <th>Activity Name</th>
                                <th>Activity Location</th>
                                <th>PS Name</th>
                                <th>Branch</th>
                                <th>Customer Name</th>
                                <th>Mobile</th>
                                <th>Customer Location</th>
                                <th>Profession</th>
                                <th>Gender</th>
                                <th>Interested Model</th>
                                <th>Remarks</th>
                                <th>Lead Status</th>
                                <th>Month</th>
                                <th>Date</th>
                                <th>Call History</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in event_leads %}
                            <tr data-search="{{ ((lead.activity_uid or '') + ' ' + (lead.activity_name or '') + ' ' + (lead.customer_name or '') + ' ' + (lead.customer_phone_number or '') + ' ' + (lead.interested_model or '') + ' ' + (lead.customer_location or ''))|lower }}">
                                <td>
                                    <a href="{{ url_for('update_event_lead', activity_uid=lead.activity_uid, return_tab='event-leads') }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i> Update
                                    </a>
                                </td>
                                <td><span class="badge bg-primary">{{ lead.activity_uid }}</span></td>
                                <td>{{ lead.activity_name }}</td>
                                <td>{{ lead.activity_location }}</td>
                                <td>{{ lead.ps_name }}</td>
                                <td>{{ lead.location }}</td>
                                <td>{{ lead.customer_name }}</td>
                                <td>{{ lead.customer_phone_number }}</td>
                                <td>{{ lead.customer_location }}</td>
                                <td>{{ lead.customer_profession }}</td>
                                <td>{{ lead.gender }}</td>
                                <td>{{ lead.interested_model }}</td>
                                <td>{{ lead.remarks }}</td>
                                <td>{{ lead.lead_status }}</td>
                                <td>{{ lead.month }}</td>
                                <td>{{ lead.date }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info view-call-history-btn" data-uid="{{ lead.activity_uid }}" title="View Call History">
                                        <i class="fas fa-history"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No event leads</h5>
                    <p class="text-muted">Event leads will appear here when added</p>
                </div>
                {% endif %}
            </div>

            <!-- Walkin Leads Tab Content -->
            <div class="tab-pane fade" id="walkin-leads" role="tabpanel" aria-labelledby="walkin-leads-tab">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Walkin Leads ({{ walkin_leads|length }})</h5>
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control" id="walkinLeadSearchInput" placeholder="Search by UID, name, mobile...">
                        <button class="btn btn-outline-secondary" type="button" id="walkinLeadSearchButton">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="btn btn-outline-warning" type="button" id="walkinLeadClearButton">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                {% if walkin_leads %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="walkinLeadsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Action</th>
                                <th>Status</th>
                                <th>Customer Name</th>
                                <th>Mobile</th>
                                <th>Lead Source</th>
                                <th>Category</th>
                                <th>Model Interested</th>
                                <th>Branch</th>
                                <th>UID</th>
                                <th>Assigned At</th>
                                <th>Call History</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in walkin_leads %}
                            <tr data-search="{{ ((lead.lead_uid or '') + ' ' + (lead.customer_name or '') + ' ' + (lead.mobile_number or '') + ' ' + (lead.lead_source or '') + ' ' + (lead.lead_category or '') + ' ' + (lead.model_interested or ''))|lower }}">
                                <td>
                                    <a href="{{ url_for('update_walkin_lead', walkin_id=lead.id, return_tab='walkin-leads') }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i> Update
                                    </a>
                                </td>
                                <td>
                                    {% if lead.status == 'Won' %}
                                        <span class="badge bg-success">Won</span>
                                    {% elif lead.status == 'Lost' %}
                                        <span class="badge bg-danger">Lost</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                    {% endif %}
                                </td>
                                <td>{{ lead.customer_name }}</td>
                                <td>{{ lead.mobile_number }}</td>
                                <td>{{ lead.lead_source or 'N/A' }}</td>
                                <td>{{ lead.lead_category or 'N/A' }}</td>
                                <td>{{ lead.model_interested or 'N/A' }}</td>
                                <td>{{ lead.branch }}</td>
                                <td><span class="badge bg-primary">{{ lead.lead_uid }}</span></td>
                                <td>{{ (lead.ps_assigned_at[:10] if lead.ps_assigned_at else lead.created_at[:10] if lead.created_at else 'N/A') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info view-call-history-btn" data-uid="{{ lead.lead_uid }}" title="View Call History">
                                        <i class="fas fa-history"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-store fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No walk-in leads assigned</h5>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- PS Call Attempt History Modal -->
<div class="modal fade" id="psCallHistoryModal" tabindex="-1" aria-labelledby="psCallHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="psCallHistoryModalLabel">Call Attempt History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="psCallHistoryStats" class="mb-3"></div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="psCallHistoryTable">
            <thead class="table-light">
              <tr>
                <th>UID</th>
                <th>CALL NO</th>
                <th>ATTEMPT</th>
                <th>STATUS</th>
                <th>PS NAME</th>
                <th>UPDATE TS</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
            </div>
        </div>
    </div>
</div>

<style>
.call-progress {
    min-width: 120px;
}

.progress {
    background-color: #e9ecef;
}

.stats-card {
    transition: all 0.3s ease;
    border-radius: 10px;
}

.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Fresh Leads card specific styling */
.stats-card.bg-primary .flex-fill {
    transition: all 0.2s ease;
}

.stats-card.bg-primary .flex-fill:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.nav-tabs .nav-link {
    color: var(--ather-text);
}

.nav-tabs .nav-link.active {
    color: var(--ather-primary);
    background-color: var(--ather-card);
    border-color: var(--ather-border) var(--ather-border) var(--ather-card);
}

.nav-tabs .nav-link:hover:not(.active) {
    border-color: transparent;
    color: var(--ather-primary);
}

/* Category Toggle Button Styles */
.category-toggle {
    transition: all 0.3s ease;
    font-weight: bold;
    min-width: 50px;
}

.category-toggle:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.category-toggle.active {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.btn-group .category-toggle:not(:last-child) {
    border-right: 1px solid rgba(0,0,0,0.1);
}

/* Modern Toggle Switch Styles - Bigger and Better */
.toggle-container {
    position: relative;
    width: 120px;
    height: 45px;
    margin-left: 20px;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 120px;
    height: 45px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #dc3545; /* Red for Lost */
    transition: 0.4s ease;
    border-radius: 45px;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

.slider:before {
    position: absolute;
    content: "";
    height: 37px;
    width: 37px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.4s ease;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

input:checked + .slider {
    background-color: #28a745; /* Green for Won */
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

input:checked + .slider:before {
    transform: translateX(75px);
}

.toggle-label-left, .toggle-label-right {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    font-weight: bold;
    color: black;
    z-index: 1;
    pointer-events: none;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.toggle-label-left {
    left: 12px;
}

.toggle-label-right {
    right: 12px;
}

/* Hover effects */
.toggle-switch:hover .slider {
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
}

.toggle-switch:hover input:checked + .slider {
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
}

/* Enhanced date filter styles */
.date-filter-controls {
    transition: all 0.3s ease;
}

.date-filter-controls input[type="date"] {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    padding: 0.375rem 0.75rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.date-filter-controls input[type="date"]:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.date-filter-controls .btn:disabled {
    opacity: 0.65;
    cursor: not-allowed;
}

.date-filter-controls .btn i.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper to set up filter bar logic for a given tab
    function setupFilterBar(tabPrefix, tabName) {
        const filterDropdown = document.getElementById(tabPrefix + 'FilterDropdown');
        const filterOptions = document.querySelectorAll('.' + tabPrefix + '-filter-option');
        const startDateInput = document.getElementById(tabPrefix + 'FilterStartDate');
        const endDateInput = document.getElementById(tabPrefix + 'FilterEndDate');
        const applyBtn = document.getElementById(tabPrefix + 'FilterApplyBtn');
        let selectedFilter = '{{ filter_type }}';
        if (!filterDropdown || !applyBtn) return;
        filterOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                selectedFilter = this.getAttribute('data-filter');
                filterDropdown.textContent = this.textContent;
                if (selectedFilter === 'range') {
                    if (startDateInput) {
                        startDateInput.classList.remove('d-none');
                        startDateInput.style.display = 'inline-block';
                    }
                    if (endDateInput) {
                        endDateInput.classList.remove('d-none');
                        endDateInput.style.display = 'inline-block';
                    }
                } else {
                    if (startDateInput) {
                        startDateInput.classList.add('d-none');
                        startDateInput.style.display = 'none';
                    }
                    if (endDateInput) {
                        endDateInput.classList.add('d-none');
                        endDateInput.style.display = 'none';
                    }
                }
            });
        });
        applyBtn.addEventListener('click', function() {
            let url = new URL(window.location.href.split('?')[0], window.location.origin);
            let params = new URLSearchParams(window.location.search);
            params.set('filter_type', selectedFilter);
            params.set('tab', tabName);
            if (selectedFilter === 'range') {
                if (startDateInput && startDateInput.value) params.set('start_date', startDateInput.value);
                if (endDateInput && endDateInput.value) params.set('end_date', endDateInput.value);
            } else {
                params.delete('start_date');
                params.delete('end_date');
            }
            window.location.href = url.pathname + '?' + params.toString();
        });
    }
    // Setup for Fresh Leads
    setupFilterBar('fresh', 'fresh-leads');
    // Setup for Lost Leads
    setupFilterBar('lost', 'won-lost');
    
    // Enhanced date filtering for fresh leads with client-side filtering
    function setupFreshLeadsDateFilter() {
        const freshFilterDropdown = document.getElementById('freshFilterDropdown');
        const freshFilterOptions = document.querySelectorAll('.fresh-filter-option');
        const freshStartDate = document.getElementById('freshFilterStartDate');
        const freshEndDate = document.getElementById('freshFilterEndDate');
        const freshApplyBtn = document.getElementById('freshFilterApplyBtn');
        
        if (!freshFilterDropdown) return;
        
        // Set default dates for today if not set
        if (!freshStartDate.value && !freshEndDate.value) {
            // Don't set default dates - let it show all leads by default
            // const today = new Date().toISOString().split('T')[0];
            // if (freshStartDate) freshStartDate.value = today;
            // if (freshEndDate) freshEndDate.value = today;
        }
        
        // Function to filter fresh leads by date range across all subsections
        function filterFreshLeadsByDate() {
            const untouchedRows = document.querySelectorAll('#untouchedLeadsTable tbody tr');
            const calledRows = document.querySelectorAll('#calledLeadsTable tbody tr');
            const followUpRows = document.querySelectorAll('#followUpLeadsTable tbody tr');
            
            const startDate = freshStartDate ? freshStartDate.value : '';
            const endDate = freshEndDate ? freshEndDate.value : '';
            
            console.log('Filtering fresh leads by date:', { startDate, endDate });
            console.log('Total rows to filter:', untouchedRows.length + calledRows.length + followUpRows.length);
            
            if (!startDate && !endDate) {
                // Show all rows if no date filter
                [untouchedRows, calledRows, followUpRows].forEach(rows => {
                    rows.forEach(row => {
                        row.style.display = '';
                    });
                });
                updateFreshLeadsCount();
                return;
            }
            
            let totalVisibleCount = 0;
            
            // Filter each subsection
            [untouchedRows, calledRows, followUpRows].forEach((rows, subsectionIndex) => {
                const subsectionName = ['untouched', 'called', 'follow-up'][subsectionIndex];
                let subsectionVisibleCount = 0;
                
                rows.forEach((row, index) => {
                    const createdDate = row.getAttribute('data-created');
                    console.log(`${subsectionName} row ${index} created date:`, createdDate);
                    
                    if (!createdDate || createdDate === 'N/A') {
                        console.log(`${subsectionName} row ${index}: No valid date, hiding row`);
                        row.style.display = 'none';
                        return;
                    }
                    
                    let shouldShow = true;
                    
                    try {
                        if (startDate && endDate) {
                            // Date range filter
                            const rowDate = new Date(createdDate + 'T00:00:00');
                            const start = new Date(startDate + 'T00:00:00');
                            const end = new Date(endDate + 'T23:59:59');
                            
                            shouldShow = rowDate >= start && rowDate <= end;
                            console.log(`${subsectionName} row ${index} date range check:`, { rowDate, start, end, shouldShow });
                        } else if (startDate) {
                            // Only start date
                            const rowDate = new Date(createdDate + 'T00:00:00');
                            const start = new Date(startDate + 'T00:00:00');
                            shouldShow = rowDate >= start;
                            console.log(`${subsectionName} row ${index} start date check:`, { rowDate, start, shouldShow });
                        } else if (endDate) {
                            // Only end date
                            const rowDate = new Date(createdDate + 'T00:00:00');
                            const end = new Date(endDate + 'T23:59:59');
                            shouldShow = rowDate <= end;
                            console.log(`${subsectionName} row ${index} end date check:`, { rowDate, end, shouldShow });
                        }
                    } catch (error) {
                        console.error('Error parsing date:', createdDate, error);
                        shouldShow = false;
                    }
                    
                    row.style.display = shouldShow ? '' : 'none';
                    if (shouldShow) {
                        subsectionVisibleCount++;
                        totalVisibleCount++;
                    }
                    console.log(`${subsectionName} row ${index}: ${shouldShow ? 'SHOWING' : 'HIDING'}`);
                });
                
                console.log(`${subsectionName} visible count:`, subsectionVisibleCount);
            });
            
            console.log('Total visible fresh leads count:', totalVisibleCount);
            updateFreshLeadsCount();
        }
        
        freshFilterOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const selectedFilter = this.getAttribute('data-filter');
                freshFilterDropdown.textContent = this.textContent;
                
                if (selectedFilter === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    if (freshStartDate) {
                        freshStartDate.value = today;
                        freshStartDate.classList.add('d-none');
                    }
                    if (freshEndDate) {
                        freshEndDate.value = today;
                        freshEndDate.classList.add('d-none');
                    }
                    // Apply today filter immediately
                    setTimeout(() => filterFreshLeadsByDate(), 100);
                } else if (selectedFilter === 'range') {
                    if (freshStartDate) {
                        freshStartDate.classList.remove('d-none');
                        freshStartDate.style.display = 'inline-block';
                    }
                    if (freshEndDate) {
                        freshEndDate.classList.remove('d-none');
                        freshEndDate.style.display = 'inline-block';
                    }
                } else {
                    // All Time - clear dates and show all
                    if (freshStartDate) {
                        freshStartDate.value = '';
                        freshStartDate.classList.add('d-none');
                    }
                    if (freshEndDate) {
                        freshEndDate.value = '';
                        freshEndDate.classList.add('d-none');
                    }
                    // Show all rows
                    filterFreshLeadsByDate();
                }
            });
        });
        
        // Add real-time filtering when date inputs change
        if (freshStartDate) {
            freshStartDate.addEventListener('change', filterFreshLeadsByDate);
        }
        if (freshEndDate) {
            freshEndDate.addEventListener('change', filterFreshLeadsByDate);
        }
        
        // Add Enter key support for date inputs
        if (freshStartDate) {
            freshStartDate.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterFreshLeadsByDate();
                }
            });
        }
        if (freshEndDate) {
            freshEndDate.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterFreshLeadsByDate();
                }
            });
        }
        
        // Clear button functionality
        const freshClearBtn = document.getElementById('freshFilterClearBtn');
        if (freshClearBtn) {
            freshClearBtn.addEventListener('click', function() {
                if (freshStartDate) freshStartDate.value = '';
                if (freshEndDate) freshEndDate.value = '';
                filterFreshLeadsByDate();
                
                // Reset dropdown to "All Time"
                freshFilterDropdown.textContent = 'All Time';
            });
        }
        
        // Initialize filtering on page load
        filterFreshLeadsByDate();
        
        // Set default filter to "All Time" on page load
        if (!freshStartDate.value && !freshEndDate.value) {
            freshFilterDropdown.textContent = 'All Time';
        } else {
            // If there are date values from URL parameters, update dropdown text
            if (freshStartDate.value && freshEndDate.value) {
                freshFilterDropdown.textContent = 'Date Range';
            } else if (freshStartDate.value && freshStartDate.value === freshEndDate.value) {
                freshFilterDropdown.textContent = 'Today';
            }
        }
    }
    
    // Initialize date inputs visibility based on current filter type
    function initializeDateInputs() {
        const currentFilterType = '{{ filter_type }}';
        if (currentFilterType === 'range') {
            const freshStartDate = document.getElementById('freshFilterStartDate');
            const freshEndDate = document.getElementById('freshFilterEndDate');
            const lostStartDate = document.getElementById('wonLostLeadsFilterStartDate'); // Updated ID
            const lostEndDate = document.getElementById('wonLostLeadsFilterEndDate'); // Updated ID
            
            if (freshStartDate) {
                freshStartDate.classList.remove('d-none');
                freshStartDate.style.display = 'inline-block';
            }
            if (freshEndDate) {
                freshEndDate.classList.remove('d-none');
                freshEndDate.style.display = 'inline-block';
            }
            if (lostStartDate) {
                lostStartDate.classList.remove('d-none');
                lostStartDate.style.display = 'inline-block';
            }
            if (lostEndDate) {
                lostEndDate.classList.remove('d-none');
                lostEndDate.style.display = 'inline-block';
            }
        }
    }
    
    // Initialize status filter on page load
    function initializeStatusFilter() {
        const currentStatusFilter = '{{ status_filter }}';
        if (currentStatusFilter) {
            const statusToggle = document.querySelector(`[data-status="${currentStatusFilter}"]`);
            if (statusToggle) {
                // Simulate click to activate the correct toggle
                statusToggle.click();
            }
        }
    }
    
    // Initialize on page load
    initializeDateInputs();
    initializeStatusFilter();
    setupFreshLeadsDateFilter();

    // Generic search function
    function setupSearch(inputId, buttonId, clearId, tableId) {
        const searchInput = document.getElementById(inputId);
        const searchButton = document.getElementById(buttonId);
        const clearButton = document.getElementById(clearId);

        if (!searchInput || !searchButton || !clearButton) return;

        function performSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            // Special handling for fresh leads search across all subsections
            if (tableId === 'untouchedLeadsTable') {
                const untouchedRows = document.querySelectorAll('#untouchedLeadsTable tbody tr');
                const calledRows = document.querySelectorAll('#calledLeadsTable tbody tr');
                const followUpRows = document.querySelectorAll('#followUpLeadsTable tbody tr');
                
                // Search across all three tables
                [untouchedRows, calledRows, followUpRows].forEach(rows => {
                    rows.forEach(row => {
                        const searchData = row.getAttribute('data-search') || '';
                        const shouldShow = searchData.includes(searchTerm) || searchTerm === '';
                        row.style.display = shouldShow ? '' : 'none';
                    });
                });
                
                updateFreshLeadsCount();
                return;
            }
            
            const tableRows = document.querySelectorAll(`#${tableId} tbody tr`);

            tableRows.forEach(row => {
                const searchData = row.getAttribute('data-search') || '';
                const shouldShowBySearch = searchData.includes(searchTerm) || searchTerm === '';
                
                // For pending leads, also check category filter
                let shouldShowByCategory = true;
                if (tableId === 'pendingLeadsTable' && activeCategoryFilter) {
                    const categoryCell = row.querySelector('td:nth-child(6)');
                    if (categoryCell) {
                        // Get the badge text which contains the category
                        const badge = categoryCell.querySelector('.badge');
                        const categoryText = badge ? badge.textContent.trim() : categoryCell.textContent.trim();
                        shouldShowByCategory = categoryText === activeCategoryFilter;
                    }
                }
                
                // Check status filter
                let shouldShowByStatus = true;
                if (activeStatusFilter) {
                    const statusCell = row.querySelector('td:nth-child(2)'); // Status column
                    if (statusCell) {
                        const statusText = statusCell.textContent.trim();
                        shouldShowByStatus = statusText === activeStatusFilter;
                    }
                }
                
                if (shouldShowBySearch && shouldShowByCategory && shouldShowByStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update count for pending leads
            if (tableId === 'pendingLeadsTable') {
                updatePendingLeadsCount();
            }
            

        }

        function clearSearch() {
            searchInput.value = '';
            performSearch();
        }

        searchButton.addEventListener('click', performSearch);
        clearButton.addEventListener('click', clearSearch);

        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Real-time search as user types
        searchInput.addEventListener('input', performSearch);
    }

    // Setup search for all tabs
    setupSearch('freshLeadSearchInput', 'freshLeadSearchButton', 'freshLeadClearButton', 'untouchedLeadsTable');
    setupSearch('followupSearchInput', 'followupSearchButton', 'followupClearButton', 'followupTable');
    setupSearch('pendingSearchInput', 'pendingSearchButton', 'pendingClearButton', 'pendingLeadsTable');
    setupSearch('wonLostLeadSearchInput', 'wonLostLeadSearchButton', 'wonLostLeadClearButton', 'wonLostLeadsTable');
    setupSearch('eventLeadSearchInput', 'eventLeadSearchButton', 'eventLeadClearButton', 'eventLeadsTable');
    setupSearch('walkinLeadSearchInput', 'walkinLeadSearchButton', 'walkinLeadClearButton', 'walkinLeadsTable');
    
    // Function to update fresh leads count across all subsections
    function updateFreshLeadsCount() {
        const untouchedRows = document.querySelectorAll('#untouchedLeadsTable tbody tr');
        const calledRows = document.querySelectorAll('#calledLeadsTable tbody tr');
        const followUpRows = document.querySelectorAll('#followUpLeadsTable tbody tr');
        
        let untouchedVisibleCount = 0;
        let calledVisibleCount = 0;
        let followUpVisibleCount = 0;
        
        untouchedRows.forEach(row => {
            if (row.style.display !== 'none') {
                untouchedVisibleCount++;
            }
        });
        
        calledRows.forEach(row => {
            if (row.style.display !== 'none') {
                calledVisibleCount++;
            }
        });
        
        followUpRows.forEach(row => {
            if (row.style.display !== 'none') {
                followUpVisibleCount++;
            }
        });
        
        const totalVisibleCount = untouchedVisibleCount + calledVisibleCount + followUpVisibleCount;
        
        // Update the count display
        const countElement = document.querySelector('#fresh-leads h5');
        if (countElement) {
            const startDate = document.getElementById('freshFilterStartDate') ? document.getElementById('freshFilterStartDate').value : '';
            const endDate = document.getElementById('freshFilterEndDate') ? document.getElementById('freshFilterEndDate').value : '';
            
            if (startDate || endDate) {
                let filterText = '';
                if (startDate && endDate) {
                    filterText = ` - Filtered: ${startDate} to ${endDate}`;
                } else if (startDate) {
                    filterText = ` - From: ${startDate}`;
                } else if (endDate) {
                    filterText = ` - Until: ${endDate}`;
                }
                countElement.textContent = `Fresh Leads (${totalVisibleCount})${filterText}`;
            } else {
                countElement.textContent = `Fresh Leads (${totalVisibleCount})`;
            }
        }
        
        // Update subsection counts
        const untouchedBadge = document.querySelector('#untouched-leads-tab .badge');
        const calledBadge = document.querySelector('#called-leads-tab .badge');
        const followUpBadge = document.querySelector('#follow-up-leads-tab .badge');
        
        if (untouchedBadge) untouchedBadge.textContent = untouchedVisibleCount;
        if (calledBadge) calledBadge.textContent = calledVisibleCount;
        if (followUpBadge) followUpBadge.textContent = followUpVisibleCount;
        
        // Also update the fresh leads stats card (not the today's follow-ups card)
        const freshLeadsStatsCard = document.querySelector('#fresh-leads-stats .fs-4.fw-bold.text-white');
        if (freshLeadsStatsCard) {
            freshLeadsStatsCard.textContent = totalVisibleCount;
        }
    }
    
    // Special handling for won/lost leads search to integrate with status filter
    const wonLostSearchInput = document.getElementById('wonLostLeadSearchInput');
    if (wonLostSearchInput) {
        wonLostSearchInput.addEventListener('input', function() {
            filterTableByStatus();
        });
    }

    // Lead Category Toggle Functionality for Pending Leads
    let activeCategoryFilter = null;
    
    function filterPendingLeadsByCategory() {
        const tableRows = document.querySelectorAll('#pendingLeadsTable tbody tr');
        console.log('Filtering pending leads by category. Active filter:', activeCategoryFilter);
        console.log('Total rows to check:', tableRows.length);
        
        tableRows.forEach((row, index) => {
            const categoryCell = row.querySelector('td:nth-child(6)'); // Category column
            if (categoryCell) {
                // Get the badge text which contains the category
                const badge = categoryCell.querySelector('.badge');
                const categoryText = badge ? badge.textContent.trim() : categoryCell.textContent.trim();
                
                console.log(`Row ${index}: Category text: "${categoryText}", Active filter: "${activeCategoryFilter}"`);
                
                // Handle cases where category is null, empty, or "Not Set"
                // Make comparison case-insensitive
                const categoryTextLower = categoryText.toLowerCase();
                const activeFilterLower = activeCategoryFilter ? activeCategoryFilter.toLowerCase() : '';
                
                if (!activeCategoryFilter || categoryTextLower === activeFilterLower) {
                    row.style.display = '';
                    console.log(`Row ${index}: Showing row`);
                } else {
                    row.style.display = 'none';
                    console.log(`Row ${index}: Hiding row`);
                }
            } else {
                console.log(`Row ${index}: No category cell found`);
            }
        });
        
        updatePendingLeadsCount();
    }
    
    function updatePendingLeadsCount() {
        const tableRows = document.querySelectorAll('#pendingLeadsTable tbody tr');
        let visibleCount = 0;
        
        tableRows.forEach(row => {
            if (row.style.display !== 'none') {
                visibleCount++;
            }
        });
        
        // Update the count display
        const countElement = document.querySelector('#pending h5');
        if (countElement) {
            if (activeCategoryFilter) {
                countElement.textContent = `Pending Leads (${visibleCount}) - Filtered by: ${activeCategoryFilter}`;
            } else {
                countElement.textContent = `Pending Leads (${visibleCount})`;
            }
        }
    }


    let activeStatusFilter = null;
    const statusToggles = document.querySelectorAll('.status-toggle');
    
    statusToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
            const status = this.getAttribute('data-status');
            
            // Toggle active state
            if (this.classList.contains('active')) {
                // Deactivate filter
                this.classList.remove('active');
                this.classList.remove('btn-success', 'btn-danger', 'btn-warning');
                this.classList.add('btn-outline-success', 'btn-outline-danger', 'btn-outline-warning');
                activeStatusFilter = null;
            } else {
                // Deactivate other toggles
                statusToggles.forEach(t => {
                    t.classList.remove('active');
                    t.classList.remove('btn-success', 'btn-danger', 'btn-warning');
                    t.classList.add('btn-outline-success', 'btn-outline-danger', 'btn-outline-warning');
                });
                
                // Activate current toggle
                this.classList.add('active');
                this.classList.remove('btn-outline-success', 'btn-outline-danger', 'btn-outline-warning');
                
                if (status === 'Won') {
                    this.classList.add('btn-success');
                } else if (status === 'Lost') {
                    this.classList.add('btn-danger');
                } else if (status === 'Pending') {
                    this.classList.add('btn-warning');
                }
                
                activeStatusFilter = status;
            }
            
            // Filter the table
            filterTableByStatus();
        });
    });
    
    function filterTableByStatus() {
        const tableRows = document.querySelectorAll('#wonLostLeadsTable tbody tr');
        
        tableRows.forEach(row => {
            let shouldShow = true;
            
            // Check status filter
            if (activeStatusFilter) {
                const statusCell = row.querySelector('td:nth-child(8)'); // Status column
                if (statusCell) {
                    const statusText = statusCell.textContent.trim();
                    shouldShow = statusText === activeStatusFilter;
                }
            }
            
            // Check search filter
            const searchInput = document.getElementById('wonLostLeadSearchInput');
            if (searchInput && searchInput.value.trim()) {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const searchData = row.getAttribute('data-search') || '';
                shouldShow = shouldShow && searchData.includes(searchTerm);
            }
            
            row.style.display = shouldShow ? '' : 'none';
        });
    }
    


    // Hide filter bar for Today's Follow-ups and Pending Leads tabs
    function updateFilterBarVisibility() {
        const filterBar = document.getElementById('psFilterBar');
        const activeTab = document.querySelector('.nav-link.active');
        if (!filterBar || !activeTab) return;
        const tabId = activeTab.getAttribute('id');
        if (tabId === 'fresh-leads-tab' || tabId === 'won-lost-tab') {
            filterBar.style.display = '';
                } else {
            filterBar.style.display = 'none';
                }
    }
    // Initial check
    updateFilterBarVisibility();
    // Listen for tab changes
    document.querySelectorAll('.nav-link').forEach(tab => {
        tab.addEventListener('shown.bs.tab', updateFilterBarVisibility);
    });

    // Activate the correct tab based on the 'tab' query parameter
    function activateTabFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const tab = params.get('tab');
        if (tab) {
            const tabBtn = document.querySelector(`[data-bs-target='#${tab}']`);
            if (tabBtn) {
                new bootstrap.Tab(tabBtn).show();
                }
        }
    }
    activateTabFromQuery();

    // View PS Call History button click
    document.querySelectorAll('.view-ps-call-history-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const uid = this.getAttribute('data-uid');
            fetchPSCallHistory(uid);
        });
    });

    // View Call History button click (for all lead types)
    document.querySelectorAll('.view-call-history-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const uid = this.getAttribute('data-uid');
            fetchPSCallHistory(uid);
        });
    });

    function fetchPSCallHistory(uid) {
        // Clear previous data
        const modal = new bootstrap.Modal(document.getElementById('psCallHistoryModal'));
        document.querySelector('#psCallHistoryTable tbody').innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';
        document.getElementById('psCallHistoryStats').innerHTML = '';
        modal.show();
        fetch(`/ps_call_attempt_history_json/${uid}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderPSCallHistoryTable(data.history, uid);
                } else {
                    document.querySelector('#psCallHistoryTable tbody').innerHTML = '<tr><td colspan="6" class="text-danger">Failed to load call history</td></tr>';
                }
            })
            .catch(() => {
                document.querySelector('#psCallHistoryTable tbody').innerHTML = '<tr><td colspan="6" class="text-danger">Error loading call history</td></tr>';
            });
    }

    function renderPSCallHistoryTable(history, uid) {
        const tbody = document.querySelector('#psCallHistoryTable tbody');
        if (!history.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No call attempts found</td></tr>';
            document.getElementById('psCallHistoryStats').innerHTML = '';
            return;
        }
        // Stats
        const total = history.length;
        const rnr = history.filter(h => h.status && h.status.toLowerCase().includes('rnr')).length;
        const busy = history.filter(h => h.status && h.status.toLowerCase().includes('busy')).length;
        const callback = history.filter(h => h.status && h.status.toLowerCase().includes('call me back')).length;
        const notConnected = history.filter(h => h.status && h.status.toLowerCase().includes('not connected')).length;
        const excludedStatuses = [
            "call not connected",
            "rnr",
            "call me back",
            "busy on another call"
        ];
        const connected = history.filter(h =>
            h.status &&
            !excludedStatuses.includes(h.status.trim().toLowerCase())
        ).length;
        document.getElementById('psCallHistoryStats').innerHTML =
            `<b>Total Calls Made: ${total}</b> |
             RNR Calls: ${rnr} |
             Busy on another Call: ${busy} |
             Call me Back: ${callback} |
             Call not Connected: ${notConnected} |
             Connected Calls: ${connected}`;

        // Render table rows
        tbody.innerHTML = '';
        history.forEach(attempt => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${attempt.uid || ''}</td>
                <td>${attempt.call_no || ''}</td>
                <td>${attempt.attempt || ''}</td>
                <td>${attempt.status || ''}</td>
                <td>${attempt.ps_name || ''}</td>
                <td>${attempt.updated_at ? (attempt.updated_at.split('T')[0] + (attempt.updated_at.includes('T') ? '<br>' + attempt.updated_at.split('T')[1].slice(0,8) : '')) : ''}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Lead Category Toggle Functionality for Pending Leads
    const categoryToggles = document.querySelectorAll('.category-toggle');
    
    console.log('Found category toggles:', categoryToggles.length);
    
    categoryToggles.forEach(toggle => {
        console.log('Adding event listener to toggle:', toggle.getAttribute('data-category'));
        toggle.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            console.log('Category toggle clicked:', category);
            
            // Toggle active state
            if (this.classList.contains('active')) {
                // Deactivate filter
                this.classList.remove('active');
                this.classList.remove('btn-danger', 'btn-warning', 'btn-info');
                this.classList.add('btn-outline-danger', 'btn-outline-warning', 'btn-outline-info');
                activeCategoryFilter = null;
                console.log('Category filter deactivated');
            } else {
                // Deactivate other toggles
                categoryToggles.forEach(t => {
                    t.classList.remove('active');
                    t.classList.remove('btn-danger', 'btn-warning', 'btn-info');
                    t.classList.add('btn-outline-danger', 'btn-outline-warning', 'btn-outline-info');
                });
                
                // Activate current toggle
                this.classList.add('active');
                this.classList.remove('btn-outline-danger', 'btn-outline-warning', 'btn-outline-info');
                
                if (category === 'Hot') {
                    this.classList.add('btn-danger');
                } else if (category === 'Warm') {
                    this.classList.add('btn-warning');
                } else if (category === 'Cold') {
                    this.classList.add('btn-info');
                }
                
                activeCategoryFilter = category;
                console.log('Category filter activated:', activeCategoryFilter);
            }
            
            // Filter the table
            filterPendingLeadsByCategory();
        });
    });

    // Won/Lost Leads Toggle + Filter Bar (AJAX)
    const wonLostToggle = document.getElementById('wonLostToggle');
    const wonLostTabContent = document.getElementById('won-lost');
    const headerEl = document.getElementById('wonLostHeader');
    const wonCountValue = document.getElementById('wonCountValue');
    const lostCountValue = document.getElementById('lostCountValue');

    const filterButtons = [
        document.getElementById('filterMtdBtn'),
        document.getElementById('filterTodayBtn'),
        document.getElementById('filterAllBtn')
    ];
    const fromInput = document.getElementById('filterFromDate');
    const toInput = document.getElementById('filterToDate');
    const applyRangeBtn = document.getElementById('filterRangeApply');

    let currentFilter = 'mtd';

    function setActiveFilter(btn) {
        filterButtons.forEach(b => b && b.classList.remove('active'));
        if (btn) btn.classList.add('active');
    }

    function fetchWonLost() {
        const status = wonLostToggle && wonLostToggle.checked ? 'won' : 'lost';
        const params = new URLSearchParams({ status, filter: currentFilter });
        if (currentFilter === 'range') {
            if (fromInput && fromInput.value) params.append('from_date', fromInput.value);
            if (toInput && toInput.value) params.append('to_date', toInput.value);
        }

        const tableContainer = wonLostTabContent.querySelector('.table-responsive') || wonLostTabContent.querySelector('.text-center');
        if (tableContainer) {
            tableContainer.innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2">Loading...</p></div>';
        }
        if (headerEl) headerEl.textContent = `${status === 'won' ? 'Won' : 'Lost'} Leads (Loading...)`;

        fetch(`/ps_dashboard_leads?${params.toString()}`)
            .then(r => r.json())
            .then(res => {
                if (res.error) throw new Error(res.error);
                const wrapper = document.createElement('div');
                wrapper.innerHTML = res.html;
                const newTable = wrapper.firstElementChild;
                const existing = wonLostTabContent.querySelector('.table-responsive') || wonLostTabContent.querySelector('.text-center');
                if (existing && newTable) existing.replaceWith(newTable);

                const tableEl = wonLostTabContent.querySelector('#wonLostLeadsTable');
                const count = tableEl ? tableEl.querySelectorAll('tbody tr').length : 0;
                if (headerEl) headerEl.textContent = `${status === 'won' ? 'Won' : 'Lost'} Leads (${count})`;
                if (wonCountValue) wonCountValue.textContent = res.won_count ?? '-';
                if (lostCountValue) lostCountValue.textContent = res.lost_count ?? '-';
                const kpiWon = document.getElementById('kpiWonCount');
                const kpiLost = document.getElementById('kpiLostCount');
                if (kpiWon) kpiWon.textContent = res.won_count ?? '0';
                if (kpiLost) kpiLost.textContent = res.lost_count ?? '0';

                const searchInput = document.getElementById('wonLostLeadSearchInput');
                const searchButton = document.getElementById('wonLostLeadSearchButton');
                const clearButton = document.getElementById('wonLostLeadClearButton');
                if (searchInput && searchButton && clearButton) {
                    setupSearch('wonLostLeadSearchInput', 'wonLostLeadSearchButton', 'wonLostLeadClearButton', 'wonLostLeadsTable');
                }
            })
            .catch(err => {
                console.error('Error fetching leads:', err);
                const container = wonLostTabContent.querySelector('.table-responsive') || wonLostTabContent.querySelector('.text-center');
                if (container) container.innerHTML = '<div class="alert alert-danger">Error loading leads. Please try again.</div>';
            });
    }

    if (wonLostToggle && wonLostTabContent) {
        wonLostToggle.addEventListener('change', fetchWonLost);

        filterButtons.forEach(btn => {
            if (!btn) return;
            btn.addEventListener('click', () => {
                currentFilter = btn.dataset.filter;
                setActiveFilter(btn);
                fetchWonLost();
            });
        });

        if (applyRangeBtn) {
            applyRangeBtn.addEventListener('click', () => {
                currentFilter = 'range';
                setActiveFilter(null);
                fetchWonLost();
            });
        }

        // Initial load: ensure MTD is selected and fetch to populate counts
        const currentStatus = window.location.search.includes('status=won') ? 'won' : 'lost';
        if (wonLostToggle) wonLostToggle.checked = currentStatus === 'won';
        setActiveFilter(document.getElementById('filterMtdBtn'));
        fetchWonLost();
    }

    // Handle tab parameter from URL to set active tab
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    const categoryFilterParam = urlParams.get('category_filter');
    
    if (tabParam) {
        // Remove active class from all tabs
        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.classList.remove('active');
            tab.setAttribute('aria-selected', 'false');
        });
        
        // Remove active class from all tab panes
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active', 'show');
        });
        
        // Add active class to the specified tab
        const targetTab = document.getElementById(tabParam + '-tab');
        const targetPane = document.getElementById(tabParam);
        
        if (targetTab && targetPane) {
            targetTab.classList.add('active');
            targetTab.setAttribute('aria-selected', 'true');
            targetPane.classList.add('active', 'show');
        }
        
        // Handle category filter for pending leads tab
        if (tabParam === 'pending' && categoryFilterParam) {
            // Find the category toggle button and activate it
            const categoryToggles = document.querySelectorAll('.category-toggle');
            categoryToggles.forEach(toggle => {
                if (toggle.getAttribute('data-category') === categoryFilterParam) {
                    // Deactivate other toggles first
                    categoryToggles.forEach(t => {
                        t.classList.remove('active');
                        t.classList.remove('btn-danger', 'btn-warning', 'btn-info');
                        t.classList.add('btn-outline-danger', 'btn-outline-warning', 'btn-outline-info');
                    });
                    
                    // Activate the matching toggle
                    toggle.classList.add('active');
                    toggle.classList.remove('btn-outline-danger', 'btn-outline-warning', 'btn-outline-info');
                    
                    if (categoryFilterParam === 'Hot') {
                        toggle.classList.add('btn-danger');
                    } else if (categoryFilterParam === 'Warm') {
                        toggle.classList.add('btn-warning');
                    } else if (categoryFilterParam === 'Cold') {
                        toggle.classList.add('btn-info');
                    }
                    
                    // Set the active filter and apply it
                    activeCategoryFilter = categoryFilterParam;
                    filterPendingLeadsByCategory();
                }
            });
        }
    }


});
</script>



{% endblock %}