<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Ather CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --airbnb-red: #FF385C;
            --airbnb-red-dark: #E31C5F;
            --airbnb-gray-100: #F7F7F7;
            --airbnb-gray-200: #EBEBEB;
            --airbnb-gray-300: #DDDDDD;
            --airbnb-gray-400: #B0B0B0;
            --airbnb-gray-500: #717171;
            --airbnb-gray-600: #484848;
            --airbnb-gray-700: #222222;
            --airbnb-white: #FFFFFF;
            --airbnb-green: #00A699;
            --airbnb-blue: #007A87;
            --airbnb-yellow: #FFB400;
            --airbnb-border-radius: 12px;
            --airbnb-border-radius-lg: 16px;
            --airbnb-shadow: 0 1px 2px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.05);
            --airbnb-shadow-hover: 0 2px 4px rgba(0, 0, 0, 0.08), 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--airbnb-white);
            color: var(--airbnb-gray-700);
        }

        .navbar {
            background-color: var(--airbnb-white) !important;
            border-bottom: 1px solid var(--airbnb-gray-200);
            box-shadow: var(--airbnb-shadow);
        }

        .analytics-container {
            background: var(--airbnb-white);
            border-radius: var(--airbnb-border-radius-lg);
            box-shadow: var(--airbnb-shadow);
            margin: 2rem;
            padding: 2rem;
            border: 1px solid var(--airbnb-gray-200);
        }

        .kpi-card {
            background: linear-gradient(135deg, var(--airbnb-red) 0%, var(--airbnb-red-dark) 100%);
            color: var(--airbnb-white);
            border-radius: var(--airbnb-border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--airbnb-shadow);
            transition: all 0.3s ease;
            border: none;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--airbnb-shadow-hover);
        }

        .kpi-card.success {
            background: linear-gradient(135deg, var(--airbnb-green) 0%, #00B3A6 100%);
        }

        .kpi-card.warning {
            background: linear-gradient(135deg, var(--airbnb-yellow) 0%, #E6A200 100%);
        }

        .kpi-card.info {
            background: linear-gradient(135deg, var(--airbnb-blue) 0%, #006B75 100%);
        }

        .kpi-value {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .kpi-label {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .chart-container {
            background: var(--airbnb-white);
            border-radius: var(--airbnb-border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--airbnb-shadow);
            border: 1px solid var(--airbnb-gray-200);
            height: 420px;
            min-width: 520px;
            max-width: 100%;
            overflow-x: auto;
        }

        .table-container {
            background: var(--airbnb-white);
            border-radius: var(--airbnb-border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--airbnb-shadow);
            border: 1px solid var(--airbnb-gray-200);
        }

        .table {
            color: var(--airbnb-gray-700);
        }

        .table thead th {
            background: var(--airbnb-gray-100);
            color: var(--airbnb-gray-700);
            border: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        .table tbody td {
            background: var(--airbnb-white);
            border-color: var(--airbnb-gray-200);
            color: var(--airbnb-gray-700);
        }

        .table-hover tbody tr:hover {
            background: var(--airbnb-gray-100);
        }

        .funnel-step {
            background: linear-gradient(135deg, var(--airbnb-red) 0%, var(--airbnb-red-dark) 100%);
            color: var(--airbnb-white);
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: var(--airbnb-border-radius);
            position: relative;
            font-weight: 500;
        }

        .funnel-step:nth-child(2) {
            background: linear-gradient(135deg, var(--airbnb-green) 0%, #00B3A6 100%);
        }

        .funnel-step:nth-child(3) {
            background: linear-gradient(135deg, var(--airbnb-blue) 0%, #006B75 100%);
        }

        .funnel-step:nth-child(4) {
            background: linear-gradient(135deg, var(--airbnb-yellow) 0%, #E6A200 100%);
        }

        .activity-item {
            border-left: 4px solid var(--airbnb-red);
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--airbnb-gray-100);
            border-radius: 0 var(--airbnb-border-radius) var(--airbnb-border-radius) 0;
            transition: all 0.2s ease;
        }

        .activity-item:hover {
            background: var(--airbnb-gray-200);
        }

        .filter-buttons {
            margin-bottom: 2rem;
        }

        .filter-btn {
            margin-right: 0.75rem;
            margin-bottom: 0.75rem;
            border: 1px solid var(--airbnb-gray-300);
            color: var(--airbnb-gray-700);
            background: var(--airbnb-white);
            border-radius: var(--airbnb-border-radius);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: var(--airbnb-gray-100);
            border-color: var(--airbnb-red);
            color: var(--airbnb-red);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--airbnb-red) 0%, var(--airbnb-red-dark) 100%);
            border: none;
            border-radius: var(--airbnb-border-radius);
            font-weight: 500;
        }

        .btn-outline-primary {
            border: 1px solid var(--airbnb-gray-300);
            color: var(--airbnb-gray-700);
            background: var(--airbnb-white);
            border-radius: var(--airbnb-border-radius);
        }

        .btn-outline-primary:hover {
            background: var(--airbnb-gray-100);
            border-color: var(--airbnb-red);
            color: var(--airbnb-red);
        }

        .badge {
            border-radius: 20px;
            font-weight: 500;
            padding: 0.4rem 0.8rem;
        }

        .progress {
            background-color: var(--airbnb-gray-200);
            border-radius: 10px;
        }

        .progress-bar {
            border-radius: 10px;
        }

        .branch-link {
            color: var(--airbnb-red) !important;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .branch-link:hover {
            color: var(--airbnb-red-dark) !important;
            text-decoration: underline;
        }

        .avatar-sm {
            width: 35px;
            height: 35px;
            font-size: 0.875rem;
            background: var(--airbnb-red);
            color: var(--airbnb-white);
        }

        .modal-content {
            background: var(--airbnb-white);
            border: 1px solid var(--airbnb-gray-200);
            border-radius: var(--airbnb-border-radius-lg);
            color: var(--airbnb-gray-700);
        }

        .modal-header {
            border-bottom: 1px solid var(--airbnb-gray-200);
        }

        .modal-footer {
            border-top: 1px solid var(--airbnb-gray-200);
        }

        @media (max-width: 768px) {
            .analytics-container {
                margin: 1rem;
                padding: 1rem;
            }
        }

        /* Source Analysis Table Header Styling */
        #source-analysis-table th, #source-analysis-table td {
            border: 2px solid #e0e0e0 !important;
            text-align: center;
            vertical-align: middle;
        }
        #source-analysis-table th.pending-header, #source-analysis-table td.pending-cell {
            background: #fffbe6 !important;
            color: #b8860b;
            font-weight: 600;
        }
        #source-analysis-table th.closedlost-header, #source-analysis-table td.closedlost-cell {
            background: #ffeaea !important;
            color: #c0392b;
            font-weight: 600;
        }
        #source-analysis-table th.salespipeline-header, #source-analysis-table td.salespipeline-cell {
            background: #eaffea !important;
            color: #218838;
            font-weight: 700;
            transition: box-shadow 0.3s, transform 0.3s;
        }
        #source-analysis-table td.salespipeline-cell:hover {
            box-shadow: 0 0 10px 2px #b6fcb6;
            transform: scale(1.08);
            background: linear-gradient(90deg, #eaffea 60%, #b6fcb6 100%);
            cursor: pointer;
        }
        #source-analysis-table th {
            font-size: 1rem;
            background: #f8f9fa;
        }
        #source-analysis-table tr.total-row td {
            background: #f7f7f7;
            font-weight: bold;
        }

        /* Real-time animated effect for Sales Pipeline */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(33, 136, 56, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(33, 136, 56, 0); }
            100% { box-shadow: 0 0 0 0 rgba(33, 136, 56, 0.4); }
        }
        #source-analysis-table td.salespipeline-cell {
            position: relative;
            animation: pulse-green 1.5s infinite;
            z-index: 1;
        }
        #source-analysis-table td.salespipeline-cell:hover {
            box-shadow: 0 0 20px 4px #b6fcb6, 0 0 0 8px #eaffea;
            transform: scale(1.12) rotate(-2deg);
            background: linear-gradient(90deg, #eaffea 60%, #b6fcb6 100%);
            cursor: pointer;
            animation: none;
        }
        /* Performance Table Theming and Animation */
        #source-performance-table th.calls-allocated, #source-performance-table td.calls-allocated {
            background: #e3f2fd;
            color: #1976d2;
        }
        #source-performance-table th.calls-attempted, #source-performance-table td.calls-attempted {
            background: #e1f5fe;
            color: #0288d1;
        }
        #source-performance-table th.calls-connected, #source-performance-table td.calls-connected {
            background: #e0f7fa;
            color: #0097a7;
        }
        #source-performance-table th.pending-perf, #source-performance-table td.pending-perf {
            background: #fffbe6;
            color: #b8860b;
        }
        #source-performance-table th.closedlost-perf, #source-performance-table td.closedlost-perf {
            background: #ffeaea;
            color: #c0392b;
        }
        #source-performance-table th.salespipeline-perf, #source-performance-table td.salespipeline-perf {
            background: #eaffea;
            color: #218838;
            font-weight: 700;
            position: relative;
            transition: box-shadow 0.3s, transform 0.3s;
        }
        #source-performance-table td.salespipeline-perf:hover {
            box-shadow: 0 0 20px 4px #b6fcb6, 0 0 0 8px #eaffea;
            transform: scale(1.12) rotate(-2deg);
            background: linear-gradient(90deg, #eaffea 60%, #b6fcb6 100%);
            cursor: pointer;
        }
        /* Animated progress bar effect on hover for all % cells */
        #source-performance-table td[data-pct]:hover::after {
            content: '';
            display: block;
            position: absolute;
            left: 0; top: 0; height: 100%;
            background: rgba(33,136,56,0.08);
            width: attr(data-pct '%');
            z-index: 0;
            border-radius: 8px;
            animation: progress-bar-grow 0.7s ease-out;
        }
        @keyframes progress-bar-grow {
            from { width: 0; }
            to { width: 100%; }
        }
        #source-performance-table td {
            position: relative;
            overflow: hidden;
        }
        /* Compact total row */
        #source-analysis-table tr.total-row td {
            background: #f7f7f7;
            font-weight: bold;
            font-size: 0.95rem;
            padding-top: 0.3rem;
            padding-bottom: 0.3rem;
        }
        /* Combined cell styling for number + percent */
        .metric-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 500;
            position: relative;
            min-width: 70px;
        }
        .metric-number {
            font-size: 1.1em;
            font-weight: 600;
        }
        .metric-percent {
            font-size: 0.95em;
            font-weight: 400;
            opacity: 0.85;
            margin-top: 2px;
            border-radius: 8px;
            padding: 0 6px;
            display: inline-block;
            transition: background 0.3s;
        }
        /* Theming for each metric type */
        .calls-allocated { background: #e3f2fd; color: #1976d2; }
        .calls-attempted { background: #e1f5fe; color: #0288d1; }
        .calls-connected { background: #e0f7fa; color: #0097a7; }
        .pending-cell, .pending-perf { background: #fffbe6; color: #b8860b; }
        .closedlost-cell, .closedlost-perf { background: #ffeaea; color: #c0392b; }
        .salespipeline-cell, .salespipeline-perf {
            background: #eaffea;
            color: #218838;
            font-weight: 700;
            position: relative;
            transition: box-shadow 0.3s, transform 0.3s;
            animation: pulse-green 1.5s infinite;
        }
        .salespipeline-cell:hover, .salespipeline-perf:hover {
            box-shadow: 0 0 20px 4px #b6fcb6, 0 0 0 8px #eaffea;
            transform: scale(1.12) rotate(-2deg);
            background: linear-gradient(90deg, #eaffea 60%, #b6fcb6 100%);
            cursor: pointer;
            animation: none;
        }
        /* Animated progress bar effect on hover for all % cells */
        .metric-cell[data-pct]:hover .metric-percent::after {
            content: '';
            display: block;
            position: absolute;
            left: 0; top: 50%; height: 60%;
            background: rgba(33,136,56,0.08);
            width: attr(data-pct '%');
            z-index: 0;
            border-radius: 8px;
            animation: progress-bar-grow 0.7s ease-out;
            transform: translateY(-50%);
        }
        @keyframes progress-bar-grow {
            from { width: 0; }
            to { width: 100%; }
        }
        #source-analysis-table th, #source-analysis-table td {
            border: 2px solid #e0e0e0 !important;
            text-align: center;
            vertical-align: middle;
            font-size: 1rem;
        }
        #source-analysis-table th {
            font-size: 1rem;
            background: #f8f9fa;
        }
        /* Restore classic table cell layout for numbers and percentages */
        .metric-number-cell {
            font-size: 1.1em;
            font-weight: 600;
            padding-bottom: 0;
            border-bottom: none !important;
        }
        .metric-percent-cell {
            font-size: 0.95em;
            font-weight: 400;
            opacity: 0.85;
            border-top: none !important;
            padding-top: 0;
            border-radius: 8px;
            transition: background 0.3s;
        }
        /* Theming for each metric type */
        .calls-allocated { background: #e3f2fd; color: #1976d2; }
        .calls-attempted { background: #e1f5fe; color: #0288d1; }
        .calls-connected { background: #e0f7fa; color: #0097a7; }
        .pending-cell, .pending-perf { background: #fffbe6; color: #b8860b; }
        .closedlost-cell, .closedlost-perf { background: #ffeaea; color: #c0392b; }
        .salespipeline-cell, .salespipeline-perf {
            background: #eaffea;
            color: #218838;
            font-weight: 700;
            position: relative;
            transition: box-shadow 0.3s, transform 0.3s;
            animation: pulse-green 1.5s infinite;
        }
        .salespipeline-cell:hover, .salespipeline-perf:hover {
            box-shadow: 0 0 20px 4px #b6fcb6, 0 0 0 8px #eaffea;
            transform: scale(1.12) rotate(-2deg);
            background: linear-gradient(90deg, #eaffea 60%, #b6fcb6 100%);
            cursor: pointer;
            animation: none;
        }
        /* Animated progress bar effect on hover for all % cells */
        .metric-percent-cell[data-pct]:hover::after {
            content: '';
            display: block;
            position: absolute;
            left: 0; top: 50%; height: 60%;
            background: rgba(33,136,56,0.08);
            width: attr(data-pct '%');
            z-index: 0;
            border-radius: 8px;
            animation: progress-bar-grow 0.7s ease-out;
            transform: translateY(-50%);
        }
        @keyframes progress-bar-grow {
            from { width: 0; }
            to { width: 100%; }
        }
        #source-analysis-table th, #source-analysis-table td {
            border: 2px solid #e0e0e0 !important;
            text-align: center;
            vertical-align: middle;
            font-size: 1rem;
        }
        #source-analysis-table th {
            font-size: 1rem;
            background: #f8f9fa;
        }
        #source-analysis-table tr.total-row td {
            background: #f7f7f7;
            font-weight: bold;
            font-size: 0.95rem;
            padding-top: 0.3rem;
            padding-bottom: 0.3rem;
        }
        /* Subcolumn header styling */
        .sub-header {
            font-size: 0.95em;
            font-weight: 500;
            color: #888;
            background: #f4f4f4;
            border-top: none !important;
            border-bottom: 2px solid #e0e0e0 !important;
        }
        .calls-allocated { background: #e3f2fd; color: #1976d2; }
        .calls-attempted { background: #e1f5fe; color: #0288d1; }
        .calls-connected { background: #e0f7fa; color: #0097a7; }
        .pending-cell, .pending-perf { background: #fffbe6; color: #b8860b; }
        .closedlost-cell, .closedlost-perf { background: #ffeaea; color: #c0392b; }
        .salespipeline-cell, .salespipeline-perf {
            background: #eaffea;
            color: #218838;
            font-weight: 700;
            position: relative;
            transition: box-shadow 0.3s, transform 0.3s;
            animation: pulse-green 1.5s infinite;
        }
        .salespipeline-cell:hover, .salespipeline-perf:hover {
            box-shadow: 0 0 20px 4px #b6fcb6, 0 0 0 8px #eaffea;
            transform: scale(1.12) rotate(-2deg);
            background: linear-gradient(90deg, #eaffea 60%, #b6fcb6 100%);
            cursor: pointer;
            animation: none;
        }
        .metric-percent-cell[data-pct]:hover::after {
            content: '';
            display: block;
            position: absolute;
            left: 0; top: 50%; height: 60%;
            background: rgba(33,136,56,0.08);
            width: attr(data-pct '%');
            z-index: 0;
            border-radius: 8px;
            animation: progress-bar-grow 0.7s ease-out;
            transform: translateY(-50%);
        }
        @keyframes progress-bar-grow {
            from { width: 0; }
            to { width: 100%; }
        }
        #source-analysis-table th, #source-analysis-table td {
            border: 2px solid #e0e0e0 !important;
            text-align: center;
            vertical-align: middle;
            font-size: 1rem;
        }
        #source-analysis-table th {
            font-size: 1rem;
            background: #f8f9fa;
        }
        #source-analysis-table tr.total-row td {
            background: #f7f7f7;
            font-weight: bold;
            font-size: 0.95rem;
            padding-top: 0.3rem;
            padding-bottom: 0.3rem;
        }

        /* CRE Analysis Table Styling */
        #cre-analysis-table th, #cre-analysis-table td {
            border: 2px solid #e0e0e0 !important;
            text-align: center;
            vertical-align: middle;
            padding: 0.5rem;
        }
        #cre-analysis-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        #cre-analysis-table tr.total-row td {
            background: #f7f7f7;
            font-weight: bold;
        }
        #cre-analysis-table td:first-child {
            text-align: left;
            font-weight: 600;
        }
        #cre-analysis-table th[colspan="3"] {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        /* Header styling for new columns */
        #cre-analysis-table tr:first-child th:nth-child(20) {
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
        }
        
        #cre-analysis-table tr:first-child th:nth-child(21),
        #cre-analysis-table tr:first-child th:nth-child(22) {
            background: #fff8e1;
            color: #f57f17;
        }
        
        #cre-analysis-table tr:first-child th:nth-child(23) {
            background: #ffebee;
            color: #c62828;
        }
        
        #cre-analysis-table tr:first-child th:nth-child(24),
        #cre-analysis-table tr:first-child th:nth-child(25),
        #cre-analysis-table tr:first-child th:nth-child(26),
        #cre-analysis-table tr:first-child th:nth-child(27) {
            background: #e0f2f1;
            color: #00695c;
        }
        /* Highlight specific columns */
        #cre-analysis-table td:nth-child(2),
        #cre-analysis-table td:nth-child(3),
        #cre-analysis-table td:nth-child(4) {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        #cre-analysis-table td:nth-child(5),
        #cre-analysis-table td:nth-child(6),
        #cre-analysis-table td:nth-child(7),
        #cre-analysis-table td:nth-child(8) {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        #cre-analysis-table td:nth-child(9),
        #cre-analysis-table td:nth-child(10),
        #cre-analysis-table td:nth-child(11) {
            background-color: #fff8e1;
            color: #f57f17;
        }
        #cre-analysis-table td:nth-child(12),
        #cre-analysis-table td:nth-child(13),
        #cre-analysis-table td:nth-child(14),
        #cre-analysis-table td:nth-child(15),
        #cre-analysis-table td:nth-child(16) {
            background-color: #ffebee;
            color: #c62828;
        }
        
        /* Additional columns styling */
        #cre-analysis-table td:nth-child(17),
        #cre-analysis-table td:nth-child(18),
        #cre-analysis-table td:nth-child(19) {
            background-color: #ffebee;
            color: #c62828;
        }
        
        #cre-analysis-table td:nth-child(20),
        #cre-analysis-table td:nth-child(21) {
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: bold;
        }
        
        #cre-analysis-table td:nth-child(22) {
            background-color: #fff8e1;
            color: #f57f17;
        }
        
        #cre-analysis-table td:nth-child(23) {
            background-color: #ffebee;
            color: #c62828;
            font-weight: bold;
        }
        
        /* Percentage columns */
        #cre-analysis-table td:nth-child(24),
        #cre-analysis-table td:nth-child(25),
        #cre-analysis-table td:nth-child(26),
        #cre-analysis-table td:nth-child(27) {
            background-color: #e0f2f1;
            color: #00695c;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('admin_dashboard') }}" style="color: var(--airbnb-red); font-weight: 700;">
                <i class="fas fa-bolt" style="color: var(--airbnb-red);"></i> Ather CRM
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" style="color: var(--airbnb-gray-600);">
                    <i class="fas fa-user"></i> Welcome, {{ session.username }}
                </span>
                <a class="btn btn-outline-primary btn-sm" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="analytics-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 style="color: var(--airbnb-gray-700); font-weight: 700;">
                    <i class="fas fa-chart-line" style="color: var(--airbnb-red);"></i> Analytics Dashboard
                </h1>
                <p style="color: var(--airbnb-gray-500); margin-bottom: 0;">Comprehensive insights and performance metrics</p>
            </div>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>

        <!-- Restore the old Time Period filter buttons -->
        <div class="filter-buttons">
            <h5 style="color: var(--airbnb-gray-700); font-weight: 600; margin-bottom: 1rem;">Time Period:</h5>
            <a href="{{ url_for('analytics', period='7') }}" class="btn filter-btn">Last 7 Days</a>
            <a href="{{ url_for('analytics', period='30') }}" class="btn filter-btn">Last 30 Days</a>
            <a href="{{ url_for('analytics', period='90') }}" class="btn filter-btn">Last 90 Days</a>
            <a href="{{ url_for('analytics', period='365') }}" class="btn filter-btn">Last Year</a>
            <a href="{{ url_for('analytics', period='all') }}" class="btn filter-btn">All Time</a>
        </div>

        <!-- KPI Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-value">{{ analytics.total_leads }}</div>
                    <div class="kpi-label">
                        <i class="fas fa-users"></i> Total Leads
                        <span class="badge bg-light text-dark ms-2">+{{ analytics.leads_growth }}%</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card success">
                    <div class="kpi-value">{{ analytics.conversion_rate }}%</div>
                    <div class="kpi-label">
                        <i class="fas fa-trophy"></i> Conversion Rate
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card warning">
                    <div class="kpi-value">{{ analytics.avg_response_time }}</div>
                    <div class="kpi-label">
                        <i class="fas fa-clock"></i> Avg Response Time
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card info">
                    <div class="kpi-value">{{ analytics.total_cres }}</div>
                    <div class="kpi-label">
                        <i class="fas fa-user-tie"></i> Active CREs
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign/Platform/Lead Count Table -->
        <div class="table-container mb-4">
            <h5 style="color: var(--airbnb-red); font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-bullhorn" style="color: var(--airbnb-red);"></i> Campaign & Platform Lead Counts
            </h5>
            <form class="d-flex align-items-center mb-3" method="get" action="{{ url_for('analytics') }}">
                <label for="campaign_start_date" class="me-2 mb-0">From:</label>
                <input type="date" id="campaign_start_date" name="start_date" class="form-control form-control-sm me-2" value="{{ request.args.get('start_date', '') }}">
                <label for="campaign_end_date" class="me-2 mb-0">To:</label>
                <input type="date" id="campaign_end_date" name="end_date" class="form-control form-control-sm me-2" value="{{ request.args.get('end_date', '') }}">
                <button type="submit" class="btn btn-primary btn-sm">Apply</button>
                <a href="{{ url_for('analytics') }}" class="btn btn-outline-secondary btn-sm ms-2">Reset</a>
            </form>
            <div class="mb-2" style="color: var(--airbnb-gray-600); font-size: 1rem;">
                <strong>Total Leads in Database:</strong> {{ analytics.all_leads_count }}
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Campaign Name</th>
                            <th>Platform (Source)</th>
                            <th>Total Leads</th>
                            <th>Today's Leads</th>
                            <th>Lost</th>
                            <th>Pending</th>
                            <th>Won</th>
                            <th>Conversion Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if analytics.campaign_platform_counts and analytics.campaign_platform_counts|length > 0 %}
                            {% for row in analytics.campaign_platform_counts %}
                                {% set campaign_clean = (row.campaign or '').strip().lower() %}
                                {% if campaign_clean and campaign_clean != 'none' %}
                                    <tr>
                                        <td>{{ row.campaign }}</td>
                                        <td>{{ row.platform }}</td>
                                        <td>
                                            <strong>{{ row.total_leads }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-info text-dark">{{ row.todays_leads }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-danger">{{ row.lost }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-warning text-dark">{{ row.pending }}</span>
                                        </td>
                                        <td>
                                            <span class="badge" style="background-color:#00b894;color:white;">{{ row.won }}</span>
                                        </td>
                                        <td>
                                            {% if row.total_leads > 0 %}
                                                <span style="font-weight:600;">{{ row.conversion_rate }}%</span>
                                                <span style="font-size:11px;opacity:0.7;">({{ row.won }}/{{ row.total_leads }})</span>
                                            {% else %}
                                                0%
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="8" class="text-center">No campaign/platform data available.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5 style="color: var(--airbnb-gray-700); font-weight: 600; margin-bottom: 1rem;">
                        <i class="fas fa-pie-chart" style="color: var(--airbnb-red);"></i> Lead Source
                    </h5>
                    <canvas id="sourceChart" width="600" height="350"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5 style="color: var(--airbnb-gray-700); font-weight: 600; margin-bottom: 1rem;">
                        <i class="fas fa-line-chart" style="color: var(--airbnb-red);"></i> Lead Trends
                    </h5>
                    <canvas id="trendChart" width="600" height="350"></canvas>
                </div>
            </div>
        </div>

        <!-- Performance Tables -->
        <div class="row">
            <div class="col-md-8">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 style="color: var(--airbnb-gray-700); font-weight: 600; margin-bottom: 0;">
                            <i class="fas fa-star" style="color: var(--airbnb-yellow);"></i> Top Performing CREs
                        </h5>
                        <form class="d-flex align-items-center" method="get" action="{{ url_for('analytics') }}">
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="window.location.href='{{ url_for('analytics', period='1') }}'">Reset</button>
                            <label for="start_date" class="me-2 mb-0">From:</label>
                            <input type="date" id="start_date" name="start_date" class="form-control form-control-sm me-2" value="{{ request.args.get('start_date', '') }}">
                            <label for="end_date" class="me-2 mb-0">To:</label>
                            <input type="date" id="end_date" name="end_date" class="form-control form-control-sm me-2" value="{{ request.args.get('end_date', '') }}">
                            <button type="submit" class="btn btn-primary btn-sm">Apply</button>
                        </form>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>CRE Name</th>
                                    <th>Total Leads</th>
                                    <th>Hot</th>
                                    <th>Warm</th>
                                    <th>Cold</th>
                                    <th>Won</th>
                                    <th>Lost</th>
                                    <th>Conversion Rate</th>
                                    <th>Avg Calls</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cre in analytics.top_cres %}
                                <tr>
                                    <td><strong>{{ cre.name }}</strong></td>
                                    <td>{{ cre.total_leads }}</td>
                                    <td><span class="badge bg-danger">{{ cre.hot }}</span></td>
                                    <td><span class="badge bg-warning text-dark">{{ cre.warm }}</span></td>
                                    <td><span class="badge bg-info text-dark">{{ cre.cold }}</span></td>
                                    <td><span class="badge" style="background: var(--airbnb-green);">{{ cre.won_leads }}</span></td>
                                    <td><span class="badge bg-secondary">{{ cre.lost_leads }}</span></td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar" style="width: {{ cre.conversion_rate }}%; background: var(--airbnb-red);">
                                                {{ cre.conversion_rate }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ cre.avg_calls }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="table-container">
                    <h5 style="color: var(--airbnb-gray-700); font-weight: 600; margin-bottom: 1rem;">
                        <i class="fas fa-funnel-dollar" style="color: var(--airbnb-green);"></i> Lead Funnel
                    </h5>
                    <div class="funnel-step">
                        <strong>Total Leads</strong>
                        <div>{{ analytics.funnel.total }} (100%)</div>
                    </div>
                    <div class="funnel-step">
                        <strong>Assigned to CRE</strong>
                        <div>{{ analytics.funnel.assigned_cre }} ({{ analytics.funnel.assigned_cre_percent }}%)</div>
                    </div>
                    <div class="funnel-step">
                        <strong>First Call Made</strong>
                        <div>{{ analytics.funnel.first_call }} ({{ analytics.funnel.first_call_percent }}%)</div>
                    </div>
                    <div class="funnel-step">
                        <strong>Assigned to PS</strong>
                        <div>{{ analytics.funnel.assigned_ps }} ({{ analytics.funnel.assigned_ps_percent }}%)</div>
                    </div>
                    <div class="funnel-step">
                        <strong>Won</strong>
                        <div>{{ analytics.funnel.won }} ({{ analytics.funnel.won_percent }}%)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Branch Performance -->
        <div class="table-container">
            <h5 style="color: var(--airbnb-gray-700); font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-building" style="color: var(--airbnb-blue);"></i> Branch Performance
            </h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Branch</th>
                            <th>PS Count</th>
                            <th>Assigned Leads</th>
                            <th>Won Leads</th>
                            <th>Success Rate</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for branch in analytics.branch_performance %}
                        <tr>
                            <td>
                                <a href="#" class="branch-link"
                                   data-branch="{{ branch.name }}"
                                   onclick="showBranchDetails('{{ branch.name }}')">
                                    <i class="fas fa-building me-2"></i>{{ branch.name }}
                                </a>
                            </td>
                            <td><span class="badge" style="background: var(--airbnb-red);">{{ branch.ps_count }}</span></td>
                            <td>{{ branch.assigned_leads }}</td>
                            <td><span class="badge" style="background: var(--airbnb-green);">{{ branch.won_leads }}</span></td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar" style="width: {{ branch.success_rate }}%; background: var(--airbnb-blue);">
                                        {{ branch.success_rate }}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Additional Analytics -->
        <div class="row">
            <div class="col-md-6">
                <div class="table-container">
                    <h5 style="color: var(--airbnb-gray-700); font-weight: 600; margin-bottom: 1rem;">
                        <i class="fas fa-tags" style="color: var(--airbnb-yellow);"></i> Lead Analysis
                    </h5>
                    {% for category in analytics.lead_categories %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: var(--airbnb-gray-100); border-radius: var(--airbnb-border-radius);">
                        <span style="font-weight: 500;">{{ category.name }}</span>
                        <div>
                            {% if category.name == 'Won' %}
                                <span class="badge" style="background: var(--airbnb-green); margin-right: 0.5rem;">{{ category.count }}</span>
                            {% elif category.name == 'Lost' %}
                                <span class="badge" style="background: var(--airbnb-red); margin-right: 0.5rem;">{{ category.count }}</span>
                            {% else %}
                                <span class="badge" style="background: var(--airbnb-gray-500); margin-right: 0.5rem;">{{ category.count }}</span>
                            {% endif %}
                            <span style="color: var(--airbnb-gray-500);">{{ category.percentage }}%</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-container">
                    <h5 style="color: var(--airbnb-gray-700); font-weight: 600; margin-bottom: 1rem;">
                        <i class="fas fa-motorcycle" style="color: var(--airbnb-red);"></i> Model Interest
                    </h5>
                    {% for model in analytics.model_interest %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: var(--airbnb-gray-100); border-radius: var(--airbnb-border-radius);">
                        <span class="small" style="font-weight: 500;">{{ model.name }}</span>
                        <div>
                            <span class="badge" style="background: var(--airbnb-red); margin-right: 0.5rem;">{{ model.count }}</span>
                            <span style="color: var(--airbnb-gray-500);">{{ model.percentage }}%</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="table-container">
            <h5 style="color: var(--airbnb-gray-700); font-weight: 600; margin-bottom: 1rem;">
                <i class="fas fa-history" style="color: var(--airbnb-gray-500);"></i> Recent Activities
            </h5>
            {% for activity in analytics.recent_activities %}
            <div class="activity-item">
                <h6 class="mb-1" style="color: var(--airbnb-gray-700); font-weight: 600;">{{ activity.title }}</h6>
                <p class="mb-1" style="color: var(--airbnb-gray-600);">{{ activity.description }}</p>
                <small style="color: var(--airbnb-gray-500);">{{ activity.time }}</small>
            </div>
            {% endfor %}
        </div>

        <!-- Source Analysis Table with subcolumns for Total and % -->
        <div class="table-container mt-5" id="source-analysis-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 style="color: var(--airbnb-blue); font-weight: 600; margin-bottom: 0;">
                    <i class="fas fa-chart-bar" style="color: var(--airbnb-blue);"></i> Source Analysis
                </h5>
                <form class="d-flex align-items-center" id="source-analysis-date-form" onsubmit="return false;">
                    <label for="sa_start_date" class="me-2 mb-0">From:</label>
                    <input type="date" id="sa_start_date" name="start_date" class="form-control form-control-sm me-2">
                    <label for="sa_end_date" class="me-2 mb-0">To:</label>
                    <input type="date" id="sa_end_date" name="end_date" class="form-control form-control-sm me-2">
                    <button type="button" class="btn btn-primary btn-sm" onclick="fetchSourceAnalysis()">Apply</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="resetSourceAnalysis()">Reset</button>
                </form>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered" id="source-analysis-table">
                    <thead>
                        <tr>
                            <th rowspan="2">Source</th>
                            <th colspan="2" class="calls-allocated">Calls Allocated</th>
                            <th colspan="2" class="calls-attempted">Calls Attempted</th>
                            <th colspan="2" class="calls-connected">Calls Connected</th>
                            <th colspan="10" class="pending-header">Pending</th>
                            <th colspan="14" class="closedlost-header">Closed-Lost</th>
                            <th colspan="2" class="salespipeline-header">Sales Pipeline</th>
                        </tr>
                        <tr>
                            <th class="sub-header calls-allocated">Total</th>
                            <th class="sub-header calls-allocated">%</th>
                            <th class="sub-header calls-attempted">Total</th>
                            <th class="sub-header calls-attempted">%</th>
                            <th class="sub-header calls-connected">Total</th>
                            <th class="sub-header calls-connected">%</th>
                            <th class="sub-header pending-header">Interested</th>
                            <th class="sub-header pending-header">%</th>
                            <th class="sub-header pending-header">Hot</th>
                            <th class="sub-header pending-header">%</th>
                            <th class="sub-header pending-header">Warm</th>
                            <th class="sub-header pending-header">%</th>
                            <th class="sub-header pending-header">Cold</th>
                            <th class="sub-header pending-header">%</th>
                            <th class="sub-header pending-header">Call Back</th>
                            <th class="sub-header pending-header">%</th>
                            <th class="sub-header closedlost-header">Lost to Competition</th>
                            <th class="sub-header closedlost-header">%</th>
                            <th class="sub-header closedlost-header">Not Interested</th>
                            <th class="sub-header closedlost-header">%</th>
                            <th class="sub-header closedlost-header">Did Not Enquire</th>
                            <th class="sub-header closedlost-header">%</th>
                            <th class="sub-header closedlost-header">Wrong Lead</th>
                            <th class="sub-header closedlost-header">%</th>
                            <th class="sub-header closedlost-header">RNR-LOST</th>
                            <th class="sub-header closedlost-header">%</th>
                            <th class="sub-header closedlost-header">Finance Reject</th>
                            <th class="sub-header closedlost-header">%</th>
                            <th class="sub-header closedlost-header">Co-Dealer</th>
                            <th class="sub-header closedlost-header">%</th>
                            <th class="sub-header salespipeline-header">Total</th>
                            <th class="sub-header salespipeline-header">%</th>
                        </tr>
                    </thead>
                    <tbody id="source-analysis-tbody">
                        <tr><td colspan="34" class="text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- CRE Performance Metrics Table (moved inside this container) -->
            <div class="mt-5" id="cre-analysis-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 style="color: var(--airbnb-red); font-weight: 600; margin-bottom: 0;">
                        <i class="fas fa-headset" style="color: var(--airbnb-red);"></i> CRE Performance Metrics
                    </h5>
                    <div class="d-flex align-items-center">
                        <form class="d-flex align-items-center me-3" id="cre-analysis-date-form" onsubmit="return false;">
                            <label for="cre_start_date" class="me-2 mb-0">From:</label>
                            <input type="date" id="cre_start_date" name="start_date" class="form-control form-control-sm me-2">
                            <label for="cre_end_date" class="me-2 mb-0">To:</label>
                            <input type="date" id="cre_end_date" name="end_date" class="form-control form-control-sm me-2">
                            <label for="cre_filter" class="me-2 mb-0">CRE:</label>
                            <select id="cre_filter" class="form-select form-select-sm me-2" style="width: auto;">
                                <option value="">All CREs</option>
                                <!-- CRE options will be populated dynamically -->
                            </select>
                            <button type="button" class="btn btn-primary btn-sm" onclick="fetchCreAnalysis()">Apply</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="resetCreAnalysis()">Reset</button>
                        </form>
                        <a href="{{ url_for('static', filename='CRE Analysis table.csv') }}" class="btn btn-success btn-sm" download>
                            <i class="fas fa-download"></i> Download CSV
                        </a>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered" id="cre-analysis-table">
                        <thead>
                            <tr>
                                <th rowspan="2">CRE Name</th>
                                <th>Calls Allocated</th>
                                <th>Calls Attempted</th>
                                <th>Calls Connected</th>
                                <th>Total</th>
                                <th colspan="3">Interested</th>
                                <th>Call Back</th>
                                <th>RNR</th>
                                <th>Call Disconnected</th>
                                <th>Total</th>
                                <th>Lost to Co-Dealer</th>
                                <th>Lost to Competition</th>
                                <th>Not Interested</th>
                                <th>Did not Enquire</th>
                                <th>Wrong Lead</th>
                                <th>RNR-LOST</th>
                                <th>Finance Reject</th>
                                <th>Sales Pipeline</th>
                                <th>Closed Won</th>
                                <th>Pending</th>
                                <th>Closed Lost</th>
                                <th>Call%</th>
                                <th>Interested%</th>
                                <th>Walkin%</th>
                                <th>Retail%</th>
                            </tr>
                            <tr>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th>Hot</th>
                                <th>Warm</th>
                                <th>Cold</th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th>Total</th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="cre-analysis-tbody">
                            <tr>
                                <td colspan="27" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading live data from database...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Feedback Analysis Section -->
        <div class="table-container mt-5" id="negative-feedback-section">
            <h5 style="color: #fff; background: #c0392b; padding: 0.75rem 1rem; border-radius: 12px 12px 0 0; font-weight: 700; letter-spacing: 1px;">
                <i class="fas fa-thumbs-up"></i> Feedback Analysis (CRE & PS Follow-ups)
            </h5>
            <form class="d-flex align-items-center mb-3" id="negative-feedback-date-form" onsubmit="return false;">
                <label for="nf_start_date" class="me-2 mb-0">From:</label>
                <input type="date" id="nf_start_date" name="start_date" class="form-control form-control-sm me-2">
                <label for="nf_end_date" class="me-2 mb-0">To:</label>
                <input type="date" id="nf_end_date" name="end_date" class="form-control form-control-sm me-2">
                <button type="button" class="btn btn-primary btn-sm" onclick="applyNegativeFeedbackFilter()">Apply</button>
                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="resetNegativeFeedbackFilter()">Reset</button>
            </form>
            <div class="row">
                <div class="col-md-6">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center align-middle" style="background: #fff;">
                            <thead>
                                <tr style="background: #e74c3c; color: #fff;">
                                    <th rowspan="2" style="vertical-align: middle; min-width: 180px;">CRE Feedback</th>
                                    <th colspan="7">CRE Follow-up Number</th>
                                </tr>
                                <tr style="background: #fbeee6; color: #c0392b; font-size: 0.95em;">
                                    <th>F1</th><th>F2</th><th>F3</th><th>F4</th><th>F5</th><th>F6</th><th>F7</th>
                                </tr>
                            </thead>
                            <tbody id="negative-feedback-cre-tbody">
                                <!-- JS will populate rows here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center align-middle" style="background: #fff;">
                            <thead>
                                <tr style="background: #2980b9; color: #fff;">
                                    <th rowspan="2" style="vertical-align: middle; min-width: 180px;">PS Feedback</th>
                                    <th colspan="7">PS Follow-up Number</th>
                                </tr>
                                <tr style="background: #eaf3fb; color: #2980b9; font-size: 0.95em;">
                                    <th>F1</th><th>F2</th><th>F3</th><th>F4</th><th>F5</th><th>F6</th><th>F7</th>
                                </tr>
                            </thead>
                            <tbody id="negative-feedback-ps-tbody">
                                <!-- JS will populate rows here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="mt-2" style="font-size: 0.95em; color: #888;">
                <i class="fas fa-info-circle"></i> <b>Note:</b> Each cell shows the number of feedbacks received at that follow-up, out of all leads that reached that follow-up. Table updates live as data changes.
            </div>
        </div>

        <script>
        // Define metricCell function at the top so it's always available
        function metricCell(val, pct, cls) {
            return `<div class='metric-cell ${cls}' data-pct='${pct}'>
                <span class='metric-number'>${val}</span>
                <span class='metric-percent'>${pct}%</span>
            </div>`;
        }

        // Function to populate CRE dropdown
        function populateCreDropdown() {
            console.log('Fetching CRE list from database...');
            fetch('/get_cre_list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('CRE list received:', data.cre_list);
                        const dropdown = document.getElementById('cre_filter');
                        // Clear existing options except the first one
                        while (dropdown.options.length > 1) {
                            dropdown.remove(1);
                        }
                        
                        // Add CRE options
                        data.cre_list.forEach(cre => {
                            const option = document.createElement('option');
                            option.value = cre.name;
                            option.textContent = cre.name;
                            dropdown.appendChild(option);
                        });
                    } else {
                        console.error('Failed to fetch CRE list:', data.message);
                    }
                })
                .catch(err => {
                    console.error('Error fetching CRE list:', err);
                    // Add error handling UI
                    const dropdown = document.getElementById('cre_filter');
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Error loading CREs';
                    option.disabled = true;
                    dropdown.appendChild(option);
                });
        }

        // Update fetchCreAnalysis to include CRE filter
        function fetchCreAnalysis() {
            const startDate = document.getElementById('cre_start_date').value;
            const endDate = document.getElementById('cre_end_date').value;
            const creFilter = document.getElementById('cre_filter').value;
            
            // Show loading spinner
            document.getElementById('cre-analysis-tbody').innerHTML = `
                <tr>
                    <td colspan="27" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading live data from database...</p>
                    </td>
                </tr>
            `;
            
            // Build query parameters
            let params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (creFilter) params.append('cre_name', creFilter);
            
            fetch(`/cre_analysis_data?${params.toString()}`)
                .then(response => response.json())
                .then(res => {
                    if (!res.success) {
                        document.getElementById('cre-analysis-tbody').innerHTML = `<tr><td colspan='27' class='text-center'>${res.message}</td></tr>`;
                        return;
                    }
                    console.log("CRE data received from database:", res.data);
                    updateCreAnalysisTable(res.data);
                })
                .catch(err => {
                    document.getElementById('cre-analysis-tbody').innerHTML = `<tr><td colspan='27' class='text-center'>Error loading data from database</td></tr>`;
                    console.error("Error fetching CRE data:", err);
                });
        }

        // Reset function should also reset the CRE dropdown
        function resetCreAnalysis() {
            document.getElementById('cre_start_date').value = '';
            document.getElementById('cre_end_date').value = '';
            document.getElementById('cre_filter').value = '';
            fetchCreAnalysis();
        }
        
        function updateCreAnalysisTable(data) {
            if (!data) {
                document.getElementById('cre-analysis-tbody').innerHTML = `
                    <tr>
                        <td colspan="27" class="text-center">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> Error loading data from database
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            let html = '';
            const cres = Object.keys(data).filter(name => name !== 'Total');
            cres.forEach(cre => {
                const d = data[cre];
                html += `<tr>
                    <td>${cre}</td>
                    <td>${d.calls_allocated || 0}</td>
                    <td>${d.calls_attempted || 0}</td>
                    <td>${d.calls_connected || 0}</td>
                    <td>${d.total_leads || 0}</td>
                    <td>${d.hot_leads || 0}</td>
                    <td>${d.warm_leads || 0}</td>
                    <td>${d.cold_leads || 0}</td>
                    <td>${d.callback_leads || 0}</td>
                    <td>${d.rnr_leads || 0}</td>
                    <td>${d.disconnected_calls || 0}</td>
                    <td>${d.lost_total || 0}</td>
                    <td>${d.lost_co_dealer || 0}</td>
                    <td>${d.lost_competition || 0}</td>
                    <td>${d.not_interested || 0}</td>
                    <td>${d.did_not_enquire || 0}</td>
                    <td>${d.wrong_lead || 0}</td>
                    <td>${d.rnr_lost || 0}</td>
                    <td>${d.finance_reject || 0}</td>
                    <td>${d.sales_pipeline_total || 0}</td>
                    <td>${d.closed_won || 0}</td>
                    <td>${d.pending || 0}</td>
                    <td>${d.closed_lost || 0}</td>
                    <td>${d.call_percentage || 0}%</td>
                    <td>${d.interested_percentage || 0}%</td>
                    <td>${d.walkin_percentage || 0}%</td>
                    <td>${d.retail_percentage || 0}%</td>
                </tr>`;
            });
            // Add totals row with correct percentage calculation (out of 100%)
            if (data.Total) {
                const t = data.Total;
                // Calculate percentages out of 100%
                const callPct = t.calls_allocated ? ((t.calls_connected / t.calls_allocated) * 100).toFixed(1) : 0;
                const interestedPct = t.calls_allocated ? ((t.total_leads / t.calls_allocated) * 100).toFixed(1) : 0;
                const walkinPct = t.calls_allocated ? ((t.pending / t.calls_allocated) * 100).toFixed(1) : 0;
                const retailPct = t.calls_allocated ? ((t.closed_won / t.calls_allocated) * 100).toFixed(1) : 0;
                html += `<tr class="total-row">
                    <td>Total</td>
                    <td>${t.calls_allocated || 0}</td>
                    <td>${t.calls_attempted || 0}</td>
                    <td>${t.calls_connected || 0}</td>
                    <td>${t.total_leads || 0}</td>
                    <td>${t.hot_leads || 0}</td>
                    <td>${t.warm_leads || 0}</td>
                    <td>${t.cold_leads || 0}</td>
                    <td>${t.callback_leads || 0}</td>
                    <td>${t.rnr_leads || 0}</td>
                    <td>${t.disconnected_calls || 0}</td>
                    <td>${t.lost_total || 0}</td>
                    <td>${t.lost_co_dealer || 0}</td>
                    <td>${t.lost_competition || 0}</td>
                    <td>${t.not_interested || 0}</td>
                    <td>${t.did_not_enquire || 0}</td>
                    <td>${t.wrong_lead || 0}</td>
                    <td>${t.rnr_lost || 0}</td>
                    <td>${t.finance_reject || 0}</td>
                    <td>${t.sales_pipeline_total || 0}</td>
                    <td>${t.closed_won || 0}</td>
                    <td>${t.pending || 0}</td>
                    <td>${t.closed_lost || 0}</td>
                    <td>${callPct}%</td>
                    <td>${interestedPct}%</td>
                    <td>${walkinPct}%</td>
                    <td>${retailPct}%</td>
                </tr>`;
            }
            document.getElementById('cre-analysis-tbody').innerHTML = html;
        }

        // Source Distribution Bar Chart
        const sourceCtx = document.getElementById('sourceChart').getContext('2d');
        new Chart(sourceCtx, {
            type: 'bar',
            data: {
                labels: {{ analytics.source_labels | tojsonfilter | safe }},
                datasets: [{
                    label: 'Leads',
                    data: {{ analytics.source_data | tojsonfilter | safe }},
                    backgroundColor: [
                        '#FF385C', '#00A699', '#FFB400', '#007A87',
                        '#8B5CF6', '#FF6B35', '#20C997', '#6C757D'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: {
                                family: 'Lexend'
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: {
                                family: 'Lexend'
                            }
                        }
                    }
                }
            }
        });

        // Lead Trends Line Chart
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: {{ analytics.trend_labels | tojsonfilter | safe }},
                datasets: [{
                    label: 'Daily Leads',
                    data: {{ analytics.trend_data | tojsonfilter | safe }},
                    borderColor: '#FF385C',
                    backgroundColor: 'rgba(255, 56, 92, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#FF385C',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: {
                                family: 'Lexend'
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            font: {
                                family: 'Lexend'
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // Branch Details Functions
        function showBranchDetails(branchName) {
            document.getElementById('branchName').textContent = branchName;
            const modal = new bootstrap.Modal(document.getElementById('branchDetailsModal'));
            modal.show();

            document.getElementById('branchDetailsContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border" style="color: var(--airbnb-red);" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2" style="color: var(--airbnb-gray-600);">Loading PS performance data...</p>
                </div>
            `;

            fetch(`/branch_performance/${encodeURIComponent(branchName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayBranchDetails(data.data);
                    } else {
                        displayError(data.message || 'Failed to load branch details');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    displayError('An error occurred while loading branch details');
                });
        }

        function displayBranchDetails(data) {
            const content = document.getElementById('branchDetailsContent');

            if (!data.ps_performance || data.ps_performance.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-user-tie fa-3x mb-3" style="color: var(--airbnb-gray-400);"></i>
                        <h5 style="color: var(--airbnb-gray-500);">No PS users found in this branch</h5>
                        <p style="color: var(--airbnb-gray-500);">Add PS users to this branch to see performance data</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-white" style="background: var(--airbnb-red);">
                            <div class="card-body text-center">
                                <h4>${data.summary.total_ps}</h4>
                                <small>Total PS</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white" style="background: var(--airbnb-green);">
                            <div class="card-body text-center">
                                <h4>${data.summary.total_leads}</h4>
                                <small>Total Leads</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white" style="background: var(--airbnb-yellow);">
                            <div class="card-body text-center">
                                <h4>${data.summary.won_leads}</h4>
                                <small>Won Leads</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-white" style="background: var(--airbnb-blue);">
                            <div class="card-body text-center">
                                <h4>${data.summary.success_rate}%</h4>
                                <small>Success Rate</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>PS Name</th>
                                <th>Contact</th>
                                <th>Assigned Leads</th>
                                <th>Pending</th>
                                <th>In Progress</th>
                                <th>Won</th>
                                <th>Lost</th>
                                <th>Success Rate</th>
                                <th>Avg Calls</th>
                                <th>Last Activity</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.ps_performance.forEach(ps => {
                html += `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm rounded-circle d-flex align-items-center justify-content-center me-3">
                                    <i class="fas fa-user-tie text-white"></i>
                                </div>
                                <div>
                                    <strong>${ps.name}</strong>
                                    <br><small style="color: var(--airbnb-gray-500);">${ps.username}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <small><i class="fas fa-phone" style="color: var(--airbnb-gray-500);"></i> ${ps.phone}</small><br>
                            <small><i class="fas fa-envelope" style="color: var(--airbnb-gray-500);"></i> ${ps.email}</small>
                        </td>
                        <td><span class="badge" style="background: var(--airbnb-red);">${ps.total_leads}</span></td>
                        <td><span class="badge" style="background: var(--airbnb-gray-500);">${ps.pending_leads}</span></td>
                        <td><span class="badge" style="background: var(--airbnb-yellow);">${ps.in_progress_leads}</span></td>
                        <td><span class="badge" style="background: var(--airbnb-green);">${ps.won_leads}</span></td>
                        <td><span class="badge bg-danger">${ps.lost_leads}</span></td>
                        <td>
                            <div class="progress" style="height: 20px; min-width: 80px;">
                                <div class="progress-bar"
                                     style="width: ${ps.success_rate}%; background: ${ps.success_rate >= 50 ? 'var(--airbnb-green)' : ps.success_rate >= 25 ? 'var(--airbnb-yellow)' : '#dc3545'};">
                                    ${ps.success_rate}%
                                </div>
                            </div>
                        </td>
                        <td>${ps.avg_calls}</td>
                        <td>
                            ${ps.last_activity ? `<small style="color: var(--airbnb-gray-500);">${ps.last_activity}</small>` : '<small style="color: var(--airbnb-gray-500);">No activity</small>'}
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            content.innerHTML = html;
        }

        function displayError(message) {
            document.getElementById('branchDetailsContent').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3" style="color: var(--airbnb-yellow);"></i>
                    <h5 style="color: var(--airbnb-yellow);">Error Loading Data</h5>
                    <p style="color: var(--airbnb-gray-500);">${message}</p>
                </div>
            `;
        }

        function metricNumberCell(val, cls) {
            return `<td class='metric-number-cell ${cls}'>${val}</td>`;
        }
        function metricPercentCell(pct, cls) {
            return `<td class='metric-percent-cell ${cls}' data-pct='${pct}'>${pct}%</td>`;
        }

        function fetchSourceAnalysis() {
            const start = document.getElementById('sa_start_date').value;
            const end = document.getElementById('sa_end_date').value;
            let url = '/source_analysis_data';
            if (start && end) {
                url += `?start_date=${start}&end_date=${end}`;
            }
            fetch(url)
                .then(res => res.json())
                .then(res => {
                    if (!res.success) {
                        document.getElementById('source-analysis-tbody').innerHTML = `<tr><td colspan='34' class='text-center'>${res.message}</td></tr>`;
                        return;
                    }
                    const data = res.data;
                    const sources = Object.keys(data).filter(s => s !== 'Total');
                    let html = '';
                    const t = data['Total'];
                    const total = t.calls_allocated || 1;
                    sources.forEach(src => {
                        const d = data[src];
                        html += `<tr>
                            <td>${src}</td>
                            ${metricNumberCell(d.calls_allocated, 'calls-allocated')}
                            ${metricPercentCell(((d.calls_allocated/total)*100).toFixed(1), 'calls-allocated')}
                            ${metricNumberCell(d.calls_attempted, 'calls-attempted')}
                            ${metricPercentCell(((d.calls_attempted/total)*100).toFixed(1), 'calls-attempted')}
                            ${metricNumberCell(d.calls_connected, 'calls-connected')}
                            ${metricPercentCell(((d.calls_connected/total)*100).toFixed(1), 'calls-connected')}
                            ${metricNumberCell(d.pending_interested, 'pending-cell')}
                            ${metricPercentCell(((d.pending_interested/total)*100).toFixed(1), 'pending-cell')}
                            ${metricNumberCell(d.pending_hot, 'pending-cell')}
                            ${metricPercentCell(((d.pending_hot/total)*100).toFixed(1), 'pending-cell')}
                            ${metricNumberCell(d.pending_warm, 'pending-cell')}
                            ${metricPercentCell(((d.pending_warm/total)*100).toFixed(1), 'pending-cell')}
                            ${metricNumberCell(d.pending_cold, 'pending-cell')}
                            ${metricPercentCell(((d.pending_cold/total)*100).toFixed(1), 'pending-cell')}
                            ${metricNumberCell(d.pending_callback, 'pending-cell')}
                            ${metricPercentCell(((d.pending_callback/total)*100).toFixed(1), 'pending-cell')}
                            ${metricNumberCell(d.closed_lost_competition, 'closedlost-cell')}
                            ${metricPercentCell(((d.closed_lost_competition/total)*100).toFixed(1), 'closedlost-cell')}
                            ${metricNumberCell(d.closed_lost_not_interested, 'closedlost-cell')}
                            ${metricPercentCell(((d.closed_lost_not_interested/total)*100).toFixed(1), 'closedlost-cell')}
                            ${metricNumberCell(d.closed_lost_did_not_enquire, 'closedlost-cell')}
                            ${metricPercentCell(((d.closed_lost_did_not_enquire/total)*100).toFixed(1), 'closedlost-cell')}
                            ${metricNumberCell(d.closed_lost_wrong_lead, 'closedlost-cell')}
                            ${metricPercentCell(((d.closed_lost_wrong_lead/total)*100).toFixed(1), 'closedlost-cell')}
                            ${metricNumberCell(d.closed_lost_rnr_lost, 'closedlost-cell')}
                            ${metricPercentCell(((d.closed_lost_rnr_lost/total)*100).toFixed(1), 'closedlost-cell')}
                            ${metricNumberCell(d.closed_lost_finance_reject, 'closedlost-cell')}
                            ${metricPercentCell(((d.closed_lost_finance_reject/total)*100).toFixed(1), 'closedlost-cell')}
                            ${metricNumberCell(d.closed_lost_co_dealer, 'closedlost-cell')}
                            ${metricPercentCell(((d.closed_lost_co_dealer/total)*100).toFixed(1), 'closedlost-cell')}
                            ${metricNumberCell(d.sales_pipeline_total, 'salespipeline-cell')}
                            ${metricPercentCell(((d.sales_pipeline_total/total)*100).toFixed(1), 'salespipeline-cell')}
                        </tr>`;
                    });
                    // Totals row
                    html += `<tr class='total-row'>
                        <td>Total</td>
                        ${metricNumberCell(t.calls_allocated, 'calls-allocated')}
                        ${metricPercentCell(((t.calls_allocated/total)*100).toFixed(1), 'calls-allocated')}
                        ${metricNumberCell(t.calls_attempted, 'calls-attempted')}
                        ${metricPercentCell(((t.calls_attempted/total)*100).toFixed(1), 'calls-attempted')}
                        ${metricNumberCell(t.calls_connected, 'calls-connected')}
                        ${metricPercentCell(((t.calls_connected/total)*100).toFixed(1), 'calls-connected')}
                        ${metricNumberCell(t.pending_interested, 'pending-cell')}
                        ${metricPercentCell(((t.pending_interested/total)*100).toFixed(1), 'pending-cell')}
                        ${metricNumberCell(t.pending_hot, 'pending-cell')}
                        ${metricPercentCell(((t.pending_hot/total)*100).toFixed(1), 'pending-cell')}
                        ${metricNumberCell(t.pending_warm, 'pending-cell')}
                        ${metricPercentCell(((t.pending_warm/total)*100).toFixed(1), 'pending-cell')}
                        ${metricNumberCell(t.pending_cold, 'pending-cell')}
                        ${metricPercentCell(((t.pending_cold/total)*100).toFixed(1), 'pending-cell')}
                        ${metricNumberCell(t.pending_callback, 'pending-cell')}
                        ${metricPercentCell(((t.pending_callback/total)*100).toFixed(1), 'pending-cell')}
                        ${metricNumberCell(t.closed_lost_competition, 'closedlost-cell')}
                        ${metricPercentCell(((t.closed_lost_competition/total)*100).toFixed(1), 'closedlost-cell')}
                        ${metricNumberCell(t.closed_lost_not_interested, 'closedlost-cell')}
                        ${metricPercentCell(((t.closed_lost_not_interested/total)*100).toFixed(1), 'closedlost-cell')}
                        ${metricNumberCell(t.closed_lost_did_not_enquire, 'closedlost-cell')}
                        ${metricPercentCell(((t.closed_lost_did_not_enquire/total)*100).toFixed(1), 'closedlost-cell')}
                        ${metricNumberCell(t.closed_lost_wrong_lead, 'closedlost-cell')}
                        ${metricPercentCell(((t.closed_lost_wrong_lead/total)*100).toFixed(1), 'closedlost-cell')}
                        ${metricNumberCell(t.closed_lost_rnr_lost, 'closedlost-cell')}
                        ${metricPercentCell(((t.closed_lost_rnr_lost/total)*100).toFixed(1), 'closedlost-cell')}
                        ${metricNumberCell(t.closed_lost_finance_reject, 'closedlost-cell')}
                        ${metricPercentCell(((t.closed_lost_finance_reject/total)*100).toFixed(1), 'closedlost-cell')}
                        ${metricNumberCell(t.closed_lost_co_dealer, 'closedlost-cell')}
                        ${metricPercentCell(((t.closed_lost_co_dealer/total)*100).toFixed(1), 'closedlost-cell')}
                        ${metricNumberCell(t.sales_pipeline_total, 'salespipeline-cell')}
                        ${metricPercentCell(((t.sales_pipeline_total/total)*100).toFixed(1), 'salespipeline-cell')}
                    </tr>`;
                    document.getElementById('source-analysis-tbody').innerHTML = html;
                })
                .catch(err => {
                    document.getElementById('source-analysis-tbody').innerHTML = `<tr><td colspan='34' class='text-center'>Error loading data</td></tr>`;
                    console.error(err);
                });
        }

        function resetSourceAnalysis() {
            document.getElementById('sa_start_date').value = '';
            document.getElementById('sa_end_date').value = '';
            fetchSourceAnalysis();
        }

        document.addEventListener('DOMContentLoaded', function() {
            populateCreDropdown();
            fetchSourceAnalysis();
            fetchCreAnalysis();
        });

        // Mini donut chart renderer
        function renderMiniDonut(canvas, percent, color) {
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const size = 32;
            canvas.width = size;
            canvas.height = size;
            ctx.clearRect(0, 0, size, size);
            // Background
            ctx.beginPath();
            ctx.arc(size/2, size/2, size/2-2, 0, 2*Math.PI);
            ctx.fillStyle = '#f2f2f2';
            ctx.fill();
            // Foreground arc
            ctx.beginPath();
            ctx.moveTo(size/2, size/2);
            ctx.arc(size/2, size/2, size/2-4, -Math.PI/2, -Math.PI/2 + 2*Math.PI*(percent/100), false);
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
        }

        // --- Negative Feedback Analysis (CRE & PS Follow-ups) ---
        function renderNegativeFeedbackTable(data, role, filterType='filtered') {
            if (!data || !data.statuses || !data.call_no_order || !data[role] || !data[role][filterType]) {
                return `<tr><td colspan="8" class="text-center">No data available</td></tr>`;
            }
            const statuses = data.statuses;
            const callNos = data.call_no_order;
            const counts = data[role][filterType];
            let html = '';
            statuses.forEach(status => {
                html += `<tr><td style="font-weight:600;text-align:left;color:#c0392b;">${status}</td>`;
                callNos.forEach(callNo => {
                    html += `<td>${(counts[callNo] && counts[callNo][status]) ? counts[callNo][status] : 0}</td>`;
                });
                html += '</tr>';
            });
            return html;
        }
        function fetchNegativeCallAttempts() {
            const fromDate = document.getElementById('nf_start_date').value;
            const toDate = document.getElementById('nf_end_date').value;
            let url = '/negative_call_attempt_history';
            const params = [];
            // Ensure date format is yyyy-mm-dd for backend
            if (fromDate) params.push('from_date=' + encodeURIComponent(fromDate));
            if (toDate) params.push('to_date=' + encodeURIComponent(toDate));
            if (params.length) url += '?' + params.join('&');
            console.log('[Negative Feedback] Fetching:', url); // Debug log
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    console.log('[Negative Feedback] Data received:', data); // Debug log
                    document.getElementById('negative-feedback-cre-tbody').innerHTML = renderNegativeFeedbackTable(data, 'CRE', 'filtered');
                    document.getElementById('negative-feedback-ps-tbody').innerHTML = renderNegativeFeedbackTable(data, 'PS', 'filtered');
                })
                .catch(err => {
                    document.getElementById('negative-feedback-cre-tbody').innerHTML = '<tr><td colspan="8" class="text-center">Error loading data</td></tr>';
                    document.getElementById('negative-feedback-ps-tbody').innerHTML = '<tr><td colspan="8" class="text-center">Error loading data</td></tr>';
                    console.error('[Negative Feedback] Error:', err);
                });
        }
        function applyNegativeFeedbackFilter() { fetchNegativeCallAttempts(); }
        function resetNegativeFeedbackFilter() {
            document.getElementById('nf_start_date').value = '';
            document.getElementById('nf_end_date').value = '';
            fetchNegativeCallAttempts();
        }
        document.addEventListener('DOMContentLoaded', function() { fetchNegativeCallAttempts(); });
        </script>
    </div>

    <!-- Branch Details Modal -->
    <div class="modal fade" id="branchDetailsModal" tabindex="-1" aria-labelledby="branchDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--airbnb-blue); color: var(--airbnb-white);">
                    <h5 class="modal-title" id="branchDetailsModalLabel">
                        <i class="fas fa-building"></i> <span id="branchName"></span> - PS Performance
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div id="branchDetailsContent">
                        <div class="text-center py-4">
                            <div class="spinner-border" style="color: var(--airbnb-red);" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2" style="color: var(--airbnb-gray-600);">Loading PS performance data...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
