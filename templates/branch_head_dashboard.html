
{% extends "base.html" %}
{% block title %}Branch Head Dashboard - Ather CRM{% endblock %}
{% block content %}

<div class="container-fluid">
    <!-- Profile Info Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm mb-2 border-info">
                <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between p-3 bg-light">
                    <div>
                        <h4 class="mb-1 text-primary"><i class="fas fa-user-tie me-2"></i>{{ session.branch_head_name }}</h4>
                        <div class="text-muted">Branch: <span class="fw-bold">{{ session.branch_head_branch }}</span></div>
                    </div>
                    <div class="mt-2 mt-md-0">
                        <span class="badge bg-info text-dark fs-6 py-2 px-3">Branch Head Dashboard</span>
                    </div>
                    <span class="me-4 text-dark"><i class="fas fa-user-circle me-1"></i> Welcome, {{ session.branch_head_name }}</span>
            <a href="{{ url_for('logout') }}" class="text-dark text-decoration-none"><i class="fas fa-sign-out-alt me-1"></i> Logout</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Zoho Dashboards Section -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Zoho Dashboards</h5>
                </div>
                <div class="card-body">
                    <div id="branchHeadDashboardsContainer">
                        <!-- Branch Head dashboards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Universal Filter Section (no UID search or rows per page) -->
    <div class="row mb-3" id="universalFilterSection">
      <div class="col-md-3 mb-2">
        <label for="psSelect" class="fw-semibold">Product Specialist:</label>
        <select id="psSelect" class="form-select">
          <option value="">-- All PS --</option>
          {% for ps in ps_users %}
            <option value="{{ ps.name }}">{{ ps.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3 mb-2">
        <label for="dateFrom" class="fw-semibold">From:</label>
        <input type="date" id="dateFrom" class="form-control">
      </div>
      <div class="col-md-3 mb-2">
        <label for="dateTo" class="fw-semibold">To:</label>
        <input type="date" id="dateTo" class="form-control">
      </div>
      <div class="col-md-3 mb-2 d-flex align-items-end">
        <button id="applyFiltersBtn" class="btn btn-primary me-2">Apply</button>
        <button id="resetFiltersBtn" class="btn btn-outline-secondary">Reset</button>
      </div>
    </div>
    <!-- Per-section filter for Fresh Leads (add UID search and rows per page) -->
    <!-- <div class="row mb-2" id="freshLeadsFilterRow">
      <div class="col-md-4 mb-2">
        <input type="text" id="freshLeadsUidSearch" class="form-control" placeholder="Search by UID">
      </div>
      <div class="col-md-2 mb-2">
        <select id="freshLeadsRowsPerPage" class="form-select">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="col-md-2 mb-2 d-flex align-items-end">
        <button id="freshLeadsApplyBtn" class="btn btn-outline-primary">Apply</button>
      </div>
    </div> -->
    <!-- KPI Cards -->
    <div class="row mb-3">
        <div class="col">
            <div class="card text-center bg-primary text-white mb-2">
                <div class="card-body p-2">Fresh<br><span class="h5" id="freshLeadsKPI">{{ fresh_leads_count }}</span></div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center bg-success text-white mb-2"><div class="card-body p-2">Walk-in<br><span class="h5" id="walkinLeadsKPI">{{ walkin_leads_count }}</span></div></div>
        </div>
        <div class="col">
            <div class="card text-center bg-info text-white mb-2"><div class="card-body p-2">CRE Assigned<br><span class="h5" id="creAssignedLeadsKPI">{{ cre_assigned_leads_count }}</span></div></div>
        </div>
        <div class="col">
            <div class="card text-center bg-warning text-dark mb-2">
                <div class="card-body p-2">
                    Pending<br>
                    <span class="h5" id="pendingLeadsKPI">{{ pending_leads_count }}</span>
                    <div class="d-flex justify-content-center mt-2" style="gap: 8px;">
                        <span class="badge bg-secondary text-white" id="pendingLeadsKPI_CRE" title="CRE Assigned Pending Leads">CRE: 0</span>
                        <span class="badge bg-info text-dark" id="pendingLeadsKPI_Event" title="Event Pending Leads">Event: 0</span>
                        <span class="badge bg-success text-white" id="pendingLeadsKPI_Walkin" title="Walk-in Pending Leads">Walk-in: 0</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center bg-secondary text-white mb-2"><div class="card-body p-2">Today's Follow-ups<br><span class="h5" id="followupLeadsKPI">{{ followup_leads_count }}</span></div></div>
        </div>
        <div class="col">
            <div class="card text-center bg-dark text-white mb-2"><div class="card-body p-2">Event<br><span class="h5" id="eventLeadsKPI">{{ event_leads_count }}</span></div></div>
        </div>
        <div class="col">
            <div class="card text-center bg-success text-white mb-2"><div class="card-body p-2">Won<br><span class="h5" id="wonLeadsKPI">{{ won_leads_count }}</span></div></div>
        </div>
        <div class="col">
            <div class="card text-center bg-danger text-white mb-2"><div class="card-body p-2">Lost<br><span class="h5" id="lostLeadsKPI">{{ lost_leads_count }}</span></div></div>
        </div>
    </div>
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-3" id="leadTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" id="fresh-tab" data-bs-toggle="tab" href="#fresh" role="tab">Fresh Leads</a></li>
        <li class="nav-item"><a class="nav-link" id="walkin-tab" data-bs-toggle="tab" href="#walkin" role="tab">Walk-in Leads</a></li>
        <li class="nav-item"><a class="nav-link" id="creassigned-tab" data-bs-toggle="tab" href="#creassigned" role="tab">CRE Assigned Leads</a></li>
        <li class="nav-item"><a class="nav-link" id="pending-tab" data-bs-toggle="tab" href="#pending" role="tab">Pending Leads</a></li>
        <li class="nav-item"><a class="nav-link" id="followup-tab" data-bs-toggle="tab" href="#followup" role="tab">Today's Follow-ups</a></li>
        <li class="nav-item"><a class="nav-link" id="event-tab" data-bs-toggle="tab" href="#event" role="tab">Event Leads</a></li>
        <li class="nav-item"><a class="nav-link" id="won-tab" data-bs-toggle="tab" href="#won" role="tab">Won Leads</a></li>
        <li class="nav-item"><a class="nav-link" id="lost-tab" data-bs-toggle="tab" href="#lost" role="tab">Lost Leads</a></li>
    </ul>
    <div class="tab-content" id="leadTabsContent">
        <!-- Fresh Leads Tab -->
        <div class="tab-pane fade show active" id="fresh" role="tabpanel">
            
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row mb-2" id="freshLeadsFilterRow">
                        <div class="col-md-4 mb-2">
                          <input type="text" id="freshLeadsUidSearch" class="form-control" placeholder="Search by UID">
                        </div>
                        <div class="col-md-2 mb-2">
                          <select id="freshLeadsRowsPerPage" class="form-select">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                          </select>
                        </div>
                        <div class="col-md-2 mb-2 d-flex align-items-end">
                          <button id="freshLeadsApplyBtn" class="btn btn-outline-primary">Apply</button>
                        </div>
                      </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>UID</th>
                                    <th>Customer Name</th>
                                    <th>Phone No.</th>
                                    <th>Final Status</th>
                                    <th>PS Name</th>
                                    <th>Created At</th>
                                    <th>Branch</th>
                                </tr>
                            </thead>
                            <tbody id="freshLeadsTableBody">
                                <tr><td colspan="7">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Walk-in Leads Tab -->
        <div class="tab-pane fade" id="walkin" role="tabpanel">
            <div class="card mb-3">
                <div class="card-body">
                    <!-- Add UID search and rows-per-page selector for Walk-in Leads -->
                    <div class="row mb-2" id="walkinLeadsFilterRow">
                      <div class="col-md-4 mb-2">
                        <input type="text" id="walkinLeadsUidSearch" class="form-control" placeholder="Search by UID">
                        </div>
                      <div class="col-md-2 mb-2">
                        <select id="walkinLeadsRowsPerPage" class="form-select">
                          <option value="10">10</option>
                          <option value="25" selected>25</option>
                          <option value="50">50</option>
                          <option value="100">100</option>
                            </select>
                        </div>
                      <div class="col-md-2 mb-2 d-flex align-items-end">
                        <button id="walkinLeadsApplyBtn" class="btn btn-outline-primary">Apply</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>UID</th>
                                    <th>Customer Name</th>
                                    <th>Mobile</th>
                                    <th>Email</th>
                                    <th>Model Interested</th>
                                    <th>Lead Source</th>
                                    <th>Status</th>
                                    <th>PS Name</th>
                                    <th>Created At</th>
                                </tr>
                            </thead>
                            <tbody id="walkinLeadsTableBody">
                                <tr><td colspan="9">Loading...</td></tr>
                            </tbody>
                        </table>
                        <div id="walkinLeadsPagination"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination controls -->
        <!-- Remove old Jinja pagination navs that use total_pages, walkin_page, etc. -->
        <!-- (Pagination is now handled by JS) -->
        <!-- CRE Assigned Leads Tab -->
        <div class="tab-pane fade" id="creassigned" role="tabpanel">
            <div class="card mb-3">
                <div class="card-body">
                    <!-- Filters -->
                    <div class="row g-2 mb-2" id="creAssignedLeadsFilterRow">
                        <div class="col-auto">
                            <input type="text" class="form-control" id="creAssignedLeadsUidSearch" placeholder="Search by UID">
                        </div>
                        <div class="col-auto">
                            <select class="form-select" id="creAssignedLeadsRowsPerPage">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button id="creAssignedLeadsApplyBtn" class="btn btn-outline-primary">Apply</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Phone No.</th>
                                    <th>Final Status</th>
                                    <th>UID</th>
                                    <th>Source</th>
                                    <th>Assigned Time</th>
                                    <th>PS Name</th>
                                </tr>
                            </thead>
                            <tbody id="creAssignedLeadsTableBody">
                                <tr><td colspan="7">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Pending Leads Tab -->
        <div class="tab-pane fade" id="pending" role="tabpanel">
            <div class="card mb-3">
                <div class="card-body">
                    <!-- Filters -->
                    <div class="row g-2 mb-2" id="pendingLeadsFilterRow">
                        <div class="col-auto">
                            <input type="text" class="form-control" id="pendingLeadsUidSearch" placeholder="Search by UID">
                        </div>
                        <div class="col-auto">
                            <select class="form-select" id="pendingLeadsRowsPerPage">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button id="pendingLeadsApplyBtn" class="btn btn-outline-primary">Apply</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>UID</th>
                                    <th>Customer Name</th>
                                    <th>Phone No.</th>
                                    <th>Final Status</th>
                                    <th>Source</th>
                                    <th>Assigned Time</th>
                                    <th>PS Name</th>
                                </tr>
                            </thead>
                            <tbody id="pendingLeadsTableBody">
                                <tr><td colspan="7">Loading...</td></tr>
                            </tbody>
                        </table>
                        <div id="pendingLeadsPagination"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Today's Follow-ups Tab -->
        <div class="tab-pane fade" id="followup" role="tabpanel">
            <div class="card mb-3">
                <div class="card-body">
                    <!-- Filters -->
                    <form class="row g-2 mb-2" onsubmit="return false;">
                        <div class="col-auto">
                            <input type="text" class="form-control" id="followupLeadsUidSearch" placeholder="Search by UID">
                        </div>
                        <div class="col-auto">
                            <select class="form-select" id="followupLeadsRowsPerPage">
                                <option value="10">Show 10</option>
                                <option value="25" selected>Show 25</option>
                                <option value="50">Show 50</option>
                                <option value="100">Show 100</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button type="button" id="followupLeadsApplyBtn" class="btn btn-outline-primary">Apply</button>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Phone No.</th>
                                    <th>Final Status</th>
                                    <th>UID</th>
                                    <th>Source</th>
                                    <th>Lead Status</th>
                                    <th>PS Name</th>
                                </tr>
                            </thead>
                            <tbody id="followupLeadsTableBody">
                                <tr><td colspan="7">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Event Leads Tab -->
        <div class="tab-pane fade" id="event" role="tabpanel">
            <div class="card mb-3">
                <div class="card-body">
                    <!-- Filters -->
                    <form class="row g-2 mb-2" onsubmit="return false;">
                        <div class="col-auto">
                            <input type="text" class="form-control" id="eventLeadsUidSearch" placeholder="Search by UID">
                        </div>
                        <div class="col-auto">
                            <select class="form-select" id="eventLeadsRowsPerPage">
                                <option value="10">Show 10</option>
                                <option value="25" selected>Show 25</option>
                                <option value="50">Show 50</option>
                                <option value="100">Show 100</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button type="button" id="eventLeadsApplyBtn" class="btn btn-outline-primary">Apply</button>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Phone No.</th>
                                    <th>Final Status</th>
                                    <th>UID</th>
                                    <th>Source</th>
                                    <th>Lead Status</th>
                                    <th>PS Name</th>
                                </tr>
                            </thead>
                            <tbody id="eventLeadsTableBody">
                                <tr><td colspan="7">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Won Leads Tab -->
        <div class="tab-pane fade" id="won" role="tabpanel">
            <div class="card mb-3">
                <div class="card-body">
                    <!-- Filters -->
                    <form class="row g-2 mb-2" onsubmit="return false;">
                        <div class="col-auto">
                            <input type="text" class="form-control" id="wonLeadsUidSearch" placeholder="Search by UID">
                        </div>
                        <div class="col-auto">
                            <select class="form-select" id="wonLeadsRowsPerPage">
                                <option value="10">Show 10</option>
                                <option value="25" selected>Show 25</option>
                                <option value="50">Show 50</option>
                                <option value="100">Show 100</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button type="button" id="wonLeadsApplyBtn" class="btn btn-outline-primary">Apply</button>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Phone No.</th>
                                    <th>Final Status</th>
                                    <th>UID</th>
                                    <th>Source</th>
                                    <th>Lead Status</th>
                                    <th>PS Name</th>
                                </tr>
                            </thead>
                            <tbody id="wonLeadsTableBody">
                                <tr><td colspan="7">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Lost Leads Tab -->
        <div class="tab-pane fade" id="lost" role="tabpanel">
            <div class="card mb-3">
                <div class="card-body">
                    <!-- Filters -->
                    <form class="row g-2 mb-2" onsubmit="return false;">
                        <div class="col-auto">
                            <input type="text" class="form-control" id="lostLeadsUidSearch" placeholder="Search by UID">
                        </div>
                        <div class="col-auto">
                            <select class="form-select" id="lostLeadsRowsPerPage">
                                <option value="10">Show 10</option>
                                <option value="25" selected>Show 25</option>
                                <option value="50">Show 50</option>
                                <option value="100">Show 100</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button type="button" id="lostLeadsApplyBtn" class="btn btn-outline-primary">Apply</button>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Phone No.</th>
                                    <th>Final Status</th>
                                    <th>UID</th>
                                    <th>Source</th>
                                    <th>Lead Status</th>
                                    <th>PS Name</th>
                                </tr>
                            </thead>
                            <tbody id="lostLeadsTableBody">
                                <tr><td colspan="7">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Function to update all KPI counts
function updateAllKPIs(data) {
  // Update all KPI counts from the response
  if (data.fresh_leads_count !== undefined) {
    document.getElementById('freshLeadsKPI').textContent = data.fresh_leads_count;
  }
  if (data.walkin_leads_count !== undefined) {
    document.getElementById('walkinLeadsKPI').textContent = data.walkin_leads_count;
  }
  if (data.cre_assigned_leads_count !== undefined) {
    document.getElementById('creAssignedLeadsKPI').textContent = data.cre_assigned_leads_count;
  }
  if (data.pending_leads_count !== undefined) {
    document.getElementById('pendingLeadsKPI').textContent = data.pending_leads_count;
  }
  if (data.followup_leads_count !== undefined) {
    document.getElementById('followupLeadsKPI').textContent = data.followup_leads_count;
  }
  if (data.event_leads_count !== undefined) {
    document.getElementById('eventLeadsKPI').textContent = data.event_leads_count;
  }
  if (data.won_leads_count !== undefined) {
    document.getElementById('wonLeadsKPI').textContent = data.won_leads_count;
  }
  if (data.lost_leads_count !== undefined) {
    document.getElementById('lostLeadsKPI').textContent = data.lost_leads_count;
  }
  
  // Update pending leads sub-counts if available
  if (data.pending_leads_cre_assigned_count !== undefined) {
    document.getElementById('pendingLeadsKPI_CRE').textContent = `CRE: ${data.pending_leads_cre_assigned_count}`;
  }
  if (data.pending_leads_event_count !== undefined) {
    document.getElementById('pendingLeadsKPI_Event').textContent = `Event: ${data.pending_leads_event_count}`;
  }
  if (data.pending_leads_walkin_count !== undefined) {
    document.getElementById('pendingLeadsKPI_Walkin').textContent = `Walk-in: ${data.pending_leads_walkin_count}`;
  }
}

// Utility to get universal filters
function getUniversalFilters() {
  return {
    ps_name: document.getElementById('psSelect').value,
    date_from: document.getElementById('dateFrom').value,
    date_to: document.getElementById('dateTo').value
  };
}

// Section config: section name, table body id, columns
const sectionConfig = {
  fresh_leads: {
    tab: 'fresh-tab',
    tbody: 'freshLeadsTableBody',
    pagination: 'freshLeadsPagination',
    columns: ['uid', 'customer_name', 'customer_mobile_number', 'final_status', 'ps_name', 'created_at', 'branch']
  },
  walkin_leads: {
    tab: 'walkin-tab',
    tbody: 'walkinLeadsTableBody',
    pagination: 'walkinLeadsPagination',
    columns: ['uid', 'customer_name', 'customer_mobile_number', 'customer_email', 'model_interested', 'lead_source', 'status', 'ps_name', 'created_at']
  },
  cre_assigned_leads: {
    tab: 'creassigned-tab',
    tbody: 'creAssignedLeadsTableBody',
    pagination: 'creAssignedLeadsPagination',
    columns: ['customer_name', 'customer_mobile_number', 'final_status', 'uid', 'source', 'ps_assigned_at', 'ps_name']
  },
  pending_leads: {
    tab: 'pending-tab',
    tbody: 'pendingLeadsTableBody',
    pagination: 'pendingLeadsPagination',
    columns: ['uid', 'customer_name', 'customer_mobile_number', 'final_status', 'source', 'assigned_time', 'ps_name']
  },
  followup_leads: {
    tab: 'followup-tab',
    tbody: 'followupLeadsTableBody',
    pagination: 'followupLeadsPagination',
    columns: ['customer_name', 'customer_mobile_number', 'final_status', 'uid', 'source', 'lead_status', 'ps_name']
  },
  event_leads: {
    tab: 'event-tab',
    tbody: 'eventLeadsTableBody',
    pagination: 'eventLeadsPagination',
    columns: ['customer_name', 'customer_mobile_number', 'final_status', 'uid', 'source', 'lead_status', 'ps_name']
  },
  won_leads: {
    tab: 'won-tab',
    tbody: 'wonLeadsTableBody',
    pagination: 'wonLeadsPagination',
    columns: ['customer_name', 'customer_mobile_number', 'final_status', 'uid', 'source', 'lead_status', 'ps_name']
  },
  lost_leads: {
    tab: 'lost-tab',
    tbody: 'lostLeadsTableBody',
    pagination: 'lostLeadsPagination',
    columns: ['customer_name', 'customer_mobile_number', 'final_status', 'uid', 'source', 'lead_status', 'ps_name']
  }
};

function loadSection(section, page = 1, per_page = 25) {
  const config = sectionConfig[section];
  if (!config) return;
  const tbody = document.getElementById(config.tbody);
  if (tbody) tbody.innerHTML = `<tr><td colspan="${config.columns.length}">Loading...</td></tr>`;
  const filters = getUniversalFilters();
  fetch(`/api/branch_head_dashboard_data?section=${section}&page=${page}&per_page=${per_page}&ps_name=${filters.ps_name}&date_from=${filters.date_from}&date_to=${filters.date_to}`)
    .then(res => {
      if (!res.ok) throw new Error('API error');
      return res.json();
    })
    .then(data => {
      // Update all KPI counts
      updateAllKPIs(data);
      
      if (tbody) {
        if (data.rows && data.rows.length > 0) {
        tbody.innerHTML = '';
          data.rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = config.columns.map(col => `<td>${row[col] || ''}</td>`).join('');
            tbody.appendChild(tr);
          });
        } else {
          tbody.innerHTML = `<tr><td colspan="${config.columns.length}">No data found.</td></tr>`;
        }
      }
      
      // Pagination controls
      let pagDiv = document.getElementById(config.pagination);
      if (!pagDiv) {
        pagDiv = document.createElement('div');
        pagDiv.id = config.pagination;
        tbody.parentElement.appendChild(pagDiv);
      }
      let html = '';
      for (let p = 1; p <= data.total_pages; p++) {
        html += `<button onclick="loadSection('${section}', ${p}, ${data.per_page})" ${p === data.page ? 'disabled' : ''}>${p}</button> `;
      }
      pagDiv.innerHTML = html;
    })
    .catch(err => {
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="${config.columns.length}">Error loading data.</td></tr>`;
      }
      let pagDiv = document.getElementById(config.pagination);
      if (pagDiv) pagDiv.innerHTML = '';
    });
}



// Initial load
window.addEventListener('DOMContentLoaded', function() {
  // Load fresh leads by default
  loadSection('fresh_leads', 1);
  
  // Add click handlers for tab navigation
  document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener('click', function(e) {
      const target = this.getAttribute('href').substring(1);
      const section = target.replace('-', '_');
    loadSection(section, 1);
    });
  });
  // Fresh Leads rows per page Apply button
  const freshApplyBtn = document.getElementById('freshLeadsApplyBtn');
  if (freshApplyBtn) {
    freshApplyBtn.addEventListener('click', function() {
      const perPage = parseInt(document.getElementById('freshLeadsRowsPerPage').value, 10) || 25;
      loadSection('fresh_leads', 1, perPage);
    });
  }
  // Walk-in Leads rows per page Apply button
  const walkinApplyBtn = document.getElementById('walkinLeadsApplyBtn');
  if (walkinApplyBtn) {
    walkinApplyBtn.addEventListener('click', function() {
      const perPage = parseInt(document.getElementById('walkinLeadsRowsPerPage').value, 10) || 25;
      const uid = encodeURIComponent(document.getElementById('walkinLeadsUidSearch').value.trim());
      let url = `/api/branch_head_dashboard_data?section=walkin_leads&page=1&per_page=${perPage}`;
      if (uid) url += `&uid=${uid}`;
      loadSectionWithUrl('walkin_leads', url);
    });
  }
  const creAssignedApplyBtn = document.getElementById('creAssignedLeadsApplyBtn');
  if (creAssignedApplyBtn) {
    creAssignedApplyBtn.addEventListener('click', function() {
      const perPage = parseInt(document.getElementById('creAssignedLeadsRowsPerPage').value, 10) || 25;
      loadSection('cre_assigned_leads', 1, perPage);
    });
  }
  // Pending Leads rows per page Apply button
  const pendingApplyBtn = document.getElementById('pendingLeadsApplyBtn');
  if (pendingApplyBtn) {
    pendingApplyBtn.addEventListener('click', function() {
      const perPage = parseInt(document.getElementById('pendingLeadsRowsPerPage').value, 10) || 25;
      loadSection('pending_leads', 1, perPage);
    });
  }
  
  // Follow-up Leads rows per page Apply button
  const followupApplyBtn = document.getElementById('followupLeadsApplyBtn');
  if (followupApplyBtn) {
    followupApplyBtn.addEventListener('click', function() {
      const perPage = parseInt(document.getElementById('followupLeadsRowsPerPage').value, 10) || 25;
      loadSection('followup_leads', 1, perPage);
    });
  }
  
  // Event Leads rows per page Apply button
  const eventApplyBtn = document.getElementById('eventLeadsApplyBtn');
  if (eventApplyBtn) {
    eventApplyBtn.addEventListener('click', function() {
      const perPage = parseInt(document.getElementById('eventLeadsRowsPerPage').value, 10) || 25;
      loadSection('event_leads', 1, perPage);
    });
  }
  
  // Won Leads rows per page Apply button
  const wonApplyBtn = document.getElementById('wonLeadsApplyBtn');
  if (wonApplyBtn) {
    wonApplyBtn.addEventListener('click', function() {
      const perPage = parseInt(document.getElementById('wonLeadsRowsPerPage').value, 10) || 25;
      loadSection('won_leads', 1, perPage);
    });
  }
  
  // Lost Leads rows per page Apply button
  const lostApplyBtn = document.getElementById('lostLeadsApplyBtn');
  if (lostApplyBtn) {
    lostApplyBtn.addEventListener('click', function() {
      const perPage = parseInt(document.getElementById('lostLeadsRowsPerPage').value, 10) || 25;
      loadSection('lost_leads', 1, perPage);
    });
  }
});

// Add a helper to load section with a custom URL for walk-in leads
function loadSectionWithUrl(section, url) {
  const config = sectionConfig[section];
  const tbody = document.getElementById(config.tbody);
  if (tbody) tbody.innerHTML = `<tr><td colspan="${config.columns.length}">Loading...</td></tr>`;
  fetch(url)
    .then(res => {
      if (!res.ok) throw new Error('API error');
      return res.json();
    })
    .then(data => {
      if (tbody) {
        if (data.rows && data.rows.length > 0) {
          tbody.innerHTML = '';
          data.rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = config.columns.map(col => `<td>${row[col] || ''}</td>`).join('');
            tbody.appendChild(tr);
          });
        } else {
          tbody.innerHTML = `<tr><td colspan="${config.columns.length}">No data found.</td></tr>`;
        }
      }
      // Pagination controls
      let pagDiv = document.getElementById(config.pagination);
      if (!pagDiv) {
        pagDiv = document.createElement('div');
        pagDiv.id = config.pagination;
        tbody.parentElement.appendChild(pagDiv);
      }
      let html = '';
      for (let p = 1; p <= data.total_pages; p++) {
        html += `<button onclick="loadSectionWithUrl('${section}', '${url.replace(/page=\d+/, 'page=' + p)}')" ${p === data.page ? 'disabled' : ''}>${p}</button> `;
      }
      pagDiv.innerHTML = html;
    })
    .catch(err => {
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="${config.columns.length}">No data found.</td></tr>`;
      }
      let pagDiv = document.getElementById(config.pagination);
      if (pagDiv) pagDiv.innerHTML = '';
    });
}

// Load Branch Head dashboards
function loadBranchHeadDashboards() {
    fetch('/api/dashboards')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.dashboards['branch-head']) {
                const container = document.getElementById('branchHeadDashboardsContainer');
                let html = '';
                
                data.dashboards['branch-head'].forEach(dashboard => {
                    html += `
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${dashboard.name}</h6>
                                <small class="text-muted">Added: ${new Date(dashboard.created_at).toLocaleDateString()}</small>
                            </div>
                            <div class="card-body p-0">
                                <iframe src="${dashboard.url}" 
                                        style="width: 100%; height: 800px; border: none;" 
                                        frameborder="0">
                                </iframe>
                            </div>
                        </div>
                    `;
                });
                
                if (html === '') {
                    html = '<div class="text-center text-muted py-4"><i class="fas fa-chart-bar fa-3x mb-3"></i><p>No Branch Head dashboards configured yet.</p></div>';
                }
                
                container.innerHTML = html;
            } else {
                console.log('No Branch Head dashboards found in response'); // Debug log
                console.log('Response data:', data); // Debug log
                const container = document.getElementById('branchHeadDashboardsContainer');
                container.innerHTML = `<div class="text-center text-muted py-4">
                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                    <p>No Branch Head dashboards configured yet.</p>
                    <small class="text-muted">Debug: Response received but no Branch Head dashboards found</small>
                </div>`;
            }
        })
        .catch(error => {
            console.error('Error loading Branch Head dashboards:', error);
            const container = document.getElementById('branchHeadDashboardsContainer');
            container.innerHTML = `<div class="text-center text-danger py-4">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>Error loading dashboards. Please try again.</p>
            </div>`;
        });
}

// Load dashboards on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBranchHeadDashboards();
    
    // Load fresh leads by default
    loadSection('fresh_leads');
    
    // Add click handlers for tab navigation
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('click', function(e) {
            const target = this.getAttribute('href').substring(1);
            const section = target.replace('-', '_');
            loadSection(section);
        });
    });
});
</script>
{% endblock %} 