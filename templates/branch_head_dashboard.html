{% extends "base.html" %}
{% block title %}Branch Head Dashboard - Ather CRM{% endblock %}

{% block head %}
<style>
    /* Centered full-width layout with proper spacing */
    .container-main, .container, .container-fluid {
        max-width: 100% !important;
        width: 100% !important;
        margin: 0 auto !important;
        padding: 0 2rem !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        border: none !important;
    }
    
    /* Main content area with proper centering */
    .w-100 {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 auto !important;
        padding: 0 2rem !important;
        overflow-x: hidden !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
    }
    
    /* Tab content with proper centering */
    .tab-content, .tab-pane {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 auto !important;
        padding: 0 1rem !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
    }
    
    /* Card containers with proper centering */
    .card {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 auto 1rem auto !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
        transition: all 0.3s ease !important;
    }
    
    .card-body {
        width: 100% !important;
        max-width: 100% !important;
        padding: 1.5rem !important;
        overflow-x: hidden !important;
    }
    
    /* Table container with proper centering and full width */
    .table-responsive {
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: visible !important;
        margin: 0 auto !important;
        padding: 0 !important;
        border: none !important;
        display: flex !important;
        justify-content: center !important;
    }
    
    /* Tables with proper centering and column sizing */
    .table {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 100% !important;
        table-layout: auto !important;
        margin: 0 auto !important;
        border-collapse: collapse !important;
    }
    
    /* Table header and cells with better spacing */
    .table thead th,
    .table tbody td {
        width: auto !important;
        min-width: auto !important;
        max-width: none !important;
        white-space: nowrap !important;
        overflow: visible !important;
        text-overflow: clip !important;
        padding: 0.75rem 0.75rem !important;
        border: 1px solid #dee2e6 !important;
        text-align: center !important;
    }
    
    /* Optimized column widths for better fit */
    .table th:nth-child(1), .table td:nth-child(1) { min-width: 120px; }  /* UID */
    .table th:nth-child(2), .table td:nth-child(2) { min-width: 150px; }  /* Customer Name */
    .table th:nth-child(3), .table td:nth-child(3) { min-width: 130px; }  /* Phone No. */
    .table th:nth-child(4), .table td:nth-child(4) { min-width: 120px; }  /* Final Status/Source */
    .table th:nth-child(5), .table td:nth-child(5) { min-width: 140px; }  /* PS Name */
    .table th:nth-child(6), .table td:nth-child(6) { min-width: 120px; }  /* Source/Lead Category */
    .table th:nth-child(7), .table td:nth-child(7) { min-width: 120px; }  /* Lead Category/Lead Status */
    .table th:nth-child(8), .table td:nth-child(8) { min-width: 140px; }  /* PS Assigned At/Follow-up Date */
    .table th:nth-child(9), .table td:nth-child(9) { min-width: 140px; }  /* Created At */
    .table th:nth-child(10), .table td:nth-child(10) { min-width: 120px; } /* Call History */
    
    /* Better spacing for full width layout */
    .row {
        margin-left: 0 !important;
        margin-right: 0 !important;
        width: 100% !important;
    }
    
    .col, .col-md-3, .col-md-4, .col-md-2, .col-auto {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
    }
    
    /* KPI cards better spacing for full width */
    .card-body.p-2 {
        padding: 1rem !important;
    }
    
    /* Tab navigation full width */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        width: 100% !important;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        padding: 0.5rem 0.5rem 0;
        margin: 0 !important;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-radius: 6px 6px 0 0;
        color: #6c757d;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
        margin-right: 0.25rem;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: #007bff;
        color: #007bff;
        background: rgba(0, 123, 255, 0.1);
    }
    
    .nav-tabs .nav-link.active {
        border-color: #007bff;
        color: #007bff;
        background: white;
        border-bottom: 2px solid #007bff;
    }
    
    /* Enhanced dashboard styling for full width */
    .dashboard-header {
        background: linear-gradient(135deg, var(--airbnb-gray-100) 0%, var(--airbnb-white) 100%);
        border: 1px solid var(--airbnb-gray-200);
        border-radius: var(--airbnb-border-radius);
        margin-bottom: 1.5rem;
        width: 100% !important;
    }
    
    /* KPI cards enhanced for full width */
    .kpi-card {
        background: var(--airbnb-white);
        border: 1px solid var(--airbnb-gray-200);
        border-radius: var(--airbnb-border-radius);
        transition: all 0.3s ease;
        height: 100%;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        width: 100% !important;
    }
    
    /* Loading spinner styling */
    .fa-spinner {
        margin-right: 0.5rem;
    }
    
    /* KPI loading state */
    .kpi-card .d-none {
        display: none !important;
    }
    
    /* Lead Category styling */
    .lead-category-not-set {
        background-color: #f8d7da;
        color: #721c24;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    /* Export section styling */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }
    
    .bg-gradient-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    }
    
    .card-header.bg-gradient-primary {
        border-bottom: none;
    }
    
    .form-control-lg, .form-select-lg {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .form-control-lg:focus, .form-select-lg:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .btn-lg {
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-lg:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .btn-group-vertical .btn {
        border-radius: 8px !important;
        margin-bottom: 0.5rem;
    }
    
    .btn-group-vertical .btn:last-child {
        margin-bottom: 0;
    }
    
    /* Export section responsive */
    @media (max-width: 768px) {
        .btn-group-vertical {
            flex-direction: row;
            gap: 0.5rem;
        }
        
        .btn-group-vertical .btn {
            flex: 1;
            margin-bottom: 0;
        }
    }
    
    .kpi-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--airbnb-shadow-hover);
        border-color: var(--airbnb-gray-300);
    }
    
    /* Clean table styling with full width */
    .table {
        margin-bottom: 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-collapse: collapse !important;
    }
    
    /* Table header styling */
    .table thead th {
        background: linear-gradient(135deg, #495057 0%, #343a40 100%);
        color: white;
        border: none;
        font-weight: 600;
        padding: 1rem 0.75rem;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        text-align: center;
    }
    
    /* Table body styling */
    .table tbody tr {
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
        transform: scale(1.001);
    }
    
    .table tbody td {
        padding: 0.75rem;
        vertical-align: middle;
        border-color: #e9ecef;
        text-align: center;
    }
    
    /* Table-sm specific styling */
    .table.table-sm {
        font-size: 0.875rem;
    }
    
    .table.table-sm th, .table.table-sm td {
        padding: 0.5rem 0.75rem;
    }
    
    /* Additional table width optimizations */
    .card-body {
        padding: 1rem !important;
        overflow-x: hidden !important;
    }
    
    /* Ensure no horizontal scroll on main container */
    .w-100 {
        overflow-x: hidden !important;
    }
    
    /* Table container optimizations */
    .table-responsive {
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
    }
    
    /* Remove any potential horizontal margins */
    .row {
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    
    .col, .col-md-3, .col-md-4, .col-md-2, .col-auto {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
    }
    
    .table thead th {
        background: linear-gradient(135deg, #495057 0%, #343a40 100%);
        color: white;
        border: none;
        font-weight: 600;
        padding: 1rem 0.75rem;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        text-align: center;
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
        transform: scale(1.001);
    }
    
    .table tbody td {
        padding: 0.75rem;
        vertical-align: middle;
        border-color: #e9ecef;
        text-align: center;
    }
    
    /* Filter section styling */
    .filter-section {
        background: var(--airbnb-gray-50);
        border: 1px solid var(--airbnb-gray-200);
        border-radius: var(--airbnb-border-radius);
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    /* Zoho Dashboard iframe styling for responsive height */
    .dashboard-iframe {
        width: 100%;
        height: 70vh;
        min-height: 600px;
        max-height: 900px;
        border: none;
        border-radius: 0;
        box-shadow: none;
    }
    
    .dashboard-card {
        margin-bottom: 1rem;
        border: 1px solid var(--airbnb-gray-200);
        border-radius: var(--airbnb-border-radius);
        overflow: hidden;
    }
    
    .dashboard-card .card-header {
        background: var(--airbnb-gray-100);
        border-bottom: 1px solid var(--airbnb-gray-200);
        padding: 0.75rem 1rem;
    }
    
    .dashboard-card .card-body {
        padding: 0;
    }
    
    /* Responsive design for mobile */
    @media (max-width: 768px) {
        .col-md-3, .col-md-4, .col-md-2 {
            margin-bottom: 0.5rem;
        }
        
        .nav-tabs .nav-link {
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }
        
        .kpi-card {
            min-height: 100px;
        }
        
        .kpi-card .h5 {
            font-size: 1.1rem;
        }
        
        .dashboard-iframe {
            height: 60vh;
            min-height: 500px;
            max-height: 700px;
        }
    }
    
    /* CRITICAL: Force tables to use full width and show all columns */
    .table-responsive {
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: visible !important;
        margin: 0 auto !important;
        padding: 0 !important;
    }
    
    .table-responsive > .table {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
        table-layout: auto !important;
        margin: 0 auto !important;
    }
    
    /* Ensure all table cells are visible */
    .table th, .table td {
        white-space: nowrap !important;
        overflow: visible !important;
        text-overflow: clip !important;
        min-width: auto !important;
        max-width: none !important;
    }
    
    /* Specific column widths for optimal desktop layout */
    .table th:nth-child(1), .table td:nth-child(1) { min-width: 120px; }  /* UID */
    .table th:nth-child(2), .table td:nth-child(2) { min-width: 150px; }  /* Customer Name */
    .table th:nth-child(3), .table td:nth-child(3) { min-width: 130px; }  /* Phone No. */
    .table th:nth-child(4), .table td:nth-child(4) { min-width: 120px; }  /* Final Status/Source */
    .table th:nth-child(5), .table td:nth-child(5) { min-width: 140px; }  /* PS Name */
    .table th:nth-child(6), .table td:nth-child(6) { min-width: 120px; }  /* Source/Lead Category */
    .table th:nth-child(7), .table td:nth-child(7) { min-width: 120px; }  /* Lead Category/Lead Status */
    .table th:nth-child(8), .table td:nth-child(8) { min-width: 140px; }  /* PS Assigned At/Follow-up Date */
    .table th:nth-child(9), .table td:nth-child(9) { min-width: 140px; }  /* Created At */
    .table th:nth-child(10), .table td:nth-child(10) { min-width: 120px; } /* Call History */
    
    /* Call Attempt History Modal specific fixes */
    #callAttemptHistoryModal .modal-dialog {
        max-width: 95vw !important;
        width: 95vw !important;
        margin: 1rem auto !important;
    }
    
    #callAttemptHistoryModal .modal-content {
        width: 100% !important;
        max-width: 100% !important;
    }
    
    #callAttemptHistoryModal .table-responsive {
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: visible !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    #callAttemptHistoryModal .table {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 100% !important;
        table-layout: auto !important;
        margin: 0 !important;
    }
    
    #callAttemptHistoryModal .table th,
    #callAttemptHistoryModal .table td {
        white-space: nowrap !important;
        overflow: visible !important;
        text-overflow: clip !important;
        padding: 0.5rem 0.75rem !important;
        border: 1px solid #dee2e6 !important;
        text-align: center !important;
        min-width: auto !important;
        max-width: none !important;
    }
    
    /* Modal table column widths for better visibility */
    #callAttemptHistoryModal .table th:nth-child(1), #callAttemptHistoryModal .table td:nth-child(1) { min-width: 120px; }  /* UID */
    #callAttemptHistoryModal .table th:nth-child(2), #callAttemptHistoryModal .table td:nth-child(2) { min-width: 100px; }  /* Call No */
    #callAttemptHistoryModal .table th:nth-child(3), #callAttemptHistoryModal .table td:nth-child(3) { min-width: 80px; }   /* Attempt */
    #callAttemptHistoryModal .table th:nth-child(4), #callAttemptHistoryModal .table td:nth-child(4) { min-width: 140px; } /* Status */
    #callAttemptHistoryModal .table th:nth-child(5), #callAttemptHistoryModal .table td:nth-child(5) { min-width: 80px; }   /* Role */
    #callAttemptHistoryModal .table th:nth-child(6), #callAttemptHistoryModal .table td:nth-child(6) { min-width: 150px; } /* Name */
    #callAttemptHistoryModal .table th:nth-child(7), #callAttemptHistoryModal .table td:nth-child(7) { min-width: 160px; } /* Timestamp */
    #callAttemptHistoryModal .table th:nth-child(8), #callAttemptHistoryModal .table td:nth-child(8) { min-width: 120px; } /* Remarks */
    #callAttemptHistoryModal .table td:nth-child(9) { min-width: 120px; } /* Follow-up Date */
    
    /* Enhanced status column visibility and styling */
    #callAttemptHistoryModal .table td:nth-child(4) {
        color: #333 !important;
        font-weight: 600 !important;
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6 !important;
        padding: 0.75rem !important;
        text-align: center !important;
        border-radius: 6px !important;
    }
    
    /* Status-specific colors for better visibility */
    #callAttemptHistoryModal .table td:nth-child(4)[data-status*="disconnected"] {
        color: #721c24 !important;
        background-color: #f8d7da !important;
        border-color: #f5c6cb !important;
    }
    
    #callAttemptHistoryModal .table td:nth-child(4)[data-status*="connected"] {
        color: #155724 !important;
        background-color: #d4edda !important;
        border-color: #c3e6cb !important;
    }
    
    #callAttemptHistoryModal .table td:nth-child(4)[data-status*="rnr"] {
        color: #856404 !important;
        background-color: #fff3cd !important;
        border-color: #ffeaa7 !important;
    }
    
    #callAttemptHistoryModal .table td:nth-child(4)[data-status*="busy"] {
        color: #721c24 !important;
        background-color: #f8d7da !important;
        border-color: #f5c6cb !important;
    }
    
    #callAttemptHistoryModal .table td:nth-child(4)[data-status*="interested"] {
        color: #155724 !important;
        background-color: #d4edda !important;
        border-color: #c3e6cb !important;
    }
    
    #callAttemptHistoryModal .table td:nth-child(4)[data-status*="not interested"] {
        color: #721c24 !important;
        background-color: #f8d7da !important;
        border-color: #f5c6cb !important;
    }
    
    /* Additional status cell styling for better visibility */
    #callAttemptHistoryModal .status-cell {
        font-size: 0.9rem !important;
        letter-spacing: 0.5px !important;
        text-transform: uppercase !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        transition: all 0.3s ease !important;
    }
    
    #callAttemptHistoryModal .status-cell:hover {
        transform: scale(1.02) !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    
    /* Specific styling for common statuses */
    #callAttemptHistoryModal .status-cell[data-status*="disconnected"] {
        color: #721c24 !important;
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%) !important;
        border: 2px solid #f5c6cb !important;
    }
    
    #callAttemptHistoryModal .status-cell[data-status*="connected"] {
        color: #155724 !important;
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
        border: 2px solid #c3e6cb !important;
    }
    
    #callAttemptHistoryModal .status-cell[data-status*="interested"] {
        color: #155724 !important;
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
        border: 2px solid #c3e6cb !important;
    }
    
    /* Additional modal optimizations */
    #callAttemptHistoryModal .modal-body {
        padding: 1.5rem !important;
        overflow-x: auto !important;
    }
    
    #callAttemptHistoryModal .table-responsive {
        overflow-x: auto !important;
        max-width: 100% !important;
    }
    
    /* Ensure modal table doesn't get cut off */
    #callAttemptHistoryModal .table {
        min-width: max-content !important;
        width: max-content !important;
    }
    
    /* Modal body scroll optimization */
    #callAttemptHistoryModal .modal-body {
        max-height: 70vh !important;
        overflow-y: auto !important;
    }
    
    /* Modal table container optimization */
    #callAttemptHistoryModal .table-responsive {
        max-height: 60vh !important;
        overflow-y: auto !important;
    }
    
    /* Ensure all modal content is visible */
    #callAttemptHistoryModal {
        z-index: 9999 !important;
    }
    
    #callAttemptHistoryModal .modal-dialog {
        max-height: 90vh !important;
        margin: 2rem auto !important;
    }
    
    /* Modern, clean UI enhancements */
    .card {
        border: 1px solid #e9ecef !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
        transition: all 0.3s ease !important;
    }
    
    .card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.12) !important;
        transform: translateY(-2px) !important;
    }
    
    .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        border-bottom: 1px solid #dee2e6 !important;
        border-radius: 12px 12px 0 0 !important;
        font-weight: 600 !important;
        color: #495057 !important;
    }
    
    /* Enhanced filter section */
    .filter-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%) !important;
        border: 1px solid #e9ecef !important;
        border-radius: 12px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
    }
    
    /* Modern button styling */
    .btn {
        border-radius: 8px !important;
        font-weight: 500 !important;
        transition: all 0.3s ease !important;
        border: none !important;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3) !important;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.4) !important;
    }
    
    /* Enhanced search inputs */
    .form-control, .form-select {
        border-radius: 8px !important;
        border: 2px solid #e9ecef !important;
        transition: all 0.3s ease !important;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #007bff !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15) !important;
    }
    
    /* Final optimization: ensure main content uses full desktop width with centering */
    body, html {
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
    }
    
    /* Override any Bootstrap container constraints with centering */
    .container, .container-fluid, .container-lg, .container-xl, .container-xxl {
        max-width: 100% !important;
        width: 100% !important;
        margin: 0 auto !important;
        padding: 0 2rem !important;
    }
    
    /* Ensure tab content uses full width with centering */
    .tab-content > .tab-pane {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 auto !important;
        padding: 0 1rem !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
    }
    
    /* Additional centering for better layout */
    .nav-tabs {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        width: 100% !important;
    }
    
    .filter-section {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        width: 100% !important;
    }
    
    .input-group, .form-select, .btn-group {
        margin: 0 auto !important;
        display: flex !important;
        justify-content: center !important;
    }
    
    /* KPI cards centering */
    .kpi-card {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        text-align: center !important;
    }
    
    /* Dashboard header centering */
    .dashboard-header {
        text-align: center !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
    }
    
    /* CRITICAL: Ensure JavaScript can access DOM elements */
    .tab-pane {
        display: none !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .tab-pane.active {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .tab-pane.show {
        display: block !important;
    }
    
    .tab-pane.fade {
        transition: opacity 0.15s linear !important;
    }
    
    .tab-pane.fade.show {
        opacity: 1 !important;
    }
    
    /* Bootstrap tab functionality fix */
    .tab-content > .tab-pane {
        display: none !important;
    }
    
    .tab-content > .active {
        display: block !important;
    }
    
    /* Ensure tab navigation works */
    .nav-tabs .nav-link {
        cursor: pointer !important;
        user-select: none !important;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #007bff !important;
        color: white !important;
        border-color: #007bff !important;
    }
    
    /* Fix for table loading issues */
    .table-responsive {
        min-height: 200px !important;
        position: relative !important;
    }
    
    .table-responsive:empty::after {
        content: "Loading..." !important;
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        color: #6c757d !important;
        font-style: italic !important;
    }
    
    /* Ensure form elements are accessible */
    .form-control, .form-select, .btn {
        position: relative !important;
        z-index: 1 !important;
    }
    
    /* Additional table width optimizations */
    .card-body {
        padding: 1rem;
        overflow-x: hidden;
    }
    
    /* PS Follow-up Summary Table specific styling */
    #psFollowupTable {
        font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 0.875rem;
        font-weight: 400;
        line-height: 1.5;
        width: 100%;
        table-layout: auto;
    }
    
    #psFollowupTable th {
        font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        line-height: 1.4;
        padding: 0.5rem 0.25rem;
        vertical-align: middle;
        white-space: nowrap;
        min-width: auto;
    }
    
    #psFollowupTable td {
        font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 0.8rem;
        font-weight: 400;
        line-height: 1.4;
        padding: 0.5rem 0.25rem;
        vertical-align: middle;
        white-space: nowrap;
    }
    
    #psFollowupTable .badge {
        font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 0.7rem;
        font-weight: 500;
        line-height: 1.3;
        padding: 0.25rem 0.5rem;
    }
    
    /* Enhanced table responsiveness for desktop */
    #psFollowupTable .table-responsive {
        overflow-x: auto;
        max-width: 100%;
    }
    
    /* Inline leads table styling */
    #psFollowupTable .ps-inline-details .table {
        font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 0.8rem;
        font-weight: 400;
        line-height: 1.4;
        margin: 0;
    }
    
    #psFollowupTable .ps-inline-details .table th,
    #psFollowupTable .ps-inline-details .table td {
        font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 0.75rem;
        font-weight: 400;
        line-height: 1.4;
        padding: 0.4rem 0.3rem;
        white-space: nowrap;
        vertical-align: middle;
    }
    
    /* Ensure proper column widths for the new columns */
    #psFollowupTable .ps-inline-details .table th:nth-child(6),
    #psFollowupTable .ps-inline-details .table td:nth-child(6) {
        min-width: 120px; /* PS Assigned At */
    }
    
    #psFollowupTable .ps-inline-details .table th:nth-child(7),
    #psFollowupTable .ps-inline-details .table td:nth-child(7) {
        min-width: 120px; /* Created At */
    }
    
    /* Sub-column header styling */
    #psFollowupTable th.small {
        font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 0.7rem;
        font-weight: 600;
        line-height: 1.3;
        padding: 0.25rem 0.1rem;
        border-left: 1px solid #dee2e6;
        border-right: 1px solid #dee2e6;
        white-space: nowrap;
        min-width: 80px;
    }
    
    /* Main PS followup table responsiveness */
    #psFollowupTable {
        min-width: max-content;
        width: 100%;
    }
    
    #psFollowupTable .table-responsive {
        overflow-x: auto;
        overflow-y: visible;
    }
    
    /* Ensure the table container can handle horizontal scroll */
    .card-body .table-responsive {
        max-width: 100%;
        overflow-x: auto;
    }
    
    /* Enhanced styling for the new timestamp columns - now with uniform font */
    #psFollowupTable .ps-inline-details .table td:nth-child(6),
    #psFollowupTable .ps-inline-details .table td:nth-child(7) {
        font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 0.7rem;
        font-weight: 400;
        line-height: 1.3;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        text-align: center;
    }
    
    /* Source column styling */
    #psFollowupTable .ps-inline-details .table td:nth-child(5) {
        text-align: center;
    }
    
    /* Ensure proper spacing for all columns */
    #psFollowupTable .ps-inline-details .table th,
    #psFollowupTable .ps-inline-details .table td {
        border: 1px solid #dee2e6;
    }
    
    /* Responsive breakpoints for better desktop experience */
    @media (min-width: 1200px) {
        #psFollowupTable .ps-inline-details .table {
            font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.85rem;
            font-weight: 400;
            line-height: 1.4;
        }
        
        #psFollowupTable .ps-inline-details .table th,
        #psFollowupTable .ps-inline-details .table td {
            font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.8rem;
            font-weight: 400;
            line-height: 1.4;
            padding: 0.5rem 0.4rem;
        }
    }
    
    /* Additional responsive design for better desktop experience */
    @media (min-width: 1400px) {
        #psFollowupTable .ps-inline-details .table {
            font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            line-height: 1.4;
        }
        
        #psFollowupTable .ps-inline-details .table th,
        #psFollowupTable .ps-inline-details .table td {
            font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.85rem;
            font-weight: 400;
            line-height: 1.4;
            padding: 0.6rem 0.5rem;
        }
        
        /* Ensure proper column spacing on large screens */
        #psFollowupTable .ps-inline-details .table th:nth-child(6),
        #psFollowupTable .ps-inline-details .table td:nth-child(6),
        #psFollowupTable .ps-inline-details .table th:nth-child(7),
        #psFollowupTable .ps-inline-details .table td:nth-child(7) {
            min-width: 140px;
        }
    }
    
    /* Ensure horizontal scroll works properly on all screen sizes */
    #psFollowupTable .table-responsive {
        scrollbar-width: thin;
        scrollbar-color: #6c757d #f8f9fa;
    }
    
    #psFollowupTable .table-responsive::-webkit-scrollbar {
        height: 8px;
    }
    
    #psFollowupTable .table-responsive::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 4px;
    }
    
    #psFollowupTable .table-responsive::-webkit-scrollbar-thumb {
        background: #6c757d;
        border-radius: 4px;
    }
    
    #psFollowupTable .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #495057;
    }
    
    /* Timestamp column styling for better readability - now with uniform font */
    #followupLeadsTable th:nth-child(8),
    #followupLeadsTable th:nth-child(9) {
        min-width: 140px;
        white-space: nowrap;
    }
    
    #followupLeadsTable td:nth-child(8),
    #followupLeadsTable td:nth-child(9) {
        font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 0.85rem;
        font-weight: 400;
        line-height: 1.4;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        text-align: center;
        white-space: nowrap;
    }
    
    /* Responsive adjustments for timestamp columns */
    @media (max-width: 1400px) {
        #followupLeadsTable th:nth-child(8),
        #followupLeadsTable th:nth-child(9) {
            min-width: 120px;
            font-size: 0.8rem;
        }
        
        #followupLeadsTable td:nth-child(8),
        #followupLeadsTable td:nth-child(9) {
            font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.75rem;
            font-weight: 400;
            line-height: 1.4;
            padding: 0.25rem 0.5rem;
        }
    }
    
    /* Follow-up level headers */
    #psFollowupTable th[colspan="2"] {
        font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        line-height: 1.4;
        background: linear-gradient(135deg, #495057 0%, #343a40 100%);
        color: white;
        text-align: center;
        border: 1px solid #dee2e6;
    }
    
    /* Clickable cell styling */
    #psFollowupTable .clickable-cell {
        font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 0.8rem;
        font-weight: 400;
        line-height: 1.4;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    #psFollowupTable .clickable-cell:hover {
        background-color: #f8f9fa !important;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 10;
        position: relative;
    }
    
    #psFollowupTable .clickable-cell:active {
        transform: scale(0.98);
    }
</style>
{% endblock %}

{% block content %}
<!-- Full width layout without container constraints -->
<div class="w-100">
    <!-- Dashboard Header -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-1">
                        <i class="fas fa-chart-line me-2"></i>
                        Branch Head Dashboard
                    </h2>
                    <p class="text-muted mb-0">
                        Welcome back, {{ session.get('branch_head_name', 'Branch Head') }} | 
                        Branch: <strong>{{ session.get('branch_head_branch', 'N/A') }}</strong>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex justify-content-end align-items-center">
                        <span class="text-muted me-3">
                            <i class="fas fa-clock me-1"></i>
                            <span id="currentDateTime"></span>
                        </span>
                        <button class="btn btn-outline-info btn-sm" onclick="showPerformanceStats()" title="View Performance Statistics">
                            <i class="fas fa-tachometer-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    




    <!-- Branch Summary KPI Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card kpi-card border-primary">
                <div class="card-body p-3 text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="fas fa-users fa-2x text-primary me-3"></i>
                        <div>
                            <h3 class="mb-0" id="totalLeadsAssigned">-</h3>
                            <small class="text-muted">Total Leads Assigned</small>
                        </div>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card kpi-card border-warning">
                <div class="card-body p-3 text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="fas fa-clock fa-2x text-warning me-3"></i>
                        <div>
                            <h3 class="mb-0" id="totalPendingLeads">-</h3>
                            <small class="text-muted">Pending Leads</small>
                        </div>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card kpi-card border-success">
                <div class="card-body p-3 text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="fas fa-trophy fa-2x text-success me-3"></i>
                        <div>
                            <h3 class="mb-0" id="totalWonLeads">-</h3>
                            <small class="text-muted">Won Leads</small>
                        </div>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card kpi-card border-danger">
                <div class="card-body p-3 text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="fas fa-times-circle fa-2x text-danger me-3"></i>
                        <div>
                            <h3 class="mb-0" id="totalLostLeads">-</h3>
                            <small class="text-muted">Lost Leads</small>
                        </div>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="card mb-4">
        <div class="card-body p-0">
            <ul class="nav nav-tabs" id="leadTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="analytics-tab" data-bs-toggle="tab" href="#analytics" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>Analytics Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="followup-tab" data-bs-toggle="tab" href="#followup" role="tab">
                        <i class="fas fa-calendar-check me-2"></i>Today's Follow-ups
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="fresh-tab" data-bs-toggle="tab" href="#fresh" role="tab">
                        <i class="fas fa-users me-2"></i>All Leads
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="fresh-leads-tab" data-bs-toggle="tab" href="#fresh-leads" role="tab">
                        <i class="fas fa-star me-2"></i>Fresh Leads
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="export-tab" data-bs-toggle="tab" href="#export" role="tab">
                        <i class="fas fa-file-export me-2"></i>Export Leads
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="tab-content" id="leadTabsContent">
        <!-- Analytics Dashboard Tab -->
        <div class="tab-pane fade show active" id="analytics" role="tabpanel">
            <!-- Global Analytics Filter -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Analytics Filter
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="analyticsDateFrom" class="form-label fw-semibold">From Date:</label>
                            <input type="date" id="analyticsDateFrom" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="analyticsDateTo" class="form-label fw-semibold">To Date:</label>
                            <input type="date" id="analyticsDateTo" class="form-control">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button id="applyAnalyticsFilter" class="btn btn-primary me-2">
                                <i class="fas fa-search me-1"></i>Apply Filter
                            </button>
                            <button id="resetAnalyticsFilter" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Specialist Performance Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Product Specialist Performance
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="psPerformanceTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Product Specialist</th>
                                    <th>Leads Assigned (ps_assigned_at)</th>
                                    <th>Leads Contacted (lead_status not null)</th>
                                    <th>Gap (Assigned - Contacted)</th>
                                </tr>
                            </thead>
                            <tbody id="psPerformanceTableBody">
                                <tr><td colspan="4" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Source-wise Leads Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Source-wise Leads Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="sourceLeadsTable">
                            <thead class="thead-dark" id="sourceLeadsTableHead">
                                <tr>
                                    <th>Product Specialist</th>
                                    <th>Total Leads</th>
                                    <th>Won Leads</th>
                                    <th>Win Rate (%)</th>
                                    <!-- Dynamic source columns will be added here -->
                                </tr>
                            </thead>
                            <tbody id="sourceLeadsTableBody">
                                <tr><td colspan="4" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Walk-in Leads Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-store me-2"></i>Walk-in Leads Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="walkinLeadsTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Product Specialist</th>
                                    <th>Total Walk-in Leads</th>
                                    <th>Pending Leads</th>
                                    <th>Lost Leads</th>
                                    <th>Won Leads</th>
                                    <th>Today's Follow-ups</th>
                                </tr>
                            </thead>
                            <tbody id="walkinLeadsTableBody">
                                <tr><td colspan="6" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Product Specialist Follow-up Summary Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Product Specialist Follow-up Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="psFollowupTable">
                            <thead class="table-dark">
                                <tr>
                                    <th rowspan="2" class="align-middle">PS Name</th>
                                    <th colspan="2" class="text-center">F1</th>
                                    <th colspan="2" class="text-center">F2</th>
                                    <th colspan="2" class="text-center">F3</th>
                                    <th colspan="2" class="text-center">F4</th>
                                    <th colspan="2" class="text-center">F5</th>
                                    <th colspan="2" class="text-center">F6</th>
                                    <th colspan="2" class="text-center">F7</th>
                                </tr>
                                <tr>
                                    <!-- F1 sub-columns -->
                                    <th class="text-center small">CRE</th>
                                    <th class="text-center small">Walk-in</th>
                                    <!-- F2 sub-columns -->
                                    <th class="text-center small">CRE</th>
                                    <th class="text-center small">Walk-in</th>
                                    <!-- F3 sub-columns -->
                                    <th class="text-center small">CRE</th>
                                    <th class="text-center small">Walk-in</th>
                                    <!-- F4 sub-columns -->
                                    <th class="text-center small">CRE</th>
                                    <th class="text-center small">Walk-in</th>
                                    <!-- F5 sub-columns -->
                                    <th class="text-center small">CRE</th>
                                    <th class="text-center small">Walk-in</th>
                                    <!-- F6 sub-columns -->
                                    <th class="text-center small">CRE</th>
                                    <th class="text-center small">Walk-in</th>
                                    <!-- F7 sub-columns -->
                                    <th class="text-center small">CRE</th>
                                    <th class="text-center small">Walk-in</th>
                                </tr>
                            </thead>
                            <tbody id="psFollowupTableBody">
                                <tr><td colspan="15" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Lead Details Modal -->
            <div class="modal fade" id="leadDetailsModal" tabindex="-1" aria-labelledby="leadDetailsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="leadDetailsModalLabel">Lead Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="leadDetailsContent">
                                <!-- Lead details will be loaded here -->
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Branch Head Dashboards -->
            <div class="card mb-3">
                <div class="card-body">
                    <div id="branchHeadDashboardsContainer">
                        <!-- Branch Head dashboards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- All Leads Tab -->
        <div class="tab-pane fade" id="fresh" role="tabpanel">
            <div class="card mb-2">
                <div class="card-body p-3">
                    <!-- Section-specific Filter Controls -->
                    <div class="filter-section mb-2">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label for="freshLeadsPsSelect" class="fw-semibold small">Product Specialist:</label>
                                <select id="freshLeadsPsSelect" class="form-select form-select-sm">
                                    <option value="">-- All PS --</option>
                                    {% for ps in ps_users %}
                                        <option value="{{ ps.name }}">{{ ps.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="freshLeadsStatusSelect" class="fw-semibold small">Final Status:</label>
                                <select id="freshLeadsStatusSelect" class="form-select form-select-sm">
                                    <option value="">-- All Statuses --</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Won">Won</option>
                                    <option value="Lost">Lost</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="freshLeadsDateFilter" class="fw-semibold small">Date Filter:</label>
                                <select id="freshLeadsDateFilter" class="form-select form-select-sm">
                                    <option value="">-- All Time --</option>
                                    <option value="today">Today</option>
                                    <option value="date_range">Date Range</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button id="freshLeadsApplyFiltersBtn" class="btn btn-primary btn-sm me-2">Apply</button>
                                <button id="freshLeadsResetFiltersBtn" class="btn btn-outline-secondary btn-sm">Reset</button>
                            </div>
                        </div>
                        <!-- Date Range Row - Hidden by default -->
                        <div class="row g-2 mt-2" id="dateRangeRow" style="display: none;">
                            <div class="col-md-3" id="dateRangeContainer">
                                <label for="freshLeadsDateFrom" class="fw-semibold small">From Date:</label>
                                <input type="date" id="freshLeadsDateFrom" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-3" id="dateRangeContainer2">
                                <label for="freshLeadsDateTo" class="fw-semibold small">To Date:</label>
                                <input type="date" id="freshLeadsDateTo" class="form-control form-control-sm">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <div class="input-group input-group-sm">
                                <input type="text" id="freshLeadsSearchInput" class="form-control" placeholder="Search by name, mobile, UID...">
                                <button class="btn btn-outline-primary btn-sm" type="button" id="freshLeadsSearchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" type="button" id="freshLeadsClearButton">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm mb-0" id="freshLeadsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="py-2">UID</th>
                                    <th class="py-2">Customer Name</th>
                                    <th class="py-2">Phone No.</th>
                                    <th class="py-2">Final Status</th>
                                    <th class="py-2">PS Name</th>
                                    <th class="py-2">Source</th>
                                    <th class="py-2">Lead Category</th>
                                    <th class="py-2">PS Assigned At</th>
                                    <th class="py-2">Created At</th>
                                    <th class="py-2">Call History</th>
                                </tr>
                            </thead>
                            <tbody id="freshLeadsTableBody">
                                <tr><td colspan="10" class="text-center py-2">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    Loading leads...
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fresh Leads Tab -->
        <div class="tab-pane fade" id="fresh-leads" role="tabpanel">
            <div class="card mb-2">
                <div class="card-body p-3">
                    <!-- Section-specific Filter Controls -->
                    <div class="filter-section mb-2">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label for="freshLeadsSectionPsSelect" class="fw-semibold small">Product Specialist:</label>
                                <select id="freshLeadsSectionPsSelect" class="form-select form-select-sm">
                                    <option value="">-- All PS --</option>
                                    {% for ps in ps_users %}
                                        <option value="{{ ps.name }}">{{ ps.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="freshLeadsSectionDateFilter" class="fw-semibold small">Date Filter:</label>
                                <select id="freshLeadsSectionDateFilter" class="form-select form-select-sm">
                                    <option value="">-- All Time --</option>
                                    <option value="today">Today</option>
                                    <option value="date_range">Date Range</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="freshLeadsSectionApplyFiltersBtn" class="btn btn-primary btn-sm me-2">Apply</button>
                                <button id="freshLeadsSectionResetFiltersBtn" class="btn btn-outline-secondary btn-sm">Reset</button>
                            </div>
                        </div>
                        <!-- Date Range Row - Hidden by default -->
                        <div class="row g-2 mt-2" id="freshLeadsSectionDateRangeRow" style="display: none;">
                            <div class="col-md-3" id="freshLeadsSectionDateRangeContainer">
                                <label for="freshLeadsSectionDateFrom" class="fw-semibold small">From Date:</label>
                                <input type="date" id="freshLeadsSectionDateFrom" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-3" id="freshLeadsSectionDateRangeContainer2">
                                <label for="freshLeadsSectionDateTo" class="fw-semibold small">To Date:</label>
                                <input type="date" id="freshLeadsSectionDateTo" class="form-control form-control-sm">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <div class="input-group input-group-sm">
                                <input type="text" id="freshLeadsSectionSearchInput" class="form-control" placeholder="Search by name, mobile, UID...">
                                <button class="btn btn-outline-primary btn-sm" type="button" id="freshLeadsSectionSearchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" type="button" id="freshLeadsSectionClearButton">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm mb-0" id="freshLeadsSectionTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="py-2">UID</th>
                                    <th class="py-2">Customer Name</th>
                                    <th class="py-2">Phone No.</th>
                                    <th class="py-2">Final Status</th>
                                    <th class="py-2">PS Name</th>
                                    <th class="py-2">Source</th>
                                    <th class="py-2">Lead Category</th>
                                    <th class="py-2">PS Assigned At</th>
                                    <th class="py-2">Created At</th>
                                    <th class="py-2">Call History</th>
                                </tr>
                            </thead>
                            <tbody id="freshLeadsSectionTableBody">
                                <tr><td colspan="10" class="text-center py-2">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Follow-ups Tab -->
        <div class="tab-pane fade" id="followup" role="tabpanel">
            <div class="card mb-2">
                <div class="card-header bg-primary text-white py-2">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar-check me-2"></i>Today's and Past Follow-ups
                    </h6>
                </div>
                <div class="card-body p-3">
                    <!-- Section-specific Filter Controls -->
                    <div class="filter-section mb-2 p-2 bg-light rounded">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label for="followupLeadsPsSelect" class="fw-semibold text-dark small">Product Specialist:</label>
                                <select id="followupLeadsPsSelect" class="form-select form-select-sm">
                                    <option value="">-- All PS --</option>
                                    {% for ps in ps_users %}
                                        <option value="{{ ps.name }}">{{ ps.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="followupLeadsDateFilter" class="fw-semibold text-dark small">Date Filter:</label>
                                <select id="followupLeadsDateFilter" class="form-select form-select-sm">
                                    <option value="">-- All Time --</option>
                                    <option value="today">Today</option>
                                    <option value="date_range">Date Range</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="followupLeadsApplyFiltersBtn" class="btn btn-primary btn-sm me-2">
                                    <i class="fas fa-filter me-1"></i>Apply
                                </button>
                                <button id="followupLeadsResetFiltersBtn" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-undo me-1"></i>Reset
                                </button>
                            </div>
                        </div>
                        <!-- Date Range Row - Hidden by default -->
                        <div class="row g-2 mt-2" id="followupDateRangeRow" style="display: none;">
                            <div class="col-md-4" id="followupDateRangeContainer">
                                <label for="followupLeadsDateFrom" class="fw-semibold small">From Date:</label>
                                <input type="date" id="followupLeadsDateFrom" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-4" id="followupDateRangeContainer2">
                                <label for="followupLeadsDateTo" class="fw-semibold small">To Date:</label>
                                <input type="date" id="followupLeadsDateTo" class="form-control form-control-sm">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div class="row mb-2">
                        <div class="col-md-8">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" id="followupLeadsSearchInput" class="form-control" placeholder="Search by name, mobile, UID...">
                                <button class="btn btn-outline-primary btn-sm" type="button" id="followupLeadsSearchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" type="button" id="followupLeadsClearButton">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-center justify-content-end">
                            <div class="badge bg-info small">
                                <i class="fas fa-info-circle me-1"></i>
                                Today's and past follow-ups
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm mb-0" id="followupLeadsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="py-2">UID</th>
                                    <th class="py-2">Customer Name</th>
                                    <th class="py-2">Phone No.</th>
                                    <th class="py-2">Source</th>
                                    <th class="py-2">Lead Category</th>
                                    <th class="py-2">Lead Status</th>
                                    <th class="py-2">PS Name</th>
                                    <th class="py-2">Created At</th>
                                    <th class="py-2">PS Assigned At</th>
                                    <th class="py-2">Follow-up Date</th>
                                    <th class="py-2">Call History</th>
                                </tr>
                            </thead>
                            <tbody id="followupLeadsTableBody">
                                <tr><td colspan="11" class="text-center py-2">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading today's and past follow-ups...
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Leads Tab -->
        <div class="tab-pane fade" id="export" role="tabpanel">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <label for="exportDateFrom" class="form-label">
                                <i class="fas fa-calendar-alt me-1"></i>From Date
                            </label>
                            <input type="date" id="exportDateFrom" class="form-control">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="exportDateTo" class="form-label">
                                <i class="fas fa-calendar-alt me-1"></i>To Date
                            </label>
                            <input type="date" id="exportDateTo" class="form-control">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="exportBranch" class="form-label">
                                <i class="fas fa-building me-1"></i>Branch
                            </label>
                            <select id="exportBranch" class="form-select">
                                <option value="{{ session.get('branch_head_branch', 'N/A') }}">{{ session.get('branch_head_branch', 'N/A') }}</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6 d-flex align-items-end">
                            <div class="d-grid gap-2 w-100">
                                <div class="btn-group-vertical w-100" role="group">
                                    <button type="button" class="btn btn-primary mb-2" id="exportPSLeads">
                                        <i class="fas fa-download me-2"></i>PS Leads
                                    </button>
                                    <button type="button" class="btn btn-success mb-2" id="exportWalkinLeads">
                                        <i class="fas fa-download me-2"></i>Walk-in Leads
                                    </button>
                                    <button type="button" class="btn btn-info" id="exportEventLeads">
                                        <i class="fas fa-download me-2"></i>Event Leads
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Call Attempt History Modal -->
<div class="modal fade" id="callAttemptHistoryModal" tabindex="-1" aria-labelledby="callAttemptHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="callAttemptHistoryModalLabel">
                    <i class="fas fa-phone-alt me-2"></i>Call Attempt History
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Call Summary Statistics -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info" id="callHistorySummary">
                            <i class="fas fa-info-circle me-2"></i>Loading call history...
                        </div>
                    </div>
                </div>
                
                <!-- Call History Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>UID</th>
                                <th>Call No</th>
                                <th>Attempt</th>
                                <th>Status</th>
                                <th>Role</th>
                                <th>Name</th>
                                <th>Timestamp</th>
                                <th>Remarks</th>
                                <th>Follow-up Date</th>
                            </tr>
                        </thead>
                        <tbody id="callHistoryTableBody">
                            <tr><td colspan="9" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Configuration for sections
const sectionConfig = {
  fresh_leads: {
    tab: 'fresh-tab',
    tbody: 'freshLeadsTableBody',
            psSelectId: 'freshLeadsPsSelect',
            sourceSelectId: 'freshLeadsSourceSelect',
            statusSelectId: 'freshLeadsStatusSelect',
            dateFilterId: 'freshLeadsDateFilter',
            dateFromId: 'freshLeadsDateFrom',
            dateToId: 'freshLeadsDateTo',
            searchId: 'freshLeadsSearchInput',
            columns: ['uid', 'customer_name', 'customer_mobile_number', 'final_status', 'ps_name', 'source', 'lead_category', 'ps_assigned_at', 'created_at', 'call_history']
  },
  fresh_leads_section: {
    tab: 'fresh-leads-tab',
    tbody: 'freshLeadsSectionTableBody',
            psSelectId: 'freshLeadsSectionPsSelect',
            sourceSelectId: 'freshLeadsSectionSourceSelect',
            statusSelectId: 'freshLeadsSectionStatusSelect',
            dateFilterId: 'freshLeadsSectionDateFilter',
            dateFromId: 'freshLeadsSectionDateFrom',
            dateToId: 'freshLeadsSectionDateTo',
            searchId: 'freshLeadsSectionSearchInput',
            columns: ['uid', 'customer_name', 'customer_mobile_number', 'final_status', 'ps_name', 'source', 'lead_category', 'ps_assigned_at', 'created_at', 'call_history']
  },
  followup_leads: {
    tab: 'followup-tab',
    tbody: 'followupLeadsTableBody',
            psSelectId: 'followupLeadsPsSelect',
            sourceSelectId: 'followupLeadsSourceSelect',
            statusSelectId: 'followupLeadsStatusSelect',
            dateFilterId: 'followupLeadsDateFilter',
            dateFromId: 'followupLeadsDateFrom',
            dateToId: 'followupLeadsDateTo',
            searchId: 'followupLeadsSearchInput',
            columns: ['uid', 'customer_name', 'customer_mobile_number', 'source', 'lead_category', 'lead_status', 'ps_name', 'created_at', 'ps_assigned_at', 'follow_up_date', 'call_history']
        }
    };

    // OPTIMIZED: Load section data with improved performance and server-side filtering
    function loadSection(section) {
        const startTime = performance.now();
        console.log(`[DEBUG] loadSection called with section: ${section}`);
        
        const config = sectionConfig[section];
        console.log('[DEBUG] Section config:', config);
        
        const tbody = document.getElementById(config.tbody);
        console.log('[DEBUG] Table body element:', tbody);
        
        if (!tbody) {
            console.error('[DEBUG] Table body not found for section:', section);
            return;
        }
        
        // Show loading state for table
        tbody.innerHTML = '<tr><td colspan="10" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</td></tr>';
        
        // Get filter values
        const psSelect = document.getElementById(config.psSelectId);
        const sourceSelect = document.getElementById(config.sourceSelectId);
        const statusSelect = document.getElementById(config.statusSelectId);
        const dateFilter = document.getElementById(config.dateFilterId);
        const dateFrom = document.getElementById(config.dateFromId);
        const dateTo = document.getElementById(config.dateToId);
        const searchInput = document.getElementById(config.searchId);
        
        const ps_name = psSelect ? psSelect.value : '';
        const source = sourceSelect ? sourceSelect.value : '';
        const final_status = statusSelect ? statusSelect.value : '';
        const date_filter = dateFilter ? dateFilter.value : '';
        let start_date = dateFrom ? dateFrom.value : '';
        let end_date = dateTo ? dateTo.value : '';
        const searchTerm = searchInput ? searchInput.value.trim() : '';
        
        // Handle date filtering logic
        if (date_filter === 'today') {
            const today = new Date();
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            start_date = formatDate(today);
            end_date = formatDate(today);
        }
        
        // Make API call with filter parameters and timeout
        const params = new URLSearchParams({
            section: section,
            ps_name: ps_name,
            source: source,
            final_status: final_status,
            date_filter: date_filter,
            start_date: start_date,
            end_date: end_date,
            search: searchTerm
        });
        
        // Debug logging
        console.log('[DEBUG] API call parameters:', {
            section: section,
            ps_name: ps_name,
            source: source,
            final_status: final_status,
            date_filter: date_filter,
            start_date: start_date,
            end_date: end_date,
            search: searchTerm
        });
        
        console.log(`[DEBUG] Making API call to /api/branch_head_dashboard_data for section: ${section}`);
        
        // Create AbortController for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // Reduced to 15 second timeout
        
        fetch(`/api/branch_head_dashboard_data?${params}`, {
            signal: controller.signal,
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        })
        .then(response => {
            const responseTime = performance.now() - startTime;
            clearTimeout(timeoutId);
            console.log(`[DEBUG] Response received for section ${section} in ${responseTime.toFixed(3)}s, status: ${response.status}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const parseTime = performance.now() - startTime;
            console.log(`[DEBUG] Data parsed for section ${section} in ${parseTime.toFixed(3)}s, rows: ${data.rows ? data.rows.length : 0}`);
            
            if (data.success) {
                // Update table efficiently
                tbody.innerHTML = '';
                if (data.rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No data found</td></tr>';
                } else {
                    // Use DocumentFragment for better performance
                    const fragment = document.createDocumentFragment();
                    
                    data.rows.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-search', Object.values(row).join(' ').toLowerCase());
                        
                        config.columns.forEach(column => {
                            const td = document.createElement('td');
                            
                            if (column === 'call_history') {
                                // Create call history button
                                const callHistoryBtn = document.createElement('button');
                                callHistoryBtn.className = 'btn btn-sm btn-outline-primary';
                                callHistoryBtn.innerHTML = '<i class="fas fa-phone-alt me-1"></i>View History';
                                callHistoryBtn.onclick = () => showCallHistory(row.uid);
                                td.appendChild(callHistoryBtn);
                            } else if (column === 'created_at' || column === 'ps_assigned_at') {
                                // Format timestamp columns with +5:30 offset and dd/mm/yyyy hh:mm AM/PM format
                                const value = row[column] || '';
                                if (value && value !== 'N/A') {
                                    td.textContent = formatTimestampWithOffset(value);
                                } else {
                                    td.textContent = 'N/A';
                                }
                            } else if (column === 'follow_up_date') {
                                // Format follow-up date as dd/mm/yyyy (no time offset)
                                const value = row[column] || '';
                                if (value) {
                                    td.textContent = formatDate(value);
                                } else {
                                    td.textContent = 'N/A';
                                }
                            } else {
                                const value = row[column] || '';
                                
                                // Special handling for lead_category column
                                if (column === 'lead_category' && value === 'Not Set') {
                                    td.innerHTML = '<span class="lead-category-not-set">Not Set</span>';
                                } else {
                                    td.textContent = value;
                                }
                            }
                            
                            tr.appendChild(td);
                        });
                        fragment.appendChild(tr);
                    });
                    
                    tbody.appendChild(fragment);
                }
                
                const totalTime = performance.now() - startTime;
                console.log(`[DEBUG] Section ${section} completed in ${totalTime.toFixed(3)}s`);
                logPerformanceMetric(`section_${section}_loading`, totalTime / 1000);
            } else {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Error: ${data.error || 'Unknown error'}</td></tr>`;
            }
        })
        .catch(error => {
            const totalTime = performance.now() - startTime;
            clearTimeout(timeoutId);
            console.error(`[DEBUG] Error in section ${section} after ${totalTime.toFixed(3)}s:`, error);
            
            if (error.name === 'AbortError') {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-warning">Request timed out. Please try again.</td></tr>';
            } else {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">Error loading data. Please refresh the page.</td></tr>';
            }
            
            logPerformanceMetric(`section_${section}_error`, totalTime / 1000);
        });
    }





    // Setup search functionality with client-side filtering
    function setupSearch(inputId, buttonId, clearId, tableId, sectionName) {
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);
        const clearBtn = document.getElementById(clearId);
        let searchTimeout;

        // Search button click
        if (button) {
            button.addEventListener('click', function() {
                filterTableData(sectionName);
            });
        }

        // Clear button click
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                input.value = '';
                filterTableData(sectionName);
            });
        }

        // Real-time search on input
        if (input) {
            input.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterTableData(sectionName);
                }, 300); // Debounce search
            });
        }
    }

    // Client-side table filtering with all filters
    function filterTableData(sectionName) {
        const config = sectionConfig[sectionName];
        const tbody = document.getElementById(config.tbody);
        const searchInput = document.getElementById(config.searchId);
        const psSelect = document.getElementById(config.psSelectId);
        const sourceSelect = document.getElementById(config.sourceSelectId);
        const statusSelect = document.getElementById(config.statusSelectId);
        // Date inputs (used by followup_leads)
        const dateFilterEl = document.getElementById(config.dateFilterId);
        const dateFromEl = document.getElementById(config.dateFromId);
        const dateToEl = document.getElementById(config.dateToId);
        
        // Get filter values
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const psFilter = psSelect ? psSelect.value.toLowerCase().trim() : '';
        const sourceFilter = sourceSelect ? sourceSelect.value.toLowerCase().trim() : '';
        const statusFilter = statusSelect ? statusSelect.value.toLowerCase().trim() : '';
        
        // Get all rows
        const rows = tbody.querySelectorAll('tr');
        
        rows.forEach(row => {
            let showRow = true;
            
            // Search filter
            if (searchTerm) {
                const searchData = row.getAttribute('data-search') || '';
                if (!searchData.includes(searchTerm)) {
                    showRow = false;
                }
            }
            
            // PS filter
            if (showRow && psFilter && psFilter !== '-- all ps --') {
                let psCell;
                // PS Name column position depends on section (adjusted for new call history column)
                if (sectionName === 'fresh_leads') {
                    psCell = row.querySelector('td:nth-child(5)'); // PS Name column (5th)
                } else if (sectionName === 'followup_leads') {
                    psCell = row.querySelector('td:nth-child(7)'); // PS Name column (7th)
                }
                if (psCell && !psCell.textContent.toLowerCase().includes(psFilter)) {
                    showRow = false;
                }
            }
            
            // Source filter - only apply to fresh_leads section for Source column
            if (showRow && sectionName === 'fresh_leads' && sourceFilter && sourceFilter !== '-- all sources --') {
                const sourceCell = row.querySelector('td:nth-child(6)'); // Source column (6th)
                if (sourceCell && !sourceCell.textContent.toLowerCase().includes(sourceFilter)) {
                    showRow = false;
                }
            }
            
            // Status filter - only apply to fresh_leads section for Final Status column
            if (showRow && sectionName === 'fresh_leads' && statusFilter && statusFilter !== '-- all statuses --') {
                const statusCell = row.querySelector('td:nth-child(4)'); // Final Status column (4th)
                if (statusCell && !statusCell.textContent.toLowerCase().includes(statusFilter)) {
                    showRow = false;
                }
            }

            // Date range filter for followup_leads by Follow-up Date column
            if (showRow && sectionName === 'followup_leads' && dateFilterEl) {
                const filterValue = dateFilterEl.value;
                let fromValue = (dateFromEl && dateFromEl.value) ? dateFromEl.value : '';
                let toValue = (dateToEl && dateToEl.value) ? dateToEl.value : '';
                if (filterValue === 'today') {
                    const today = new Date();
                    const y = today.getFullYear();
                    const m = String(today.getMonth() + 1).padStart(2, '0');
                    const d = String(today.getDate()).padStart(2, '0');
                    fromValue = `${y}-${m}-${d}`;
                    toValue = `${y}-${m}-${d}`;
                }
                if (filterValue === 'today' || (filterValue === 'date_range' && (fromValue || toValue))) {
                    // Follow-up Date column is the 10th column in followup table
                    const followupCell = row.querySelector('td:nth-child(10)');
                    if (followupCell) {
                        const cellText = followupCell.textContent.trim();
                        // cellText is formatted dd/mm/yyyy; normalize to yyyy-mm-dd for compare
                        const parts = cellText.split('/');
                        // Guard: require three parts
                        if (parts.length === 3) {
                            const norm = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            if (fromValue && norm < fromValue) showRow = false;
                            if (toValue && norm > toValue) showRow = false;
                        } else {
                            // When filtering by date, rows without a valid date should be hidden
                            showRow = false;
                        }
                    }
                }
            }
            
            // Show/hide row
            row.style.display = showRow ? '' : 'none';
        });
        
        // Update row count
        updateVisibleRowCount(sectionName);
    }
    
    // Update visible row count
    function updateVisibleRowCount(sectionName) {
        const config = sectionConfig[sectionName];
        const tbody = document.getElementById(config.tbody);
        const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])').length;
        
        // You can add a counter element to show filtered count
    }

    // Event listeners for filter buttons
    const sections = ['fresh', 'followup'];
    sections.forEach(section => {
        const applyBtn = document.getElementById(section + 'LeadsApplyFiltersBtn');
        const resetBtn = document.getElementById(section + 'LeadsResetFiltersBtn');
        
        if (applyBtn) {
            applyBtn.addEventListener('click', function() {
                const sectionMap = {
                    'fresh': 'fresh_leads',
                    'followup': 'followup_leads'
                };
                filterTableData(sectionMap[section]);
            });
        }
        
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                const psSelect = document.getElementById(section + 'LeadsPsSelect');
                const sourceSelect = document.getElementById(section + 'LeadsSourceSelect');
                const statusSelect = document.getElementById(section + 'LeadsStatusSelect');
                const dateFilter = document.getElementById(section + 'LeadsDateFilter');
                const dateFrom = document.getElementById(section + 'LeadsDateFrom');
                const dateTo = document.getElementById(section + 'LeadsDateTo');
                const searchInput = document.getElementById(section + 'LeadsSearchInput');
                
                if (psSelect) psSelect.value = '';
                if (sourceSelect) sourceSelect.value = '';
                if (statusSelect) statusSelect.value = '';
                if (dateFilter) dateFilter.value = '';
                if (dateFrom) dateFrom.value = '';
                if (dateTo) dateTo.value = '';
                if (searchInput) searchInput.value = '';
                
                // Hide date range containers
                const dateRangeContainer = document.getElementById('dateRangeContainer');
                const dateRangeContainer2 = document.getElementById('dateRangeContainer2');
                if (dateRangeContainer) dateRangeContainer.style.display = 'none';
                if (dateRangeContainer2) dateRangeContainer2.style.display = 'none';
                const followupDateRangeRow = document.getElementById('followupDateRangeRow');
                if (followupDateRangeRow) followupDateRangeRow.style.display = 'none';
                const followupDateRangeContainer = document.getElementById('followupDateRangeContainer');
                const followupDateRangeContainer2 = document.getElementById('followupDateRangeContainer2');
                if (followupDateRangeContainer) followupDateRangeContainer.style.display = 'none';
                if (followupDateRangeContainer2) followupDateRangeContainer2.style.display = 'none';
                
                const sectionMap = {
                    'fresh': 'fresh_leads',
                    'followup': 'followup_leads'
                };
                filterTableData(sectionMap[section]);
            });
        }
    });

    // Load dynamic sources for dropdowns
    function loadDynamicSources() {
        const startTime = performance.now();
        console.log('[DEBUG] loadDynamicSources called');
        
        fetch('/api/branch_sources')
            .then(response => {
                const responseTime = performance.now() - startTime;
                console.log(`[DEBUG] /api/branch_sources response received in ${responseTime.toFixed(3)}s, status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                const parseTime = performance.now() - startTime;
                console.log(`[DEBUG] Dynamic sources data parsed in ${parseTime.toFixed(3)}s, sources: ${data.sources ? data.sources.length : 0}`);
                
                if (data.success && data.sources) {
                    // Update all source dropdowns (only for All Leads section now)
                    const sourceDropdowns = [
                        'freshLeadsSourceSelect'
                    ];
                    
                    sourceDropdowns.forEach(dropdownId => {
                        const dropdown = document.getElementById(dropdownId);
                        if (dropdown) {
                            // Keep the first option (-- All Sources --)
                            const firstOption = dropdown.options[0];
                            dropdown.innerHTML = '';
                            dropdown.appendChild(firstOption);
                            
                            // Add dynamic sources
                            data.sources.forEach(source => {
                                const option = document.createElement('option');
                                option.value = source;
                                option.textContent = source;
                                dropdown.appendChild(option);
                            });
                        }
                    });
                    
                    const totalTime = performance.now() - startTime;
                    console.log(`[DEBUG] loadDynamicSources completed in ${totalTime.toFixed(3)}s`);
                    logPerformanceMetric('dynamic_sources_loading', totalTime / 1000);
                }
            })
            .catch(error => {
                const totalTime = performance.now() - startTime;
                console.error(`[DEBUG] Error in loadDynamicSources after ${totalTime.toFixed(3)}s:`, error);
                logPerformanceMetric('dynamic_sources_error', totalTime / 1000);
            });
    }

    // Setup search for each section
    setupSearch('freshLeadsSearchInput', 'freshLeadsSearchButton', 'freshLeadsClearButton', 'freshLeadsTable', 'fresh_leads');
    setupSearch('freshLeadsSectionSearchInput', 'freshLeadsSectionSearchButton', 'freshLeadsSectionClearButton', 'freshLeadsSectionTable', 'fresh_leads_section');
    setupSearch('followupLeadsSearchInput', 'followupLeadsSearchButton', 'followupLeadsClearButton', 'followupLeadsTable', 'followup_leads');

// Load Branch Head dashboards
function loadBranchHeadDashboards() {
    fetch('/api/dashboards')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.dashboards['branch-head']) {
                const container = document.getElementById('branchHeadDashboardsContainer');
                let html = '';
                
                data.dashboards['branch-head'].forEach(dashboard => {
                    html += `
                            <div class="dashboard-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${dashboard.name}</h6>
                                <small class="text-muted">Added: ${new Date(dashboard.created_at).toLocaleDateString()}</small>
                            </div>
                            <div class="card-body p-0">
                                <iframe src="${dashboard.url}" 
                                            class="dashboard-iframe"
                                        frameborder="0">
                                </iframe>
                            </div>
                        </div>
                    `;
                });
                
                if (html === '') {
                    html = '<div class="text-center text-muted py-4"><i class="fas fa-chart-bar fa-3x mb-3"></i><p>No Branch Head dashboards configured yet.</p></div>';
                }
                
                container.innerHTML = html;
            } else {
                const container = document.getElementById('branchHeadDashboardsContainer');
                container.innerHTML = `<div class="text-center text-muted py-4">
                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                    <p>No Branch Head dashboards configured yet.</p>
                    <small class="text-muted">Debug: Response received but no Branch Head dashboards found</small>
                </div>`;
            }
        })
        .catch(error => {
            console.error('Error loading Branch Head dashboards:', error);
            const container = document.getElementById('branchHeadDashboardsContainer');
            container.innerHTML = `<div class="text-center text-danger py-4">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>Error loading dashboards. Please try again.</p>
            </div>`;
        });
}

// Load Analytics Data - OPTIMIZED
function loadAnalyticsData() {
    const startTime = performance.now();
    
    // Show loading state for all analytics tables
    showAnalyticsLoadingState();
    
    // OPTIMIZATION: Use single endpoint to load all analytics data at once
    const params = getAnalyticsFilterParams();
    if (!params) {
        hideAnalyticsLoadingState();
        return;
    }
    
    const queryString = new URLSearchParams(params).toString();
    
    fetch(`/api/branch_analytics/all?${queryString}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update all tables with single response
                updatePSPerformanceTable(data.data.ps_performance);
                updateSourceLeadsTable(data.data.source_leads, data.data.sources);
                updateWalkinLeadsTable(data.data.walkin_leads);
                updateBranchSummary(data.data.summary);
                
                // Load PS Follow-up Summary Data (separate as it has different logic)
                loadPSFollowupSummaryData();
                
                // Load Branch Head Dashboards with progressive loading
                setTimeout(() => loadBranchHeadDashboards(), 100);
                
                // Log performance metric
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                logPerformanceMetric('analytics_loading', duration);
                
                // Show performance info in console
                console.log(`[PERF] Analytics loaded in ${duration.toFixed(3)}s (${getAveragePerformance('analytics_loading').toFixed(3)}s avg)`);
            } else {
                console.error('Error loading analytics data:', data.message);
                showAnalyticsError(data.message);
            }
            hideAnalyticsLoadingState();
        })
        .catch(error => {
            console.error('Error loading analytics data:', error);
            showAnalyticsError('Network error occurred. Please try again.');
            hideAnalyticsLoadingState();
            
            // Log error performance
            const endTime = performance.now();
            const duration = (endTime - startTime) / 1000;
            logPerformanceMetric('analytics_error', duration);
        });
}

// Update PS Performance Table
function updatePSPerformanceTable(data) {
            const tbody = document.getElementById('psPerformanceTableBody');
            tbody.innerHTML = '';
            
    if (data && data.length > 0) {
        data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.ps_name}</td>
                        <td>${row.leads_assigned}</td>
                        <td>${row.leads_contacted}</td>
                        <td>${row.gap}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No data available</td></tr>';
            }
}

// Update Source Leads Table
function updateSourceLeadsTable(data, sources) {
    const tbody = document.getElementById('sourceLeadsTableBody');
    const thead = document.getElementById('sourceLeadsTableHead');
    tbody.innerHTML = '';
    
    if (data && data.length > 0) {
        // Update table headers with dynamic source columns
        const headerRow = thead.querySelector('tr');
        // Keep the first 4 columns (Product Specialist, Total Leads, Won Leads, Win Rate)
        headerRow.innerHTML = `
            <th>Product Specialist</th>
            <th>Total Leads</th>
            <th>Won Leads</th>
            <th>Win Rate (%)</th>
        `;
        
        // Add dynamic source columns
        if (sources && sources.length > 0) {
            sources.forEach(source => {
                const th = document.createElement('th');
                th.textContent = source;
                headerRow.appendChild(th);
            });
        }
        
        // Populate table data
        data.forEach(row => {
            const tr = document.createElement('tr');
            const winRate = row.total_leads > 0 ? ((row.won_leads / row.total_leads) * 100).toFixed(1) : '0.0';
            
            // Start with the basic columns
            let rowHTML = `
                <td>${row.ps_name}</td>
                <td>${row.total_leads}</td>
                <td>${row.won_leads}</td>
                <td>${winRate}%</td>
            `;
            
            // Add dynamic source columns
            if (sources && sources.length > 0) {
                sources.forEach(source => {
                    const sourceStats = row.source_breakdown && row.source_breakdown[source] ? row.source_breakdown[source] : { total_leads: 0, won_leads: 0 };
                    const sourceWinRate = sourceStats.total_leads > 0 ? ((sourceStats.won_leads / sourceStats.total_leads) * 100).toFixed(1) : '0.0';
                    rowHTML += `<td>${sourceStats.total_leads} (${sourceStats.won_leads} won, ${sourceWinRate}%)</td>`;
                });
            }
            
            tr.innerHTML = rowHTML;
            tbody.appendChild(tr);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">No data available</td></tr>';
    }
}

// Update Walkin Leads Table
function updateWalkinLeadsTable(data) {
    const tbody = document.getElementById('walkinLeadsTableBody');
    tbody.innerHTML = '';
    
    if (data && data.length > 0) {
        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.ps_name}</td>
                <td>${row.total_walkin_leads}</td>
                <td>${row.pending_leads}</td>
                <td>${row.lost_leads}</td>
                <td>${row.won_leads}</td>
                <td>${row.today_followups}</td>
            `;
            tbody.appendChild(tr);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No data available</td></tr>';
    }
}

// Update Branch Summary
function updateBranchSummary(data) {
    if (data) {
        document.getElementById('totalLeadsAssigned').textContent = data.total_leads_assigned || 0;
        document.getElementById('totalPendingLeads').textContent = data.total_pending_leads || 0;
        document.getElementById('totalWonLeads').textContent = data.total_won_leads || 0;
        document.getElementById('totalLostLeads').textContent = data.total_lost_leads || 0;
    }
}

// Show Analytics Loading State
function showAnalyticsLoadingState() {
    const loadingHTML = '<tr><td colspan="10" class="text-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div>Loading...</td></tr>';
    
    // Show loading in all analytics tables
    document.getElementById('psPerformanceTableBody').innerHTML = loadingHTML.replace('colspan="10"', 'colspan="4"');
    document.getElementById('sourceLeadsTableBody').innerHTML = loadingHTML.replace('colspan="10"', 'colspan="4"');
    document.getElementById('walkinLeadsTableBody').innerHTML = loadingHTML.replace('colspan="10"', 'colspan="6"');
    
    // Show loading in KPI cards
    document.getElementById('totalLeadsAssigned').textContent = '...';
    document.getElementById('totalPendingLeads').textContent = '...';
    document.getElementById('totalWonLeads').textContent = '...';
    document.getElementById('totalLostLeads').textContent = '...';
}

// Hide Analytics Loading State
function hideAnalyticsLoadingState() {
    // Loading states are cleared when data is populated
}

// Show Analytics Error
function showAnalyticsError(message) {
    const errorHTML = `<tr><td colspan="10" class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>${message}</td></tr>`;
    
    document.getElementById('psPerformanceTableBody').innerHTML = errorHTML.replace('colspan="10"', 'colspan="4"');
    document.getElementById('sourceLeadsTableBody').innerHTML = errorHTML.replace('colspan="10"', 'colspan="4"');
    document.getElementById('walkinLeadsTableBody').innerHTML = errorHTML.replace('colspan="10"', 'colspan="6"');
    
    // Show error in KPI cards
    document.getElementById('totalLeadsAssigned').textContent = 'Error';
    document.getElementById('totalPendingLeads').textContent = 'Error';
    document.getElementById('totalWonLeads').textContent = 'Error';
    document.getElementById('totalLostLeads').textContent = 'Error';
}

// Performance Monitoring
function logPerformanceMetric(operation, duration) {
    console.log(`[PERF] ${operation}: ${duration.toFixed(3)}s`);
    
    // Store in localStorage for tracking
    const metrics = JSON.parse(localStorage.getItem('dashboard_performance') || '{}');
    if (!metrics[operation]) {
        metrics[operation] = [];
    }
    metrics[operation].push({
        timestamp: Date.now(),
        duration: duration
    });
    
    // Keep only last 10 measurements
    if (metrics[operation].length > 10) {
        metrics[operation] = metrics[operation].slice(-10);
    }
    
    localStorage.setItem('dashboard_performance', JSON.stringify(metrics));
}

// Get Average Performance
function getAveragePerformance(operation) {
    const metrics = JSON.parse(localStorage.getItem('dashboard_performance') || '{}');
    const operationMetrics = metrics[operation] || [];
    
    if (operationMetrics.length === 0) return 0;
    
    const total = operationMetrics.reduce((sum, m) => sum + m.duration, 0);
    return total / operationMetrics.length;
}

// Show Performance Statistics
function showPerformanceStats() {
    const metrics = JSON.parse(localStorage.getItem('dashboard_perytics') || '{}');
    
    let statsHTML = '<div class="table-responsive"><table class="table table-sm">';
    statsHTML += '<thead><tr><th>Operation</th><th>Last 10 Avg</th><th>Best</th><th>Worst</th></tr></thead><tbody>';
    
    for (const [operation, measurements] of Object.entries(metrics)) {
        if (measurements.length === 0) continue;
        
        const avg = getAveragePerformance(operation);
        const best = Math.min(...measurements.map(m => m.duration));
        const worst = Math.max(...measurements.map(m => m.duration));
        
        statsHTML += `<tr>
            <td><strong>${operation.replace('_', ' ').toUpperCase()}</strong></td>
            <td>${avg.toFixed(3)}s</td>
            <td class="text-success">${best.toFixed(3)}s</td>
            <td class="text-danger">${worst.toFixed(3)}s</td>
        </tr>`;
    }
    
    statsHTML += '</tbody></table></div>';
    
    // Show in a modal or alert
    const modal = new bootstrap.Modal(document.getElementById('performanceModal') || createPerformanceModal());
    document.getElementById('performanceModalBody').innerHTML = statsHTML;
    modal.show();
}

// Create Performance Modal if it doesn't exist
function createPerformanceModal() {
    const modalHTML = `
        <div class="modal fade" id="performanceModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Dashboard Performance Statistics</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="performanceModalBody">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-warning" onclick="clearPerformanceData()">Clear Data</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    return document.getElementById('performanceModal');
}

// Clear Performance Data
function clearPerformanceData() {
    localStorage.removeItem('dashboard_performance');
    document.getElementById('performanceModalBody').innerHTML = '<div class="alert alert-info">Performance data cleared.</div>';
}

// Load Source-wise Leads Data
function loadSourceLeadsData() {
    fetch('/api/branch_analytics/source_leads')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('sourceLeadsTableBody');
            const thead = document.getElementById('sourceLeadsTableHead');
            tbody.innerHTML = '';
            
            if (data.success && data.data.length > 0) {
                // Update table headers with dynamic source columns
                const headerRow = thead.querySelector('tr');
                // Keep the first 4 columns (Product Specialist, Total Leads, Won Leads, Win Rate)
                headerRow.innerHTML = `
                    <th>Product Specialist</th>
                    <th>Total Leads</th>
                    <th>Won Leads</th>
                    <th>Win Rate (%)</th>
                `;
                
                // Add dynamic source columns
                if (data.sources && data.sources.length > 0) {
                    data.sources.forEach(source => {
                        const th = document.createElement('th');
                        th.textContent = source;
                        headerRow.appendChild(th);
                    });
                }
                
                // Populate table data
                data.data.forEach(row => {
                    const tr = document.createElement('tr');
                    const winRate = row.total_leads > 0 ? ((row.won_leads / row.total_leads) * 100).toFixed(1) : '0.0';
                    
                    // Start with the basic columns
                    let rowHTML = `
                        <td>${row.ps_name}</td>
                        <td>${row.total_leads}</td>
                        <td>${row.won_leads}</td>
                        <td>${winRate}%</td>
                    `;
                    
                    // Add dynamic source columns
                    if (data.sources && data.sources.length > 0) {
                        data.sources.forEach(source => {
                            const sourceStats = row.source_breakdown && row.source_breakdown[source] ? row.source_breakdown[source] : { total_leads: 0, won_leads: 0 };
                            const sourceWinRate = sourceStats.total_leads > 0 ? ((sourceStats.won_leads / sourceStats.total_leads) * 100).toFixed(1) : '0.0';
                            rowHTML += `<td>${sourceStats.total_leads} (${sourceStats.won_leads} won, ${sourceWinRate}%)</td>`;
                        });
                    }
                    
                    tr.innerHTML = rowHTML;
                    tbody.appendChild(tr);
                });
            } else {
                const colspan = data.sources ? 4 + data.sources.length : 4;
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center">No data available</td></tr>`;
            }
        })
        .catch(error => {
            console.error('Error loading source leads data:', error);
            document.getElementById('sourceLeadsTableBody').innerHTML = 
                '<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>';
        });
}

// Load Walk-in Leads Data
function loadWalkinLeadsData() {
    fetch('/api/branch_analytics/walkin_leads')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('walkinLeadsTableBody');
            tbody.innerHTML = '';
            
            if (data.success && data.data.length > 0) {
                data.data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.ps_name}</td>
                        <td>${row.total_walkin_leads}</td>
                        <td>${row.pending_leads}</td>
                        <td>${row.lost_leads}</td>
                        <td>${row.won_leads}</td>
                        <td>${row.today_followups}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No data available</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading walkin leads data:', error);
            document.getElementById('walkinLeadsTableBody').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>';
        });
}

// Load PS Follow-up Summary Data
function loadPSFollowupSummaryData() {
    fetch('/api/ps_followup_summary')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('psFollowupTableBody');
            tbody.innerHTML = '';
            
            if (data.success && data.data.length > 0) {
                data.data.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    // Helper function to create sub-column cells for each follow-up level with click functionality
                    function createFollowupCells(followupData, fLevel, psName) {
                        const creCount = followupData.ps_followup || 0;
                        const walkinCount = followupData.walkin || 0;
                        
                        return `
                            <td class="text-center clickable-cell" 
                                data-ps="${psName}" 
                                data-level="${fLevel}" 
                                data-source="cre" 
                                data-count="${creCount}"
                                style="cursor: pointer;">
                                <span class="badge bg-primary">${creCount}</span>
                            </td>
                            <td class="text-center clickable-cell" 
                                data-ps="${psName}" 
                                data-level="${fLevel}" 
                                data-source="walkin" 
                                data-count="${walkinCount}"
                                style="cursor: pointer;">
                                <span class="badge bg-info">${walkinCount}</span>
                            </td>
                        `;
                    }
                    
                    tr.innerHTML = `
                        <td><strong>${row.ps_name}</strong></td>
                        ${createFollowupCells(row.F1, 'F1', row.ps_name)}
                        ${createFollowupCells(row.F2, 'F2', row.ps_name)}
                        ${createFollowupCells(row.F3, 'F3', row.ps_name)}
                        ${createFollowupCells(row.F4, 'F4', row.ps_name)}
                        ${createFollowupCells(row.F5, 'F5', row.ps_name)}
                        ${createFollowupCells(row.F6, 'F6', row.ps_name)}
                        ${createFollowupCells(row.F7, 'F7', row.ps_name)}

                    `;
                    tbody.appendChild(tr);
                });
                
                // Add click event listeners to all clickable cells
                addClickEventListeners();
                
                // Ensure table responsiveness
                ensureTableResponsiveness();
            } else {
                tbody.innerHTML = '<tr><td colspan="15" class="text-center">No data available</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading PS follow-up summary data:', error);
            document.getElementById('psFollowupTableBody').innerHTML = 
                '<tr><td colspan="15" class="text-center text-danger">Error loading data</td></tr>';
        });
}

// Add click event listeners to clickable cells
function addClickEventListeners() {
    const clickableCells = document.querySelectorAll('.clickable-cell');
    clickableCells.forEach(cell => {
        cell.addEventListener('click', function() {
            const psName = this.getAttribute('data-ps');
            const level = this.getAttribute('data-level');
            const source = this.getAttribute('data-source');
            const count = parseInt(this.getAttribute('data-count')) || 0;
            const psRow = this.closest('tr');
            if (count > 0 && psRow) {
                toggleInlineLeadDetails(psName, level, source, psRow);
            }
        });
    });
}

// Toggle details row under the PS row and render leads inline
function toggleInlineLeadDetails(psName, level, source, anchorRow) {
    // If an existing details row exists right after this PS row, remove it (toggle)
    const nextRow = anchorRow.nextElementSibling;
    if (nextRow && nextRow.classList.contains('ps-inline-details')) {
        nextRow.remove();
        return;
    }

    // Remove any other open details row in the table to keep UI clean
    document.querySelectorAll('#psFollowupTable .ps-inline-details').forEach(r => r.remove());

    // Create a new details row
    const detailsRow = document.createElement('tr');
    detailsRow.className = 'ps-inline-details bg-light';
    const colCount = document.querySelectorAll('#psFollowupTable thead tr:last-child th').length + 1; // +1 for PS Name
    const detailsCell = document.createElement('td');
    detailsCell.setAttribute('colspan', colCount.toString());
    detailsCell.innerHTML = `
        <div class="p-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="fw-semibold">${psName}  ${level} ${source === 'cre' ? 'CRE Assigned' : 'Walk-in'} Leads</div>
                <button class="btn btn-sm btn-outline-secondary" onclick="this.closest('tr').remove()">Hide</button>
            </div>
            <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0">
                    <thead class="table-secondary">
                        <tr>
                            <th style="width: 140px;">Lead ID</th>
                            <th>Customer</th>
                            <th style="width: 120px;">Phone</th>
                            <th style="width: 90px;">Status</th>
                            <th style="width: 90px;">Source</th>
                            <th style="width: 140px;">PS Assigned At</th>
                            <th style="width: 140px;">Created At</th>
                            <th style="width: 160px;">Follow-up Date</th>
                            <th style="width: 120px;">History</th>
                        </tr>
                    </thead>
                    <tbody id="inlineLeadsBody"></tbody>
                </table>
            </div>
        </div>
    `;
    detailsRow.appendChild(detailsCell);
    anchorRow.parentNode.insertBefore(detailsRow, anchorRow.nextSibling);

    const tbody = detailsCell.querySelector('#inlineLeadsBody');
    tbody.innerHTML = `<tr><td colspan="9" class="text-center"><i class=\"fas fa-spinner fa-spin\"></i> Loading...</td></tr>`;

    fetch(`/api/ps_followup_leads?ps_name=${encodeURIComponent(psName)}&level=${level}&source=${source}`)
        .then(r => r.json())
        .then(data => {
            if (!(data.success && data.leads && data.leads.length)) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">No leads found.</td></tr>`;
                return;
            }
            tbody.innerHTML = '';
            data.leads.forEach(lead => {
                const uid = lead.uid || lead.lead_uid || '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><code>${uid}</code></td>
                    <td>${(lead.customer_name||'').toString()}</td>
                    <td>${lead.mobile_number || lead.customer_phone_number || 'N/A'}</td>
                    <td><span class="badge bg-${(lead.status||lead.final_status)==='Pending' ? 'warning' : (lead.status||lead.final_status)==='Won' ? 'success' : 'danger'}">${lead.status || lead.final_status || 'N/A'}</span></td>
                    <td><span class="badge bg-info">${source === 'cre' ? (lead.source || 'CRE') : 'Walk-in'}</span></td>
                    <td>${source === 'cre' ? formatDate(lead.ps_assigned_at) : 'N/A'}</td>
                    <td>${source === 'walkin' ? formatDate(lead.created_at) : 'N/A'}</td>
                    <td>${lead.follow_up_date || lead.next_followup_date || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" data-uid="${uid}" onclick="toggleCallHistoryInline(this)">View history</button>
                    </td>
                `;
                tbody.appendChild(tr);

                // Placeholder row for history (hidden initially)
                const historyRow = document.createElement('tr');
                historyRow.className = 'lead-history-row d-none';
                const historyCell = document.createElement('td');
                historyCell.setAttribute('colspan', '9');
                historyCell.innerHTML = `<div class="p-2 small text-muted">History will appear here...</div>`;
                historyRow.appendChild(historyCell);
                tbody.appendChild(historyRow);
            });
        })
        .catch(err => {
            console.error('Inline leads load error:', err);
            tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Error loading leads</td></tr>`;
        });
}

// Helper function to format dates consistently
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';
        return date.toLocaleDateString('en-IN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    } catch (e) {
        return 'N/A';
    }
}

function formatTimestampWithOffset(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';
        
        // Add +5:30 hours offset (IST timezone)
        const istOffset = 5.5 * 60 * 60 * 1000; // 5.5 hours in milliseconds
        const istDate = new Date(date.getTime() + istOffset);
        
        // Format as dd/mm/yyyy hh:mm AM/PM
        const day = String(istDate.getUTCDate()).padStart(2, '0');
        const month = String(istDate.getUTCMonth() + 1).padStart(2, '0');
        const year = istDate.getUTCFullYear();
        
        let hours = istDate.getUTCHours();
        const minutes = String(istDate.getUTCMinutes()).padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        hours = String(hours).padStart(2, '0');
        
        return `${day}/${month}/${year} ${hours}:${minutes} ${ampm}`;
    } catch (e) {
        return 'N/A';
    }
}

// Function to ensure table responsiveness
function ensureTableResponsiveness() {
    const psFollowupTable = document.getElementById('psFollowupTable');
    if (psFollowupTable) {
        const tableContainer = psFollowupTable.closest('.table-responsive');
        if (tableContainer) {
            // Ensure horizontal scroll is enabled
            tableContainer.style.overflowX = 'auto';
            tableContainer.style.maxWidth = '100%';
            
            // Add custom scrollbar styling
            tableContainer.style.scrollbarWidth = 'thin';
            tableContainer.style.scrollbarColor = '#6c757d #f8f9fa';
        }
    }
}

// Toggle inline call history for a single lead
function toggleCallHistoryInline(btn) {
    const uid = btn.getAttribute('data-uid');
    const currentRow = btn.closest('tr');
    const historyRow = currentRow.nextElementSibling;
    if (!historyRow || !historyRow.classList.contains('lead-history-row')) return;
    const cell = historyRow.querySelector('td');

    if (!historyRow.classList.contains('d-none')) {
        historyRow.classList.add('d-none');
        return;
    }

    // Show and load
    historyRow.classList.remove('d-none');
    cell.innerHTML = `<div class="p-2 text-center"><i class=\"fas fa-spinner fa-spin\"></i> Loading history...</div>`;
    fetch(`/api/lead_call_history/${encodeURIComponent(uid)}`)
        .then(r => r.json())
        .then(data => {
            if (!(data.success && data.history)) {
                cell.innerHTML = `<div class="p-2 text-muted">No history found.</div>`;
                return;
            }
            const rows = data.history.map(h => `
                <tr>
                    <td>${h.role}</td>
                    <td>${(h.call_no||'').toString().toUpperCase()}</td>
                    <td>${h.attempt ?? ''}</td>
                    <td>${h.status || ''}</td>
                    <td>${h.follow_up_date ? formatDate(h.follow_up_date) : ''}</td>
                    <td>${h.timestamp ? formatDate(h.timestamp) : ''}</td>
                    <td>${h.remarks ? `<small>${h.remarks}</small>` : ''}</td>
                </tr>
            `).join('');
            cell.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Role</th>
                                <th>Call</th>
                                <th>Attempt</th>
                                <th>Status</th>
                                <th>Follow-up</th>
                                <th>Timestamp</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        })
        .catch(err => {
            console.error('History load error:', err);
            cell.innerHTML = `<div class="p-2 text-danger">Error loading history</div>`;
        });
}

    // Export functions
    function exportLeadsData(leadType) {
        const dateFrom = document.getElementById('exportDateFrom').value;
        const dateTo = document.getElementById('exportDateTo').value;
        const branch = document.getElementById('exportBranch').value;
        
        if (!dateFrom || !dateTo) {
            alert('Please select both From and To dates for export.');
            return;
        }
        
        if (!branch || branch === 'N/A') {
            alert('Please select a valid branch for export.');
            return;
        }
        
        // Show loading state
        const exportBtn = document.getElementById(`export${leadType}Leads`);
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
        exportBtn.disabled = true;
        
        // Make export request
        fetch('/api/export_branch_leads', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                lead_type: leadType,
                date_from: dateFrom,
                date_to: dateTo,
                branch: branch
            })
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Export failed');
                });
            }
        })
        .then(blob => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${leadType}_leads_${dateFrom}_to_${dateTo}_${branch}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Reset button
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        })
        .catch(error => {
            console.error('Export error:', error);
            alert('Export failed. Please try again.');
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        });
    }

    // Analytics Filter Functions
    function getAnalyticsFilterParams() {
        const dateFrom = document.getElementById('analyticsDateFrom').value;
        const dateTo = document.getElementById('analyticsDateTo').value;
        
        let params = {};
        
        // Always use date range - require both dates
                if (!dateFrom || !dateTo) {
            alert('Please select both From and To dates for the date range.');
                    return null;
                }
        
                params.date_from = dateFrom;
                params.date_to = dateTo;
        
        return params;
    }

    function loadAnalyticsDataWithFilter() {
        console.log('[DEBUG] loadAnalyticsDataWithFilter called');
        const startTime = performance.now();
        
        const params = getAnalyticsFilterParams();
        if (!params) {
            console.log('[DEBUG] No filter params, returning');
            return;
        }
        
        console.log('[DEBUG] Filter params:', params);
        
        // OPTIMIZATION: Use single endpoint instead of multiple individual calls
        const queryString = new URLSearchParams(params).toString();
        console.log('[DEBUG] Making single API call to /api/branch_analytics/all');
        
        // Show loading state for all analytics tables
        showAnalyticsLoadingState();
        
        fetch(`/api/branch_analytics/all?${queryString}`)
            .then(response => {
                console.log('[DEBUG] Response received, status:', response.status);
                return response.json();
            })
            .then(data => {
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                console.log(`[DEBUG] Analytics data loaded in ${duration.toFixed(3)}s`);
                
                if (data.success) {
                    console.log('[DEBUG] Data loaded successfully, updating tables...');
                    
                    // Update all tables with single response
                    updatePSPerformanceTable(data.data.ps_performance);
                    updateSourceLeadsTable(data.data.source_leads, data.data.sources);
                    updateWalkinLeadsTable(data.data.walkin_leads);
                    updateBranchSummary(data.data.summary);
                    
                    // Load PS Follow-up Summary Data (separate as it has different logic)
                    loadPSFollowupSummaryData();
                    
                    // Load Branch Head Dashboards with progressive loading
                    setTimeout(() => loadBranchHeadDashboards(), 100);
                    
                    // Log performance metric
                    logPerformanceMetric('analytics_loading_filtered', duration);
                    console.log(`[PERF] Filtered analytics loaded in ${duration.toFixed(3)}s (${getAveragePerformance('analytics_loading_filtered').toFixed(3)}s avg)`);
                } else {
                    console.error('[DEBUG] Error in data response:', data.message);
                    showAnalyticsError(data.message);
                }
                hideAnalyticsLoadingState();
            })
            .catch(error => {
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                console.error('[DEBUG] Fetch error:', error);
                showAnalyticsError('Network error occurred. Please try again.');
                hideAnalyticsLoadingState();
                
                // Log error performance
                logPerformanceMetric('analytics_error_filtered', duration);
            });
    }

    function loadPSPerformanceDataWithFilter(params) {
        const queryString = new URLSearchParams(params).toString();
        fetch(`/api/branch_analytics/ps_performance?${queryString}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('psPerformanceTableBody');
                tbody.innerHTML = '';
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.ps_name}</td>
                            <td>${row.leads_assigned}</td>
                            <td>${row.leads_contacted}</td>
                            <td>${row.gap}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">No data available</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading PS performance data:', error);
                document.getElementById('psPerformanceTableBody').innerHTML = 
                    '<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>';
            });
    }

    function loadSourceLeadsDataWithFilter(params) {
        const queryString = new URLSearchParams(params).toString();
        fetch(`/api/branch_analytics/source_leads?${queryString}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('sourceLeadsTableBody');
                const thead = document.getElementById('sourceLeadsTableHead');
                tbody.innerHTML = '';
                
                if (data.success && data.data.length > 0) {
                    // Update table headers with dynamic source columns
                    const headerRow = thead.querySelector('tr');
                    // Keep the first 4 columns (Product Specialist, Total Leads, Won Leads, Win Rate)
                    headerRow.innerHTML = `
                        <th>Product Specialist</th>
                        <th>Total Leads</th>
                        <th>Won Leads</th>
                        <th>Win Rate (%)</th>
                    `;
                    
                    // Add dynamic source columns
                    if (data.sources && data.sources.length > 0) {
                        data.sources.forEach(source => {
                            const th = document.createElement('th');
                            th.textContent = source;
                            headerRow.appendChild(th);
                        });
                    }
                    
                    // Populate table data
                    data.data.forEach(row => {
                        const tr = document.createElement('tr');
                        const winRate = row.total_leads > 0 ? ((row.won_leads / row.total_leads) * 100).toFixed(1) : '0.0';
                        
                        // Start with the basic columns
                        let rowHTML = `
                            <td>${row.ps_name}</td>
                            <td>${row.total_leads}</td>
                            <td>${row.won_leads}</td>
                            <td>${winRate}%</td>
                        `;
                        
                        // Add dynamic source columns
                        if (data.sources && data.sources.length > 0) {
                            data.sources.forEach(source => {
                                const sourceStats = row.source_breakdown && row.source_breakdown[source] ? row.source_breakdown[source] : { total_leads: 0, won_leads: 0 };
                                const sourceWinRate = sourceStats.total_leads > 0 ? ((sourceStats.won_leads / sourceStats.total_leads) * 100).toFixed(1) : '0.0';
                                rowHTML += `<td>${sourceStats.total_leads} (${sourceStats.won_leads} won, ${sourceWinRate}%)</td>`;
                            });
                        }
                        
                        tr.innerHTML = rowHTML;
                        tbody.appendChild(tr);
                    });
                } else {
                    const colspan = data.sources ? 4 + data.sources.length : 4;
                    tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center">No data available</td></tr>`;
                }
            })
            .catch(error => {
                console.error('Error loading source leads data:', error);
                document.getElementById('sourceLeadsTableBody').innerHTML = 
                    '<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>';
            });
    }

    function loadWalkinLeadsDataWithFilter(params) {
        const queryString = new URLSearchParams(params).toString();
        fetch(`/api/branch_analytics/walkin_leads?${queryString}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('walkinLeadsTableBody');
                tbody.innerHTML = '';
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.ps_name}</td>
                            <td>${row.total_walkin_leads}</td>
                            <td>${row.pending_leads}</td>
                            <td>${row.lost_leads}</td>
                            <td>${row.won_leads}</td>
                            <td>${row.today_followups}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No data available</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading walkin leads data:', error);
                document.getElementById('walkinLeadsTableBody').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>';
            });
    }

    function loadBranchSummaryDataWithFilter(params) {
        const queryString = new URLSearchParams(params).toString();
        fetch(`/api/branch_analytics/summary?${queryString}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    document.getElementById('totalLeadsAssigned').textContent = data.data.total_leads_assigned;
                    document.getElementById('totalPendingLeads').textContent = data.data.total_pending_leads;
                    document.getElementById('totalWonLeads').textContent = data.data.total_won_leads;
                    document.getElementById('totalLostLeads').textContent = data.data.total_lost_leads;
                } else {
                    console.error('Error loading branch summary data:', data.message);
                    document.getElementById('totalLeadsAssigned').textContent = '-';
                    document.getElementById('totalPendingLeads').textContent = '-';
                    document.getElementById('totalWonLeads').textContent = '-';
                    document.getElementById('totalLostLeads').textContent = '-';
                }
            })
            .catch(error => {
                console.error('Error loading branch summary data:', error);
                document.getElementById('totalLeadsAssigned').textContent = '-';
                document.getElementById('totalPendingLeads').textContent = '-';
                document.getElementById('totalWonLeads').textContent = '-';
                document.getElementById('totalLostLeads').textContent = '-';
            });
    }

    // Analytics Filter Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Set default dates (current month)
        const today = new Date();
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        
        document.getElementById('analyticsDateFrom').value = monthStart.toISOString().split('T')[0];
        document.getElementById('analyticsDateTo').value = today.toISOString().split('T')[0];
        
        // Apply filter button
        document.getElementById('applyAnalyticsFilter').addEventListener('click', function() {
            loadAnalyticsDataWithFilter();
        });
        
        // Reset filter button
        document.getElementById('resetAnalyticsFilter').addEventListener('click', function() {
            // Reset to current month
            const today = new Date();
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('analyticsDateFrom').value = monthStart.toISOString().split('T')[0];
            document.getElementById('analyticsDateTo').value = today.toISOString().split('T')[0];
            loadAnalyticsDataWithFilter(); // Load with default current month filter
        });
    });

    // Export event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Export button event listeners
        document.getElementById('exportPSLeads').addEventListener('click', () => exportLeadsData('PS'));
        document.getElementById('exportWalkinLeads').addEventListener('click', () => exportLeadsData('Walkin'));
        document.getElementById('exportEventLeads').addEventListener('click', () => exportLeadsData('Event'));
        
        // Set default dates (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        document.getElementById('exportDateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('exportDateTo').value = today.toISOString().split('T')[0];
    });

    // OPTIMIZED: Load initial data with better performance
    document.addEventListener('DOMContentLoaded', function() {
        const pageLoadStartTime = performance.now();
        console.log('[DEBUG] DOM Content Loaded - Starting initialization...');
        
        // Load dynamic sources
        console.log('[DEBUG] Loading dynamic sources...');
        loadDynamicSources();
        
        // Load analytics data by default with timeout
        setTimeout(() => {
            console.log('[DEBUG] Loading analytics data...');
            loadAnalyticsDataWithFilter();
        }, 100); // Small delay to ensure DOM is ready
        
        // Ensure table responsiveness after a short delay
        setTimeout(() => {
            ensureTableResponsiveness();
        }, 500);
        
        // Add window resize listener for table responsiveness
        window.addEventListener('resize', function() {
            setTimeout(() => {
                ensureTableResponsiveness();
            }, 100);
        });
        
        // Debug: Check if tab elements exist
        console.log('Checking tab elements...');
        console.log('Analytics tab:', document.getElementById('analytics'));
        console.log('Fresh tab:', document.getElementById('fresh'));
        console.log('Fresh-leads tab:', document.getElementById('fresh-leads'));
        console.log('Followup tab:', document.getElementById('followup'));
        console.log('Export tab:', document.getElementById('export'));
        
        // Test tab functionality
        console.log('Testing tab functionality...');
        const tabLinks = document.querySelectorAll('.nav-tabs .nav-link');
        console.log('Tab links found:', tabLinks.length);
        
        tabLinks.forEach((link, index) => {
            console.log(`Tab ${index}:`, link.textContent.trim(), link.getAttribute('href'));
            link.addEventListener('click', function(e) {
                console.log('Tab clicked:', this.textContent.trim(), this.getAttribute('href'));
            });
        });
        
        // Update current date and time
        function updateDateTime() {
            const now = new Date();
            const options = { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            };
            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = now.toLocaleDateString('en-US', options);
            }
        }
        
        updateDateTime();
        setInterval(updateDateTime, 60000); // Update every minute
        
        // Add loading indicators for better UX
        const loadingSpinner = '<i class="fas fa-spinner fa-spin me-2"></i>';
        
        // Show loading state for KPI cards
        document.querySelectorAll('.kpi-card h3').forEach(card => {
            if (card.textContent === '-') {
                card.innerHTML = loadingSpinner + 'Loading...';
            }
        });
        
        const pageLoadTime = performance.now() - pageLoadStartTime;
        console.log(`[DEBUG] Page initialization completed in ${pageLoadTime.toFixed(3)}s`);
        logPerformanceMetric('page_initialization', pageLoadTime / 1000);
    });

    // OPTIMIZED: Date filter functionality for All Leads, Fresh Leads, and Today's Follow-ups sections
    document.addEventListener('DOMContentLoaded', function() {
        // Setup date filters for both sections
        setupDateFilter('freshLeadsDateFilter', 'dateRangeContainer', 'dateRangeContainer2', 'freshLeadsDateFrom', 'freshLeadsDateTo');
        setupDateFilter('freshLeadsSectionDateFilter', 'freshLeadsSectionDateRangeContainer', 'freshLeadsSectionDateRangeContainer2', 'freshLeadsSectionDateFrom', 'freshLeadsSectionDateTo');
        setupDateFilter('followupLeadsDateFilter', 'followupDateRangeContainer', 'followupDateRangeContainer2', 'followupLeadsDateFrom', 'followupLeadsDateTo');
        
        function setupDateFilter(filterId, container1Id, container2Id, fromId, toId) {
            const dateFilter = document.getElementById(filterId);
            const dateRangeContainer = document.getElementById(container1Id);
            const dateRangeContainer2 = document.getElementById(container2Id);
            const dateFrom = document.getElementById(fromId);
            const dateTo = document.getElementById(toId);
            
            if (dateFilter) {
                dateFilter.addEventListener('change', function() {
                    const filterValue = this.value;
                    
                    // Handle different container structures
                    let dateRangeRow = null;
                    if (filterId === 'freshLeadsDateFilter') {
                        dateRangeRow = document.getElementById('dateRangeRow');
                    } else if (filterId === 'freshLeadsSectionDateFilter') {
                        dateRangeRow = document.getElementById('freshLeadsSectionDateRangeRow');
                    } else if (filterId === 'followupLeadsDateFilter') {
                        dateRangeRow = document.getElementById('followupDateRangeRow');
                    }
                    
                    // Hide date range inputs by default
                    if (dateRangeRow) {
                        dateRangeRow.style.display = 'none';
                    } else {
                        if (dateRangeContainer) dateRangeContainer.style.display = 'none';
                        if (dateRangeContainer2) dateRangeContainer2.style.display = 'none';
                    }
                    
                    if (filterValue === 'date_range') {
                        // Show date range inputs
                        if (dateRangeRow) {
                            dateRangeRow.style.display = 'block';
                        } else {
                            if (dateRangeContainer) dateRangeContainer.style.display = 'block';
                            if (dateRangeContainer2) dateRangeContainer2.style.display = 'block';
                        }
                        
                        // Clear date values when switching to date range
                        if (dateFrom) dateFrom.value = '';
                        if (dateTo) dateTo.value = '';
                    } else if (filterValue === 'today') {
                        // Set today's date
                        const today = new Date();
                        const formatDate = (date) => {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        };
                        
                        if (dateFrom && dateTo) {
                            dateFrom.value = formatDate(today);
                            dateTo.value = formatDate(today);
                        }
                    } else {
                        // Clear date values for "All Time"
                        if (dateFrom) dateFrom.value = '';
                        if (dateTo) dateTo.value = '';
                    }
                });
            }
        }
        
        // Apply filter button for All Leads
        const applyButton = document.getElementById('freshLeadsApplyFiltersBtn');
        if (applyButton) {
            applyButton.addEventListener('click', function() {
                console.log('Apply button clicked - reloading data');
                loadSection('fresh_leads');
            });
        }
        
        // Reset filter button for All Leads
        const resetButton = document.getElementById('freshLeadsResetFiltersBtn');
        if (resetButton) {
            resetButton.addEventListener('click', function() {
                console.log('Reset button clicked - clearing filters');
                // Clear all filters
                const psSelect = document.getElementById('freshLeadsPsSelect');
                const sourceSelect = document.getElementById('freshLeadsSourceSelect');
                const statusSelect = document.getElementById('freshLeadsStatusSelect');
                const dateFilterSelect = document.getElementById('freshLeadsDateFilter');
                const dateFromInput = document.getElementById('freshLeadsDateFrom');
                const dateToInput = document.getElementById('freshLeadsDateTo');
                
                if (psSelect) psSelect.value = '';
                if (sourceSelect) sourceSelect.value = '';
                if (statusSelect) statusSelect.value = '';
                if (dateFilterSelect) dateFilterSelect.value = '';
                if (dateFromInput) dateFromInput.value = '';
                if (dateToInput) dateToInput.value = '';
                
                // Hide date range containers
                const dateRangeRow = document.getElementById('dateRangeRow');
                if (dateRangeRow) dateRangeRow.style.display = 'none';
                
                // Reload data with cleared filters
                loadSection('fresh_leads');
            });
        }
        
        // Apply filter button for Fresh Leads Section
        const freshLeadsSectionApplyButton = document.getElementById('freshLeadsSectionApplyFiltersBtn');
        if (freshLeadsSectionApplyButton) {
            freshLeadsSectionApplyButton.addEventListener('click', function() {
                console.log('Fresh Leads Section Apply button clicked - reloading data');
                loadSection('fresh_leads_section');
            });
        }
        
        // Reset filter button for Fresh Leads Section
        const freshLeadsSectionResetButton = document.getElementById('freshLeadsSectionResetFiltersBtn');
        if (freshLeadsSectionResetButton) {
            freshLeadsSectionResetButton.addEventListener('click', function() {
                console.log('Fresh Leads Section Reset button clicked - clearing filters');
                // Clear all filters for fresh leads section
                const psSelect = document.getElementById('freshLeadsSectionPsSelect');
                const dateFilterSelect = document.getElementById('freshLeadsSectionDateFilter');
                const dateFromInput = document.getElementById('freshLeadsSectionDateFrom');
                const dateToInput = document.getElementById('freshLeadsSectionDateTo');
                
                if (psSelect) psSelect.value = '';
                if (dateFilterSelect) dateFilterSelect.value = '';
                if (dateFromInput) dateFromInput.value = '';
                if (dateToInput) dateToInput.value = '';
                
                // Hide date range containers
                const dateRangeRow = document.getElementById('freshLeadsSectionDateRangeRow');
                if (dateRangeRow) dateRangeRow.style.display = 'none';
                
                // Reload data with cleared filters
                loadSection('fresh_leads_section');
            });
        }
        
        // Apply filter button for Followup Leads
        const followupApplyButton = document.getElementById('followupLeadsApplyFiltersBtn');
        if (followupApplyButton) {
            followupApplyButton.addEventListener('click', function() {
                console.log('Followup Apply button clicked - reloading data');
                loadSection('followup_leads');
            });
        }
        
        // Reset filter button for Followup Leads
        const followupResetButton = document.getElementById('followupLeadsResetFiltersBtn');
        if (followupResetButton) {
            followupResetButton.addEventListener('click', function() {
                console.log('Followup Reset button clicked - clearing filters');
                // Clear all filters for followup section
                const psSelect = document.getElementById('followupLeadsPsSelect');
                
                if (psSelect) psSelect.value = '';
                
                // Reload data with cleared filters
                loadSection('followup_leads');
            });
        }
    });

    // Tab change event
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const targetId = e.target.getAttribute('href').substring(1);
            if (targetId === 'fresh') {
                loadSection('fresh_leads');
            } else if (targetId === 'fresh-leads') {
                loadSection('fresh_leads_section');
            } else if (targetId === 'followup') {
                loadSection('followup_leads');
            } else if (targetId === 'analytics') {
                loadAnalyticsDataWithFilter();
            }
        });
});

// Function to show call attempt history for a lead
function showCallHistory(uid) {
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('callAttemptHistoryModal'));
    modal.show();
    
    // Clear previous data
    document.getElementById('callHistorySummary').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading call history...';
    document.getElementById('callHistoryTableBody').innerHTML = '<tr><td colspan="9" class="text-center">Loading...</td></tr>';
    
    // Fetch call history data
    fetch(`/api/lead_call_history/${uid}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.history.length > 0) {
                // Update summary
                const summary = data.summary;
                document.getElementById('callHistorySummary').innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Total Calls Made:</strong> ${summary.total_calls} &nbsp; | &nbsp; 
                    <strong>RNR Calls:</strong> ${summary.rnr_calls} &nbsp; | &nbsp; 
                    <strong>Busy on another Call:</strong> ${summary.busy_calls} &nbsp; | &nbsp; 
                    <strong>Call me Back:</strong> ${summary.call_me_back} &nbsp; | &nbsp; 
                    <strong>Call not Connected:</strong> ${summary.call_not_connected} &nbsp; | &nbsp; 
                    <strong>Connected Calls:</strong> ${summary.connected_calls}
                `;
                
                // Update table
                const tbody = document.getElementById('callHistoryTableBody');
                tbody.innerHTML = '';
                
                data.history.forEach(call => {
                    const tr = document.createElement('tr');
                    
                    // Format timestamp with +5:30 offset and dd/mm/yyyy hh:mm AM/PM format
                    let timestamp = '';
                    if (call.timestamp) {
                        timestamp = formatTimestampWithOffset(call.timestamp);
                    }
                    
                    // Format follow-up date
                    let followUpDate = '';
                    if (call.follow_up_date) {
                        followUpDate = formatDate(call.follow_up_date);
                    }
                    
                    tr.innerHTML = `
                        <td>${call.uid || ''}</td>
                        <td><span class="badge bg-primary">${call.call_no || ''}</span></td>
                        <td><span class="badge bg-secondary">${call.attempt || ''}</span></td>
                        <td data-status="${call.status || ''}" class="status-cell">
                            <strong>${call.status || ''}</strong>
                        </td>
                        <td><span class="badge bg-${call.role === 'CRE' ? 'info' : 'success'}">${call.role || ''}</span></td>
                        <td>${call.name || ''}</td>
                        <td><small>${timestamp}</small></td>
                        <td>${call.remarks || ''}</td>
                        <td><small>${followUpDate}</small></td>
                    `;
                    
                    tbody.appendChild(tr);
                });
            } else {
                document.getElementById('callHistorySummary').innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No call attempt history found for this lead.</div>';
                document.getElementById('callHistoryTableBody').innerHTML = '<tr><td colspan="9" class="text-center text-muted">No call history available</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading call history:', error);
            document.getElementById('callHistorySummary').innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Failed to load call attempt history.</div>';
            document.getElementById('callHistoryTableBody').innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading call history</td></tr>';
        });
}

// Helper function to get badge class for status
function getStatusBadgeClass(status) {
    if (!status) return 'secondary';
    
    const statusLower = status.toLowerCase();
    if (statusLower.includes('interested') || statusLower.includes('booked') || statusLower.includes('test drive')) {
        return 'success';
    } else if (statusLower.includes('not interested') || statusLower.includes('lost')) {
        return 'danger';
    } else if (statusLower.includes('rnr') || statusLower.includes('busy') || statusLower.includes('call me back')) {
        return 'warning';
    } else if (statusLower.includes('call not connected')) {
        return 'secondary';
    } else {
        return 'info';
    }
}
</script>
{% endblock %} 