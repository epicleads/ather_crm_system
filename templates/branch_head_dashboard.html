
{% extends "base.html" %}
{% block title %}Branch Head Dashboard - Ather CRM{% endblock %}

{% block head %}
<style>
    /* Override container constraints for full width layout */
    .container-main {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 1rem !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        border: none !important;
    }
    
    /* Ensure full width for all content */
    .w-100 {
        width: 100% !important;
        max-width: 100% !important;
    }
    
    /* Improve table responsiveness for full width */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Better spacing for full width layout */
    .row {
        margin-left: 0;
        margin-right: 0;
    }
    
    .col, .col-md-3, .col-md-4, .col-md-2, .col-auto {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
    
    /* KPI cards better spacing for full width */
    .card-body.p-2 {
        padding: 1rem !important;
    }
    
    /* Tab navigation full width */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        width: 100%;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        padding: 0.5rem 0.5rem 0;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-radius: 6px 6px 0 0;
        color: #6c757d;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
        margin-right: 0.25rem;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: #007bff;
        color: #007bff;
        background: rgba(0, 123, 255, 0.1);
    }
    
    .nav-tabs .nav-link.active {
        border-color: #007bff;
        color: #007bff;
        background: white;
        border-bottom: 2px solid #007bff;
    }
    
    /* Enhanced dashboard styling for full width */
    .dashboard-header {
        background: linear-gradient(135deg, var(--airbnb-gray-100) 0%, var(--airbnb-white) 100%);
        border: 1px solid var(--airbnb-gray-200);
        border-radius: var(--airbnb-border-radius);
        margin-bottom: 1.5rem;
    }
    
    /* KPI cards enhanced for full width */
    .kpi-card {
        background: var(--airbnb-white);
        border: 1px solid var(--airbnb-gray-200);
        border-radius: var(--airbnb-border-radius);
        transition: all 0.3s ease;
        height: 100%;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    /* Loading spinner styling */
    .fa-spinner {
        margin-right: 0.5rem;
    }
    
    /* KPI loading state */
    .kpi-card .d-none {
        display: none !important;
    }
    
    /* Lead Category styling */
    .lead-category-not-set {
        background-color: #f8d7da;
        color: #721c24;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    /* Export section styling */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }
    
    .bg-gradient-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    }
    
    .card-header.bg-gradient-primary {
        border-bottom: none;
    }
    
    .form-control-lg, .form-select-lg {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .form-control-lg:focus, .form-select-lg:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .btn-lg {
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-lg:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .btn-group-vertical .btn {
        border-radius: 8px !important;
        margin-bottom: 0.5rem;
    }
    
    .btn-group-vertical .btn:last-child {
        margin-bottom: 0;
    }
    
    /* Export section responsive */
    @media (max-width: 768px) {
        .btn-group-vertical {
            flex-direction: row;
            gap: 0.5rem;
        }
        
        .btn-group-vertical .btn {
            flex: 1;
            margin-bottom: 0;
        }
    }
    
    .kpi-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--airbnb-shadow-hover);
        border-color: var(--airbnb-gray-300);
    }
    
    /* Table enhancements for full width */
    .table {
        margin-bottom: 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table thead th {
        background: linear-gradient(135deg, #495057 0%, #343a40 100%);
        color: white;
        border: none;
        font-weight: 600;
        padding: 1rem 0.75rem;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
        transform: scale(1.001);
    }
    
    .table tbody td {
        padding: 0.75rem;
        vertical-align: middle;
        border-color: #e9ecef;
    }
    
    .table th {
        background-color: var(--airbnb-gray-100);
        border-top: none;
        font-weight: 600;
        color: var(--airbnb-gray-700);
    }
    
    .table td {
        vertical-align: middle;
        border-top: 1px solid var(--airbnb-gray-200);
    }
    
    /* Filter section styling */
    .filter-section {
        background: var(--airbnb-gray-50);
        border: 1px solid var(--airbnb-gray-200);
        border-radius: var(--airbnb-border-radius);
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    /* Zoho Dashboard iframe styling for responsive height */
    .dashboard-iframe {
        width: 100%;
        height: 70vh;
        min-height: 600px;
        max-height: 900px;
        border: none;
        border-radius: 0;
        box-shadow: none;
    }
    
    .dashboard-card {
        margin-bottom: 1rem;
        border: 1px solid var(--airbnb-gray-200);
        border-radius: var(--airbnb-border-radius);
        overflow: hidden;
    }
    
    .dashboard-card .card-header {
        background: var(--airbnb-gray-100);
        border-bottom: 1px solid var(--airbnb-gray-200);
        padding: 0.75rem 1rem;
    }
    
    .dashboard-card .card-body {
        padding: 0;
    }
    
    /* Responsive design for mobile */
    @media (max-width: 768px) {
        .col-md-3, .col-md-4, .col-md-2 {
            margin-bottom: 0.5rem;
        }
        
        .nav-tabs .nav-link {
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }
        
        .kpi-card {
            min-height: 100px;
        }
        
        .kpi-card .h5 {
            font-size: 1.1rem;
        }
        
        .dashboard-iframe {
            height: 60vh;
            min-height: 500px;
            max-height: 700px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Full width layout without container constraints -->
<div class="w-100">
    <!-- Dashboard Header -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-1">
                        <i class="fas fa-chart-line me-2"></i>
                        Branch Head Dashboard
                    </h2>
                    <p class="text-muted mb-0">
                        Welcome back, {{ session.get('branch_head_name', 'Branch Head') }} | 
                        Branch: <strong>{{ session.get('branch_head_branch', 'N/A') }}</strong>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex justify-content-end align-items-center">
                        <span class="text-muted me-3">
                            <i class="fas fa-clock me-1"></i>
                            <span id="currentDateTime"></span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    




    <!-- Branch Summary KPI Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card kpi-card border-primary">
                <div class="card-body p-3 text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="fas fa-users fa-2x text-primary me-3"></i>
                        <div>
                            <h3 class="mb-0" id="totalLeadsAssigned">-</h3>
                            <small class="text-muted">Total Leads Assigned</small>
                        </div>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card kpi-card border-warning">
                <div class="card-body p-3 text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="fas fa-clock fa-2x text-warning me-3"></i>
                        <div>
                            <h3 class="mb-0" id="totalPendingLeads">-</h3>
                            <small class="text-muted">Pending Leads</small>
                        </div>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card kpi-card border-success">
                <div class="card-body p-3 text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="fas fa-trophy fa-2x text-success me-3"></i>
                        <div>
                            <h3 class="mb-0" id="totalWonLeads">-</h3>
                            <small class="text-muted">Won Leads</small>
                        </div>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card kpi-card border-danger">
                <div class="card-body p-3 text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <i class="fas fa-times-circle fa-2x text-danger me-3"></i>
                        <div>
                            <h3 class="mb-0" id="totalLostLeads">-</h3>
                            <small class="text-muted">Lost Leads</small>
                        </div>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="card mb-4">
        <div class="card-body p-0">
            <ul class="nav nav-tabs" id="leadTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="analytics-tab" data-bs-toggle="tab" href="#analytics" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>Analytics Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="followup-tab" data-bs-toggle="tab" href="#followup" role="tab">
                        <i class="fas fa-calendar-check me-2"></i>Today's Follow-ups
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="fresh-tab" data-bs-toggle="tab" href="#fresh" role="tab">
                        <i class="fas fa-users me-2"></i>All Leads
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="fresh-leads-tab" data-bs-toggle="tab" href="#fresh-leads" role="tab">
                        <i class="fas fa-star me-2"></i>Fresh Leads
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="export-tab" data-bs-toggle="tab" href="#export" role="tab">
                        <i class="fas fa-file-export me-2"></i>Export Leads
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="tab-content" id="leadTabsContent">
        <!-- Analytics Dashboard Tab -->
        <div class="tab-pane fade show active" id="analytics" role="tabpanel">
            <!-- Global Analytics Filter -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Analytics Filter
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="analyticsDateFrom" class="form-label fw-semibold">From Date:</label>
                            <input type="date" id="analyticsDateFrom" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="analyticsDateTo" class="form-label fw-semibold">To Date:</label>
                            <input type="date" id="analyticsDateTo" class="form-control">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button id="applyAnalyticsFilter" class="btn btn-primary me-2">
                                <i class="fas fa-search me-1"></i>Apply Filter
                            </button>
                            <button id="resetAnalyticsFilter" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Specialist Performance Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Product Specialist Performance
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="psPerformanceTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Product Specialist</th>
                                    <th>Leads Assigned (ps_assigned_at)</th>
                                    <th>Leads Contacted (lead_status not null)</th>
                                    <th>Gap (Assigned - Contacted)</th>
                                </tr>
                            </thead>
                            <tbody id="psPerformanceTableBody">
                                <tr><td colspan="4" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Source-wise Leads Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Source-wise Leads Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="sourceLeadsTable">
                            <thead class="thead-dark" id="sourceLeadsTableHead">
                                <tr>
                                    <th>Product Specialist</th>
                                    <th>Total Leads</th>
                                    <th>Won Leads</th>
                                    <th>Win Rate (%)</th>
                                    <!-- Dynamic source columns will be added here -->
                                </tr>
                            </thead>
                            <tbody id="sourceLeadsTableBody">
                                <tr><td colspan="4" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Walk-in Leads Table -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-store me-2"></i>Walk-in Leads Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="walkinLeadsTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Product Specialist</th>
                                    <th>Total Walk-in Leads</th>
                                    <th>Pending Leads</th>
                                    <th>Lost Leads</th>
                                    <th>Won Leads</th>
                                    <th>Today's Follow-ups</th>
                                </tr>
                            </thead>
                            <tbody id="walkinLeadsTableBody">
                                <tr><td colspan="6" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Branch Head Dashboards -->
            <div class="card mb-3">
                <div class="card-body">
                    <div id="branchHeadDashboardsContainer">
                        <!-- Branch Head dashboards will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- All Leads Tab -->
        <div class="tab-pane fade" id="fresh" role="tabpanel">
            <div class="card mb-2">
                <div class="card-body p-3">
                    <!-- Section-specific Filter Controls -->
                    <div class="filter-section mb-2">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label for="freshLeadsPsSelect" class="fw-semibold small">Product Specialist:</label>
                                <select id="freshLeadsPsSelect" class="form-select form-select-sm">
                                    <option value="">-- All PS --</option>
                                    {% for ps in ps_users %}
                                        <option value="{{ ps.name }}">{{ ps.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="freshLeadsStatusSelect" class="fw-semibold small">Final Status:</label>
                                <select id="freshLeadsStatusSelect" class="form-select form-select-sm">
                                    <option value="">-- All Statuses --</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Won">Won</option>
                                    <option value="Lost">Lost</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="freshLeadsDateFilter" class="fw-semibold small">Date Filter:</label>
                                <select id="freshLeadsDateFilter" class="form-select form-select-sm">
                                    <option value="">-- All Time --</option>
                                    <option value="today">Today</option>
                                    <option value="date_range">Date Range</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button id="freshLeadsApplyFiltersBtn" class="btn btn-primary btn-sm me-2">Apply</button>
                                <button id="freshLeadsResetFiltersBtn" class="btn btn-outline-secondary btn-sm">Reset</button>
                            </div>
                        </div>
                        <!-- Date Range Row - Hidden by default -->
                        <div class="row g-2 mt-2" id="dateRangeRow" style="display: none;">
                            <div class="col-md-3" id="dateRangeContainer">
                                <label for="freshLeadsDateFrom" class="fw-semibold small">From Date:</label>
                                <input type="date" id="freshLeadsDateFrom" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-3" id="dateRangeContainer2">
                                <label for="freshLeadsDateTo" class="fw-semibold small">To Date:</label>
                                <input type="date" id="freshLeadsDateTo" class="form-control form-control-sm">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <div class="input-group input-group-sm">
                                <input type="text" id="freshLeadsSearchInput" class="form-control" placeholder="Search by name, mobile, UID...">
                                <button class="btn btn-outline-primary btn-sm" type="button" id="freshLeadsSearchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" type="button" id="freshLeadsClearButton">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm mb-0" id="freshLeadsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="py-2">UID</th>
                                    <th class="py-2">Customer Name</th>
                                    <th class="py-2">Phone No.</th>
                                    <th class="py-2">Final Status</th>
                                    <th class="py-2">PS Name</th>
                                    <th class="py-2">Source</th>
                                    <th class="py-2">Lead Category</th>
                                    <th class="py-2">PS Assigned At</th>
                                    <th class="py-2">Created At</th>
                                </tr>
                            </thead>
                            <tbody id="freshLeadsTableBody">
                                <tr><td colspan="9" class="text-center py-2">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fresh Leads Tab -->
        <div class="tab-pane fade" id="fresh-leads" role="tabpanel">
            <div class="card mb-2">
                <div class="card-body p-3">
                    <!-- Section-specific Filter Controls -->
                    <div class="filter-section mb-2">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label for="freshLeadsSectionPsSelect" class="fw-semibold small">Product Specialist:</label>
                                <select id="freshLeadsSectionPsSelect" class="form-select form-select-sm">
                                    <option value="">-- All PS --</option>
                                    {% for ps in ps_users %}
                                        <option value="{{ ps.name }}">{{ ps.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="freshLeadsSectionDateFilter" class="fw-semibold small">Date Filter:</label>
                                <select id="freshLeadsSectionDateFilter" class="form-select form-select-sm">
                                    <option value="">-- All Time --</option>
                                    <option value="today">Today</option>
                                    <option value="date_range">Date Range</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button id="freshLeadsSectionApplyFiltersBtn" class="btn btn-primary btn-sm me-2">Apply</button>
                                <button id="freshLeadsSectionResetFiltersBtn" class="btn btn-outline-secondary btn-sm">Reset</button>
                            </div>
                        </div>
                        <!-- Date Range Row - Hidden by default -->
                        <div class="row g-2 mt-2" id="freshLeadsSectionDateRangeRow" style="display: none;">
                            <div class="col-md-3" id="freshLeadsSectionDateRangeContainer">
                                <label for="freshLeadsSectionDateFrom" class="fw-semibold small">From Date:</label>
                                <input type="date" id="freshLeadsSectionDateFrom" class="form-control form-control-sm">
                            </div>
                            <div class="col-md-3" id="freshLeadsSectionDateRangeContainer2">
                                <label for="freshLeadsSectionDateTo" class="fw-semibold small">To Date:</label>
                                <input type="date" id="freshLeadsSectionDateTo" class="form-control form-control-sm">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <div class="input-group input-group-sm">
                                <input type="text" id="freshLeadsSectionSearchInput" class="form-control" placeholder="Search by name, mobile, UID...">
                                <button class="btn btn-outline-primary btn-sm" type="button" id="freshLeadsSectionSearchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" type="button" id="freshLeadsSectionClearButton">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm mb-0" id="freshLeadsSectionTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="py-2">UID</th>
                                    <th class="py-2">Customer Name</th>
                                    <th class="py-2">Phone No.</th>
                                    <th class="py-2">Final Status</th>
                                    <th class="py-2">PS Name</th>
                                    <th class="py-2">Source</th>
                                    <th class="py-2">Lead Category</th>
                                    <th class="py-2">PS Assigned At</th>
                                    <th class="py-2">Created At</th>
                                </tr>
                            </thead>
                            <tbody id="freshLeadsSectionTableBody">
                                <tr><td colspan="9" class="text-center py-2">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Follow-ups Tab -->
        <div class="tab-pane fade" id="followup" role="tabpanel">
            <div class="card mb-2">
                <div class="card-header bg-primary text-white py-2">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar-check me-2"></i>Today's Follow-ups
                    </h6>
                </div>
                <div class="card-body p-3">
                    <!-- Section-specific Filter Controls -->
                    <div class="filter-section mb-2 p-2 bg-light rounded">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="followupLeadsPsSelect" class="fw-semibold text-dark small">Product Specialist:</label>
                                <select id="followupLeadsPsSelect" class="form-select form-select-sm">
                                    <option value="">-- All PS --</option>
                                    {% for ps in ps_users %}
                                        <option value="{{ ps.name }}">{{ ps.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button id="followupLeadsApplyFiltersBtn" class="btn btn-primary btn-sm me-2">
                                    <i class="fas fa-filter me-1"></i>Apply
                                </button>
                                <button id="followupLeadsResetFiltersBtn" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-undo me-1"></i>Reset
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div class="row mb-2">
                        <div class="col-md-8">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" id="followupLeadsSearchInput" class="form-control" placeholder="Search by name, mobile, UID...">
                                <button class="btn btn-outline-primary btn-sm" type="button" id="followupLeadsSearchButton">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" type="button" id="followupLeadsClearButton">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-center justify-content-end">
                            <div class="badge bg-info small">
                                <i class="fas fa-info-circle me-1"></i>
                                Today's follow-ups only
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm mb-0" id="followupLeadsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="py-2">UID</th>
                                    <th class="py-2">Customer Name</th>
                                    <th class="py-2">Phone No.</th>
                                    <th class="py-2">Source</th>
                                    <th class="py-2">Lead Category</th>
                                    <th class="py-2">Lead Status</th>
                                    <th class="py-2">PS Name</th>
                                    <th class="py-2">Follow-up Date</th>
                                </tr>
                            </thead>
                            <tbody id="followupLeadsTableBody">
                                <tr><td colspan="8" class="text-center py-2">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading today's follow-ups...
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Leads Tab -->
        <div class="tab-pane fade" id="export" role="tabpanel">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <label for="exportDateFrom" class="form-label">
                                <i class="fas fa-calendar-alt me-1"></i>From Date
                            </label>
                            <input type="date" id="exportDateFrom" class="form-control">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="exportDateTo" class="form-label">
                                <i class="fas fa-calendar-alt me-1"></i>To Date
                            </label>
                            <input type="date" id="exportDateTo" class="form-control">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="exportBranch" class="form-label">
                                <i class="fas fa-building me-1"></i>Branch
                            </label>
                            <select id="exportBranch" class="form-select">
                                <option value="{{ session.get('branch_head_branch', 'N/A') }}">{{ session.get('branch_head_branch', 'N/A') }}</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6 d-flex align-items-end">
                            <div class="d-grid gap-2 w-100">
                                <div class="btn-group-vertical w-100" role="group">
                                    <button type="button" class="btn btn-primary mb-2" id="exportPSLeads">
                                        <i class="fas fa-download me-2"></i>PS Leads
                                    </button>
                                    <button type="button" class="btn btn-success mb-2" id="exportWalkinLeads">
                                        <i class="fas fa-download me-2"></i>Walk-in Leads
                                    </button>
                                    <button type="button" class="btn btn-info" id="exportEventLeads">
                                        <i class="fas fa-download me-2"></i>Event Leads
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Configuration for sections
const sectionConfig = {
  fresh_leads: {
    tab: 'fresh-tab',
    tbody: 'freshLeadsTableBody',
            psSelectId: 'freshLeadsPsSelect',
            statusSelectId: 'freshLeadsStatusSelect',
            dateFilterId: 'freshLeadsDateFilter',
            dateFromId: 'freshLeadsDateFrom',
            dateToId: 'freshLeadsDateTo',
            searchId: 'freshLeadsSearchInput',
            columns: ['uid', 'customer_name', 'customer_mobile_number', 'final_status', 'ps_name', 'source', 'lead_category', 'ps_assigned_at', 'created_at']
  },
  fresh_leads_section: {
    tab: 'fresh-leads-tab',
    tbody: 'freshLeadsSectionTableBody',
            psSelectId: 'freshLeadsSectionPsSelect',
            dateFilterId: 'freshLeadsSectionDateFilter',
            dateFromId: 'freshLeadsSectionDateFrom',
            dateToId: 'freshLeadsSectionDateTo',
            searchId: 'freshLeadsSectionSearchInput',
            columns: ['uid', 'customer_name', 'customer_mobile_number', 'final_status', 'ps_name', 'source', 'lead_category', 'ps_assigned_at', 'created_at']
  },
  followup_leads: {
    tab: 'followup-tab',
    tbody: 'followupLeadsTableBody',
            psSelectId: 'followupLeadsPsSelect',
            searchId: 'followupLeadsSearchInput',
            columns: ['uid', 'customer_name', 'customer_mobile_number', 'source', 'lead_category', 'lead_status', 'ps_name', 'follow_up_date']
        }
    };

    // OPTIMIZED: Load section data with improved performance and server-side filtering
    function loadSection(section) {
        const config = sectionConfig[section];
        const tbody = document.getElementById(config.tbody);
        
        // Show loading state for table
        tbody.innerHTML = '<tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</td></tr>';
        
        // Get filter values
        const psSelect = document.getElementById(config.psSelectId);
        const sourceSelect = document.getElementById(config.sourceSelectId);
        const statusSelect = document.getElementById(config.statusSelectId);
        const dateFilter = document.getElementById(config.dateFilterId);
        const dateFrom = document.getElementById(config.dateFromId);
        const dateTo = document.getElementById(config.dateToId);
        const searchInput = document.getElementById(config.searchId);
        
        const ps_name = psSelect ? psSelect.value : '';
        const source = sourceSelect ? sourceSelect.value : '';
        const final_status = statusSelect ? statusSelect.value : '';
        const date_filter = dateFilter ? dateFilter.value : '';
        let start_date = dateFrom ? dateFrom.value : '';
        let end_date = dateTo ? dateTo.value : '';
        const searchTerm = searchInput ? searchInput.value.trim() : '';
        
        // Handle date filtering logic
        if (date_filter === 'today') {
            const today = new Date();
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            start_date = formatDate(today);
            end_date = formatDate(today);
        }
        
        // Make API call with filter parameters and timeout
        const params = new URLSearchParams({
            section: section,
            ps_name: ps_name,
            source: source,
            final_status: final_status,
            date_filter: date_filter,
            start_date: start_date,
            end_date: end_date,
            search: searchTerm
        });
        
        // Debug logging
        console.log('DEBUG: API call parameters:', {
            section: section,
            ps_name: ps_name,
            source: source,
            final_status: final_status,
            date_filter: date_filter,
            start_date: start_date,
            end_date: end_date,
            search: searchTerm
        });
        
        // Create AbortController for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // Reduced to 15 second timeout
        
        fetch(`/api/branch_head_dashboard_data?${params}`, {
            signal: controller.signal,
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        })
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update table efficiently
                tbody.innerHTML = '';
                if (data.rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No data found</td></tr>';
                } else {
                    // Use DocumentFragment for better performance
                    const fragment = document.createDocumentFragment();
                    
                    data.rows.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-search', Object.values(row).join(' ').toLowerCase());
                        
                        config.columns.forEach(column => {
                            const td = document.createElement('td');
                            const value = row[column] || '';
                            
                            // Special handling for lead_category column
                            if (column === 'lead_category' && value === 'Not Set') {
                                td.innerHTML = '<span class="lead-category-not-set">Not Set</span>';
                            } else {
                                td.textContent = value;
                            }
                            
                            tr.appendChild(td);
                        });
                        fragment.appendChild(tr);
                    });
                    
                    tbody.appendChild(fragment);
                }
            } else {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Error: ${data.error || 'Unknown error'}</td></tr>`;
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Error:', error);
            if (error.name === 'AbortError') {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-warning">Request timed out. Please try again.</td></tr>';
            } else {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading data. Please refresh the page.</td></tr>';
            }
        });
    }





    // Setup search functionality with client-side filtering
    function setupSearch(inputId, buttonId, clearId, tableId, sectionName) {
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);
        const clearBtn = document.getElementById(clearId);
        let searchTimeout;

        // Search button click
        if (button) {
            button.addEventListener('click', function() {
                filterTableData(sectionName);
            });
        }

        // Clear button click
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                input.value = '';
                filterTableData(sectionName);
            });
        }

        // Real-time search on input
        if (input) {
            input.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterTableData(sectionName);
                }, 300); // Debounce search
            });
        }
    }

    // Client-side table filtering with all filters
    function filterTableData(sectionName) {
        const config = sectionConfig[sectionName];
        const tbody = document.getElementById(config.tbody);
        const searchInput = document.getElementById(config.searchId);
        const psSelect = document.getElementById(config.psSelectId);
        const sourceSelect = document.getElementById(config.sourceSelectId);
        const statusSelect = document.getElementById(config.statusSelectId);
        
        // Get filter values
        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const psFilter = psSelect ? psSelect.value.toLowerCase().trim() : '';
        const sourceFilter = sourceSelect ? sourceSelect.value.toLowerCase().trim() : '';
        const statusFilter = statusSelect ? statusSelect.value.toLowerCase().trim() : '';
        
        // Get all rows
        const rows = tbody.querySelectorAll('tr');
        
        rows.forEach(row => {
            let showRow = true;
            
            // Search filter
            if (searchTerm) {
                const searchData = row.getAttribute('data-search') || '';
                if (!searchData.includes(searchTerm)) {
                    showRow = false;
                }
            }
            
            // PS filter
            if (showRow && psFilter && psFilter !== '-- all ps --') {
                let psCell;
                // PS Name column position depends on section
                if (sectionName === 'fresh_leads') {
                    psCell = row.querySelector('td:nth-child(5)'); // PS Name column (5th)
                } else if (sectionName === 'followup_leads') {
                    psCell = row.querySelector('td:nth-child(7)'); // PS Name column (7th)
                }
                if (psCell && !psCell.textContent.toLowerCase().includes(psFilter)) {
                    showRow = false;
                }
            }
            
            // Source filter - only apply to fresh_leads section for Source column
            if (showRow && sectionName === 'fresh_leads' && sourceFilter && sourceFilter !== '-- all sources --') {
                const sourceCell = row.querySelector('td:nth-child(6)'); // Source column (6th)
                if (sourceCell && !sourceCell.textContent.toLowerCase().includes(sourceFilter)) {
                    showRow = false;
                }
            }
            
            // Status filter - only apply to fresh_leads section for Final Status column
            if (showRow && sectionName === 'fresh_leads' && statusFilter && statusFilter !== '-- all statuses --') {
                const statusCell = row.querySelector('td:nth-child(4)'); // Final Status column (4th)
                if (statusCell && !statusCell.textContent.toLowerCase().includes(statusFilter)) {
                    showRow = false;
                }
            }
            
            // Show/hide row
            row.style.display = showRow ? '' : 'none';
        });
        
        // Update row count
        updateVisibleRowCount(sectionName);
    }
    
    // Update visible row count
    function updateVisibleRowCount(sectionName) {
        const config = sectionConfig[sectionName];
        const tbody = document.getElementById(config.tbody);
        const visibleRows = tbody.querySelectorAll('tr:not([style*="display: none"])').length;
        
        // You can add a counter element to show filtered count
    }

    // Event listeners for filter buttons
    const sections = ['fresh', 'followup'];
    sections.forEach(section => {
        const applyBtn = document.getElementById(section + 'LeadsApplyFiltersBtn');
        const resetBtn = document.getElementById(section + 'LeadsResetFiltersBtn');
        
        if (applyBtn) {
            applyBtn.addEventListener('click', function() {
                const sectionMap = {
                    'fresh': 'fresh_leads',
                    'followup': 'followup_leads'
                };
                filterTableData(sectionMap[section]);
            });
        }
        
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                const psSelect = document.getElementById(section + 'LeadsPsSelect');
                const sourceSelect = document.getElementById(section + 'LeadsSourceSelect');
                const statusSelect = document.getElementById(section + 'LeadsStatusSelect');
                const dateFilter = document.getElementById(section + 'LeadsDateFilter');
                const dateFrom = document.getElementById(section + 'LeadsDateFrom');
                const dateTo = document.getElementById(section + 'LeadsDateTo');
                const searchInput = document.getElementById(section + 'LeadsSearchInput');
                
                if (psSelect) psSelect.value = '';
                if (sourceSelect) sourceSelect.value = '';
                if (statusSelect) statusSelect.value = '';
                if (dateFilter) dateFilter.value = '';
                if (dateFrom) dateFrom.value = '';
                if (dateTo) dateTo.value = '';
                if (searchInput) searchInput.value = '';
                
                // Hide date range containers
                const dateRangeContainer = document.getElementById('dateRangeContainer');
                const dateRangeContainer2 = document.getElementById('dateRangeContainer2');
                if (dateRangeContainer) dateRangeContainer.style.display = 'none';
                if (dateRangeContainer2) dateRangeContainer2.style.display = 'none';
                
                const sectionMap = {
                    'fresh': 'fresh_leads',
                    'followup': 'followup_leads'
                };
                filterTableData(sectionMap[section]);
            });
        }
    });

    // Load dynamic sources for dropdowns
    function loadDynamicSources() {
        fetch('/api/branch_sources')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.sources) {
                    // Update all source dropdowns (only for All Leads section now)
                    const sourceDropdowns = [
                        'freshLeadsSourceSelect'
                    ];
                    
                    sourceDropdowns.forEach(dropdownId => {
                        const dropdown = document.getElementById(dropdownId);
                        if (dropdown) {
                            // Keep the first option (-- All Sources --)
                            const firstOption = dropdown.options[0];
                            dropdown.innerHTML = '';
                            dropdown.appendChild(firstOption);
                            
                            // Add dynamic sources
                            data.sources.forEach(source => {
                                const option = document.createElement('option');
                                option.value = source;
                                option.textContent = source;
                                dropdown.appendChild(option);
                            });
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error loading dynamic sources:', error);
            });
    }

    // Setup search for each section
    setupSearch('freshLeadsSearchInput', 'freshLeadsSearchButton', 'freshLeadsClearButton', 'freshLeadsTable', 'fresh_leads');
    setupSearch('freshLeadsSectionSearchInput', 'freshLeadsSectionSearchButton', 'freshLeadsSectionClearButton', 'freshLeadsSectionTable', 'fresh_leads_section');
    setupSearch('followupLeadsSearchInput', 'followupLeadsSearchButton', 'followupLeadsClearButton', 'followupLeadsTable', 'followup_leads');

// Load Branch Head dashboards
function loadBranchHeadDashboards() {
    fetch('/api/dashboards')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.dashboards['branch-head']) {
                const container = document.getElementById('branchHeadDashboardsContainer');
                let html = '';
                
                data.dashboards['branch-head'].forEach(dashboard => {
                    html += `
                            <div class="dashboard-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${dashboard.name}</h6>
                                <small class="text-muted">Added: ${new Date(dashboard.created_at).toLocaleDateString()}</small>
                            </div>
                            <div class="card-body p-0">
                                <iframe src="${dashboard.url}" 
                                            class="dashboard-iframe"
                                        frameborder="0">
                                </iframe>
                            </div>
                        </div>
                    `;
                });
                
                if (html === '') {
                    html = '<div class="text-center text-muted py-4"><i class="fas fa-chart-bar fa-3x mb-3"></i><p>No Branch Head dashboards configured yet.</p></div>';
                }
                
                container.innerHTML = html;
            } else {
                const container = document.getElementById('branchHeadDashboardsContainer');
                container.innerHTML = `<div class="text-center text-muted py-4">
                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                    <p>No Branch Head dashboards configured yet.</p>
                    <small class="text-muted">Debug: Response received but no Branch Head dashboards found</small>
                </div>`;
            }
        })
        .catch(error => {
            console.error('Error loading Branch Head dashboards:', error);
            const container = document.getElementById('branchHeadDashboardsContainer');
            container.innerHTML = `<div class="text-center text-danger py-4">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>Error loading dashboards. Please try again.</p>
            </div>`;
        });
}

// Load Analytics Data
function loadAnalyticsData() {
    // Load PS Performance Data
    loadPSPerformanceData();
    
    // Load Source-wise Leads Data
    loadSourceLeadsData();
    
    // Load Walk-in Leads Data
    loadWalkinLeadsData();
    
    // Load Branch Head Dashboards
    loadBranchHeadDashboards();
}

// Load Product Specialist Performance Data
function loadPSPerformanceData() {
    fetch('/api/branch_analytics/ps_performance')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('psPerformanceTableBody');
            tbody.innerHTML = '';
            
            if (data.success && data.data.length > 0) {
                data.data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.ps_name}</td>
                        <td>${row.leads_assigned}</td>
                        <td>${row.leads_contacted}</td>
                        <td>${row.gap}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No data available</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading PS performance data:', error);
            document.getElementById('psPerformanceTableBody').innerHTML = 
                '<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>';
        });
}

// Load Source-wise Leads Data
function loadSourceLeadsData() {
    fetch('/api/branch_analytics/source_leads')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('sourceLeadsTableBody');
            const thead = document.getElementById('sourceLeadsTableHead');
            tbody.innerHTML = '';
            
            if (data.success && data.data.length > 0) {
                // Update table headers with dynamic source columns
                const headerRow = thead.querySelector('tr');
                // Keep the first 4 columns (Product Specialist, Total Leads, Won Leads, Win Rate)
                headerRow.innerHTML = `
                    <th>Product Specialist</th>
                    <th>Total Leads</th>
                    <th>Won Leads</th>
                    <th>Win Rate (%)</th>
                `;
                
                // Add dynamic source columns
                if (data.sources && data.sources.length > 0) {
                    data.sources.forEach(source => {
                        const th = document.createElement('th');
                        th.textContent = source;
                        headerRow.appendChild(th);
                    });
                }
                
                // Populate table data
                data.data.forEach(row => {
                    const tr = document.createElement('tr');
                    const winRate = row.total_leads > 0 ? ((row.won_leads / row.total_leads) * 100).toFixed(1) : '0.0';
                    
                    // Start with the basic columns
                    let rowHTML = `
                        <td>${row.ps_name}</td>
                        <td>${row.total_leads}</td>
                        <td>${row.won_leads}</td>
                        <td>${winRate}%</td>
                    `;
                    
                    // Add dynamic source columns
                    if (data.sources && data.sources.length > 0) {
                        data.sources.forEach(source => {
                            const sourceStats = row.source_breakdown && row.source_breakdown[source] ? row.source_breakdown[source] : { total_leads: 0, won_leads: 0 };
                            const sourceWinRate = sourceStats.total_leads > 0 ? ((sourceStats.won_leads / sourceStats.total_leads) * 100).toFixed(1) : '0.0';
                            rowHTML += `<td>${sourceStats.total_leads} (${sourceStats.won_leads} won, ${sourceWinRate}%)</td>`;
                        });
                    }
                    
                    tr.innerHTML = rowHTML;
                    tbody.appendChild(tr);
                });
            } else {
                const colspan = data.sources ? 4 + data.sources.length : 4;
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center">No data available</td></tr>`;
            }
        })
        .catch(error => {
            console.error('Error loading source leads data:', error);
            document.getElementById('sourceLeadsTableBody').innerHTML = 
                '<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>';
        });
}

// Load Walk-in Leads Data
function loadWalkinLeadsData() {
    fetch('/api/branch_analytics/walkin_leads')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('walkinLeadsTableBody');
            tbody.innerHTML = '';
            
            if (data.success && data.data.length > 0) {
                data.data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.ps_name}</td>
                        <td>${row.total_walkin_leads}</td>
                        <td>${row.pending_leads}</td>
                        <td>${row.lost_leads}</td>
                        <td>${row.won_leads}</td>
                        <td>${row.today_followups}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No data available</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading walkin leads data:', error);
            document.getElementById('walkinLeadsTableBody').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>';
        });
}

    // Export functions
    function exportLeadsData(leadType) {
        const dateFrom = document.getElementById('exportDateFrom').value;
        const dateTo = document.getElementById('exportDateTo').value;
        const branch = document.getElementById('exportBranch').value;
        
        if (!dateFrom || !dateTo) {
            alert('Please select both From and To dates for export.');
            return;
        }
        
        if (!branch || branch === 'N/A') {
            alert('Please select a valid branch for export.');
            return;
        }
        
        // Show loading state
        const exportBtn = document.getElementById(`export${leadType}Leads`);
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exporting...';
        exportBtn.disabled = true;
        
        // Make export request
        fetch('/api/export_branch_leads', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                lead_type: leadType,
                date_from: dateFrom,
                date_to: dateTo,
                branch: branch
            })
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Export failed');
                });
            }
        })
        .then(blob => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${leadType}_leads_${dateFrom}_to_${dateTo}_${branch}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            // Reset button
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        })
        .catch(error => {
            console.error('Export error:', error);
            alert('Export failed. Please try again.');
            exportBtn.innerHTML = originalText;
            exportBtn.disabled = false;
        });
    }

    // Analytics Filter Functions
    function getAnalyticsFilterParams() {
        const dateFrom = document.getElementById('analyticsDateFrom').value;
        const dateTo = document.getElementById('analyticsDateTo').value;
        
        let params = {};
        
        // Always use date range - require both dates
                if (!dateFrom || !dateTo) {
            alert('Please select both From and To dates for the date range.');
                    return null;
                }
        
                params.date_from = dateFrom;
                params.date_to = dateTo;
        
        return params;
    }

    function loadAnalyticsDataWithFilter() {
        const params = getAnalyticsFilterParams();
        if (!params) return;
        
        // Load Branch Summary Data with filter
        loadBranchSummaryDataWithFilter(params);
        
        // Load PS Performance Data with filter
        loadPSPerformanceDataWithFilter(params);
        
        // Load Source-wise Leads Data with filter
        loadSourceLeadsDataWithFilter(params);
        
        // Load Walk-in Leads Data with filter
        loadWalkinLeadsDataWithFilter(params);
    }

    function loadPSPerformanceDataWithFilter(params) {
        const queryString = new URLSearchParams(params).toString();
        fetch(`/api/branch_analytics/ps_performance?${queryString}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('psPerformanceTableBody');
                tbody.innerHTML = '';
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.ps_name}</td>
                            <td>${row.leads_assigned}</td>
                            <td>${row.leads_contacted}</td>
                            <td>${row.gap}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">No data available</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading PS performance data:', error);
                document.getElementById('psPerformanceTableBody').innerHTML = 
                    '<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>';
            });
    }

    function loadSourceLeadsDataWithFilter(params) {
        const queryString = new URLSearchParams(params).toString();
        fetch(`/api/branch_analytics/source_leads?${queryString}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('sourceLeadsTableBody');
                const thead = document.getElementById('sourceLeadsTableHead');
                tbody.innerHTML = '';
                
                if (data.success && data.data.length > 0) {
                    // Update table headers with dynamic source columns
                    const headerRow = thead.querySelector('tr');
                    // Keep the first 4 columns (Product Specialist, Total Leads, Won Leads, Win Rate)
                    headerRow.innerHTML = `
                        <th>Product Specialist</th>
                        <th>Total Leads</th>
                        <th>Won Leads</th>
                        <th>Win Rate (%)</th>
                    `;
                    
                    // Add dynamic source columns
                    if (data.sources && data.sources.length > 0) {
                        data.sources.forEach(source => {
                            const th = document.createElement('th');
                            th.textContent = source;
                            headerRow.appendChild(th);
                        });
                    }
                    
                    // Populate table data
                    data.data.forEach(row => {
                        const tr = document.createElement('tr');
                        const winRate = row.total_leads > 0 ? ((row.won_leads / row.total_leads) * 100).toFixed(1) : '0.0';
                        
                        // Start with the basic columns
                        let rowHTML = `
                            <td>${row.ps_name}</td>
                            <td>${row.total_leads}</td>
                            <td>${row.won_leads}</td>
                            <td>${winRate}%</td>
                        `;
                        
                        // Add dynamic source columns
                        if (data.sources && data.sources.length > 0) {
                            data.sources.forEach(source => {
                                const sourceStats = row.source_breakdown && row.source_breakdown[source] ? row.source_breakdown[source] : { total_leads: 0, won_leads: 0 };
                                const sourceWinRate = sourceStats.total_leads > 0 ? ((sourceStats.won_leads / sourceStats.total_leads) * 100).toFixed(1) : '0.0';
                                rowHTML += `<td>${sourceStats.total_leads} (${sourceStats.won_leads} won, ${sourceWinRate}%)</td>`;
                            });
                        }
                        
                        tr.innerHTML = rowHTML;
                        tbody.appendChild(tr);
                    });
                } else {
                    const colspan = data.sources ? 4 + data.sources.length : 4;
                    tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center">No data available</td></tr>`;
                }
            })
            .catch(error => {
                console.error('Error loading source leads data:', error);
                document.getElementById('sourceLeadsTableBody').innerHTML = 
                    '<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>';
            });
    }

    function loadWalkinLeadsDataWithFilter(params) {
        const queryString = new URLSearchParams(params).toString();
        fetch(`/api/branch_analytics/walkin_leads?${queryString}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('walkinLeadsTableBody');
                tbody.innerHTML = '';
                
                if (data.success && data.data.length > 0) {
                    data.data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.ps_name}</td>
                            <td>${row.total_walkin_leads}</td>
                            <td>${row.pending_leads}</td>
                            <td>${row.lost_leads}</td>
                            <td>${row.won_leads}</td>
                            <td>${row.today_followups}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No data available</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading walkin leads data:', error);
                document.getElementById('walkinLeadsTableBody').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>';
            });
    }

    function loadBranchSummaryDataWithFilter(params) {
        const queryString = new URLSearchParams(params).toString();
        fetch(`/api/branch_analytics/summary?${queryString}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    document.getElementById('totalLeadsAssigned').textContent = data.data.total_leads_assigned;
                    document.getElementById('totalPendingLeads').textContent = data.data.total_pending_leads;
                    document.getElementById('totalWonLeads').textContent = data.data.total_won_leads;
                    document.getElementById('totalLostLeads').textContent = data.data.total_lost_leads;
                } else {
                    console.error('Error loading branch summary data:', data.message);
                    document.getElementById('totalLeadsAssigned').textContent = '-';
                    document.getElementById('totalPendingLeads').textContent = '-';
                    document.getElementById('totalWonLeads').textContent = '-';
                    document.getElementById('totalLostLeads').textContent = '-';
                }
            })
            .catch(error => {
                console.error('Error loading branch summary data:', error);
                document.getElementById('totalLeadsAssigned').textContent = '-';
                document.getElementById('totalPendingLeads').textContent = '-';
                document.getElementById('totalWonLeads').textContent = '-';
                document.getElementById('totalLostLeads').textContent = '-';
            });
    }

    // Analytics Filter Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Set default dates (current month)
        const today = new Date();
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        
        document.getElementById('analyticsDateFrom').value = monthStart.toISOString().split('T')[0];
        document.getElementById('analyticsDateTo').value = today.toISOString().split('T')[0];
        
        // Apply filter button
        document.getElementById('applyAnalyticsFilter').addEventListener('click', function() {
            loadAnalyticsDataWithFilter();
        });
        
        // Reset filter button
        document.getElementById('resetAnalyticsFilter').addEventListener('click', function() {
            // Reset to current month
            const today = new Date();
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('analyticsDateFrom').value = monthStart.toISOString().split('T')[0];
            document.getElementById('analyticsDateTo').value = today.toISOString().split('T')[0];
            loadAnalyticsDataWithFilter(); // Load with default current month filter
        });
    });

    // Export event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Export button event listeners
        document.getElementById('exportPSLeads').addEventListener('click', () => exportLeadsData('PS'));
        document.getElementById('exportWalkinLeads').addEventListener('click', () => exportLeadsData('Walkin'));
        document.getElementById('exportEventLeads').addEventListener('click', () => exportLeadsData('Event'));
        
        // Set default dates (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        document.getElementById('exportDateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('exportDateTo').value = today.toISOString().split('T')[0];
    });

    // OPTIMIZED: Load initial data with better performance
    document.addEventListener('DOMContentLoaded', function() {
        // Load dynamic sources
        loadDynamicSources();
        
        // Load analytics data by default with timeout
        setTimeout(() => {
            loadAnalyticsDataWithFilter();
        }, 100); // Small delay to ensure DOM is ready
        
        // Update current date and time
        function updateDateTime() {
            const now = new Date();
            const options = { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            };
            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = now.toLocaleDateString('en-US', options);
            }
        }
        
        updateDateTime();
        setInterval(updateDateTime, 60000); // Update every minute
        
        // Add loading indicators for better UX
        const loadingSpinner = '<i class="fas fa-spinner fa-spin me-2"></i>';
        
        // Show loading state for KPI cards
        document.querySelectorAll('.kpi-card h3').forEach(card => {
            if (card.textContent === '-') {
                card.innerHTML = loadingSpinner + 'Loading...';
            }
        });
    });

    // OPTIMIZED: Date filter functionality for All Leads and Fresh Leads sections
    document.addEventListener('DOMContentLoaded', function() {
        // Setup date filters for both sections
        setupDateFilter('freshLeadsDateFilter', 'dateRangeContainer', 'dateRangeContainer2', 'freshLeadsDateFrom', 'freshLeadsDateTo');
        setupDateFilter('freshLeadsSectionDateFilter', 'freshLeadsSectionDateRangeContainer', 'freshLeadsSectionDateRangeContainer2', 'freshLeadsSectionDateFrom', 'freshLeadsSectionDateTo');
        
        function setupDateFilter(filterId, container1Id, container2Id, fromId, toId) {
            const dateFilter = document.getElementById(filterId);
            const dateRangeContainer = document.getElementById(container1Id);
            const dateRangeContainer2 = document.getElementById(container2Id);
            const dateFrom = document.getElementById(fromId);
            const dateTo = document.getElementById(toId);
            
            if (dateFilter) {
                dateFilter.addEventListener('change', function() {
                    const filterValue = this.value;
                    
                    // Handle different container structures
                    let dateRangeRow = null;
                    if (filterId === 'freshLeadsDateFilter') {
                        dateRangeRow = document.getElementById('dateRangeRow');
                    } else if (filterId === 'freshLeadsSectionDateFilter') {
                        dateRangeRow = document.getElementById('freshLeadsSectionDateRangeRow');
                    }
                    
                    // Hide date range inputs by default
                    if (dateRangeRow) {
                        dateRangeRow.style.display = 'none';
                    } else {
                        if (dateRangeContainer) dateRangeContainer.style.display = 'none';
                        if (dateRangeContainer2) dateRangeContainer2.style.display = 'none';
                    }
                    
                    if (filterValue === 'date_range') {
                        // Show date range inputs
                        if (dateRangeRow) {
                            dateRangeRow.style.display = 'block';
                        } else {
                            if (dateRangeContainer) dateRangeContainer.style.display = 'block';
                            if (dateRangeContainer2) dateRangeContainer2.style.display = 'block';
                        }
                        
                        // Clear date values when switching to date range
                        if (dateFrom) dateFrom.value = '';
                        if (dateTo) dateTo.value = '';
                    } else if (filterValue === 'today') {
                        // Set today's date
                        const today = new Date();
                        const formatDate = (date) => {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            return `${year}-${month}-${day}`;
                        };
                        
                        if (dateFrom && dateTo) {
                            dateFrom.value = formatDate(today);
                            dateTo.value = formatDate(today);
                        }
                    } else {
                        // Clear date values for "All Time"
                        if (dateFrom) dateFrom.value = '';
                        if (dateTo) dateTo.value = '';
                    }
                });
            }
        }
        
        // Apply filter button for All Leads
        const applyButton = document.getElementById('freshLeadsApplyFiltersBtn');
        if (applyButton) {
            applyButton.addEventListener('click', function() {
                console.log('Apply button clicked - reloading data');
                loadSection('fresh_leads');
            });
        }
        
        // Reset filter button for All Leads
        const resetButton = document.getElementById('freshLeadsResetFiltersBtn');
        if (resetButton) {
            resetButton.addEventListener('click', function() {
                console.log('Reset button clicked - clearing filters');
                // Clear all filters
                const psSelect = document.getElementById('freshLeadsPsSelect');
                const sourceSelect = document.getElementById('freshLeadsSourceSelect');
                const statusSelect = document.getElementById('freshLeadsStatusSelect');
                const dateFilterSelect = document.getElementById('freshLeadsDateFilter');
                const dateFromInput = document.getElementById('freshLeadsDateFrom');
                const dateToInput = document.getElementById('freshLeadsDateTo');
                
                if (psSelect) psSelect.value = '';
                if (sourceSelect) sourceSelect.value = '';
                if (statusSelect) statusSelect.value = '';
                if (dateFilterSelect) dateFilterSelect.value = '';
                if (dateFromInput) dateFromInput.value = '';
                if (dateToInput) dateToInput.value = '';
                
                // Hide date range containers
                const dateRangeRow = document.getElementById('dateRangeRow');
                if (dateRangeRow) dateRangeRow.style.display = 'none';
                
                // Reload data with cleared filters
                loadSection('fresh_leads');
            });
        }
        
        // Apply filter button for Fresh Leads Section
        const freshLeadsSectionApplyButton = document.getElementById('freshLeadsSectionApplyFiltersBtn');
        if (freshLeadsSectionApplyButton) {
            freshLeadsSectionApplyButton.addEventListener('click', function() {
                console.log('Fresh Leads Section Apply button clicked - reloading data');
                loadSection('fresh_leads_section');
            });
        }
        
        // Reset filter button for Fresh Leads Section
        const freshLeadsSectionResetButton = document.getElementById('freshLeadsSectionResetFiltersBtn');
        if (freshLeadsSectionResetButton) {
            freshLeadsSectionResetButton.addEventListener('click', function() {
                console.log('Fresh Leads Section Reset button clicked - clearing filters');
                // Clear all filters for fresh leads section
                const psSelect = document.getElementById('freshLeadsSectionPsSelect');
                const dateFilterSelect = document.getElementById('freshLeadsSectionDateFilter');
                const dateFromInput = document.getElementById('freshLeadsSectionDateFrom');
                const dateToInput = document.getElementById('freshLeadsSectionDateTo');
                
                if (psSelect) psSelect.value = '';
                if (dateFilterSelect) dateFilterSelect.value = '';
                if (dateFromInput) dateFromInput.value = '';
                if (dateToInput) dateToInput.value = '';
                
                // Hide date range containers
                const dateRangeRow = document.getElementById('freshLeadsSectionDateRangeRow');
                if (dateRangeRow) dateRangeRow.style.display = 'none';
                
                // Reload data with cleared filters
                loadSection('fresh_leads_section');
            });
        }
        
        // Apply filter button for Followup Leads
        const followupApplyButton = document.getElementById('followupLeadsApplyFiltersBtn');
        if (followupApplyButton) {
            followupApplyButton.addEventListener('click', function() {
                console.log('Followup Apply button clicked - reloading data');
                loadSection('followup_leads');
            });
        }
        
        // Reset filter button for Followup Leads
        const followupResetButton = document.getElementById('followupLeadsResetFiltersBtn');
        if (followupResetButton) {
            followupResetButton.addEventListener('click', function() {
                console.log('Followup Reset button clicked - clearing filters');
                // Clear all filters for followup section
                const psSelect = document.getElementById('followupLeadsPsSelect');
                
                if (psSelect) psSelect.value = '';
                
                // Reload data with cleared filters
                loadSection('followup_leads');
            });
        }
    });

    // Tab change event
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const targetId = e.target.getAttribute('href').substring(1);
            if (targetId === 'fresh') {
                loadSection('fresh_leads');
            } else if (targetId === 'fresh-leads') {
                loadSection('fresh_leads_section');
            } else if (targetId === 'followup') {
                loadSection('followup_leads');
            } else if (targetId === 'analytics') {
                loadAnalyticsDataWithFilter();
            }
        });
});
</script>
{% endblock %} 