{% extends "base.html" %}

{% block title %}PS Analytics - Ather CRM{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-chart-line text-primary"></i> PS Analytics Dashboard</h2>
                <p class="text-muted">Performance insights and metrics for Product Specialists</p>
            </div>
            <div>
                <a href="{{ url_for('ps_dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Date Filter -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="mb-3"><i class="fas fa-calendar-alt"></i> Date Filter</h5>
        <form class="row g-3 align-items-end" id="analyticsFilterForm">
            <div class="col-md-4">
                <label for="fromDate" class="form-label">From Date:</label>
                <input type="date" class="form-control" id="fromDate" name="from_date">
            </div>
            <div class="col-md-4">
                <label for="toDate" class="form-label">To Date:</label>
                <input type="date" class="form-control" id="toDate" name="to_date">
            </div>
            <div class="col-md-4 d-flex gap-2">
                <button type="submit" class="btn btn-success"><i class="fas fa-search"></i> Apply Filter</button>
                <button type="reset" class="btn btn-warning" id="analyticsClearBtn"><i class="fas fa-times"></i> Clear Filter</button>
            </div>
        </form>
    </div>
</div>

<!-- KPI Cards for PS Analytics -->
<div class="kpi-cards-row d-flex flex-nowrap gap-3 mb-4" style="overflow-x: auto;">
    <div class="card analytics-card bg-primary text-white min-width-kpi">
        <div class="card-body text-center">
            <div class="stats-number" id="psWonCases">{{ ps_analytics.won_cases }}</div>
            <div class="stats-label">üèÜ PS Won Cases</div>
            <small class="text-white-50">Date Filtered</small>
        </div>
    </div>
    <div class="card analytics-card bg-success text-white min-width-kpi">
        <div class="card-body text-center">
            <div class="stats-number" id="psConversionRate">{{ ps_analytics.conversion_rate }}%</div>
            <div class="stats-label">Conversion Rate</div>
            <small class="text-white-50">Live Rate</small>
        </div>
    </div>

    <div class="card analytics-card bg-warning text-white min-width-kpi">
        <div class="card-body text-center">
            <div class="stats-number" id="psTotalAssigned">{{ ps_analytics.total_assigned }}</div>
            <div class="stats-label">Total Leads Assigned</div>
            <small class="text-white-50">Date Filtered</small>
        </div>
    </div>
    <div class="card analytics-card bg-danger text-white min-width-kpi">
        <div class="card-body text-center">
            <div class="stats-number" id="psTotalPending">{{ ps_analytics.total_pending }}</div>
            <div class="stats-label">Total Pending Cases</div>
            <small class="text-white-50">Live Count</small>
        </div>
    </div>

</div>



<style>
.min-width-kpi { min-width: 260px; }
.kpi-cards-row::-webkit-scrollbar { height: 8px; }
.kpi-cards-row::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 4px; }
</style>

<!-- PS Performance Section -->
<div class="row">
    <!-- PS Performance (Digital) -->
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="fas fa-laptop text-primary"></i> PS Performance (Digital)</h5>
                </div>
                <div>
                    <select class="form-select form-select-sm" id="ps_branch_filter">
                        <option value="All">All Branches</option>
                        {% for branch in branches %}
                        <option value="{{ branch }}">{{ branch }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="psDigitalTable">
                        <thead class="table-dark">
                            <tr>
                                <th>PS</th>
                                <th>Assigned</th>
                                <th>Untouched</th>
                                <th>Pending leads</th>
                                <th>Won</th>
                                <th>Lost</th>
                                <th>Conversion(%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ps in ps_digital_performance %}
                            <tr>
                                <td>{{ ps.ps_name }}</td>
                                <td>{{ ps.assigned }}</td>
                                <td>{{ ps.untouched }}</td>
                                <td>{{ ps.pending_leads }}</td>
                                <td>{{ ps.won }}</td>
                                <td>{{ ps.lost }}</td>
                                <td>{{ ps.conversion_pct }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Toggle for underlying data -->
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#psFollowupData" aria-expanded="false">
                        <i class="fas fa-eye"></i> View underlying data
                    </button>
                </div>

                <div class="collapse mt-3" id="psFollowupData">
                    <h6>PS Follow-ups (filtered by ps_assigned_at)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Lead UID</th>
                                    <th>PS Name</th>
                                    <th>PS Branch</th>
                                    <th>PS Assigned At</th>
                                    <th>Final Status</th>
                                    <th>Lead Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for followup in ps_followups %}
                                <tr>
                                    <td>{{ followup.lead_uid }}</td>
                                    <td>{{ followup.ps_name }}</td>
                                    <td>{{ followup.ps_branch }}</td>
                                    <td>{{ followup.ps_assigned_at }}</td>
                                    <td>{{ followup.final_status }}</td>
                                    <td>{{ followup.lead_status }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <small class="text-muted">Rows: {{ ps_followups|length }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- PS Performance (Walkin) -->
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0"><i class="fas fa-walking text-success"></i> PS Performance (Walkin)</h5>
                </div>
                <div>
                    <small class="text-muted">Branch: <span id="selectedBranch">All</span></small>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="psWalkinTable">
                        <thead class="table-dark">
                            <tr>
                                <th>PS</th>
                                <th>Punched</th>
                                <th>Untouched</th>
                                <th>Pending</th>
                                <th>Won</th>
                                <th>Lost</th>
                                <th>Conversion(%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ps in ps_walkin_performance %}
                            <tr>
                                <td>{{ ps.ps_name }}</td>
                                <td>{{ ps.punched }}</td>
                                <td>{{ ps.untouched }}</td>
                                <td>{{ ps.pending }}</td>
                                <td>{{ ps.won }}</td>
                                <td>{{ ps.lost }}</td>
                                <td>{{ ps.conversion_pct }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Toggle for underlying walkin data -->
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#walkinData" aria-expanded="false">
                        <i class="fas fa-eye"></i> View underlying data
                    </button>
                </div>

                <div class="collapse mt-3" id="walkinData">
                    <h6>Walkin (filtered by created_at)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Mobile</th>
                                    <th>PS Assigned</th>
                                    <th>Branch</th>
                                    <th>Status</th>
                                    <th>Created At</th>
                                    <th>First Call Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for walkin in walkin_data %}
                                <tr>
                                    <td>{{ walkin.customer_name }}</td>
                                    <td>{{ walkin.mobile }}</td>
                                    <td>{{ walkin.ps_assigned }}</td>
                                    <td>{{ walkin.branch }}</td>
                                    <td>{{ walkin.status }}</td>
                                    <td>{{ walkin.created_at }}</td>
                                    <td>{{ walkin.first_call_date or 'Not called' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <small class="text-muted">Rows: {{ walkin_data|length }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Branch filter functionality
document.getElementById('ps_branch_filter').addEventListener('change', function() {
    const selectedBranch = this.value;
    document.getElementById('selectedBranch').textContent = selectedBranch;

    // Apply date filter and branch filter
    applyFilters();
});

// Date filter functionality
document.getElementById('analyticsFilterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    applyFilters();
});

document.getElementById('analyticsClearBtn').addEventListener('click', function() {
    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    document.getElementById('ps_branch_filter').value = 'All';
    document.getElementById('selectedBranch').textContent = 'All';
    applyFilters();
});

function applyFilters() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    const selectedBranch = document.getElementById('ps_branch_filter').value;

    // Build query parameters
    const params = new URLSearchParams();
    if (fromDate) params.append('from_date', fromDate);
    if (toDate) params.append('to_date', toDate);
    if (selectedBranch && selectedBranch !== 'All') params.append('branch', selectedBranch);

    // Reload page with filters
    const url = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
    window.location.href = url;
}

// Auto-apply current date range on page load
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    let fromDate = urlParams.get('from_date');
    let toDate = urlParams.get('to_date');
    const branch = urlParams.get('branch');

    // Default to MTD if no dates provided
    if (!fromDate || !toDate) {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        fromDate = `${y}-${m}-01`;
        toDate = `${y}-${m}-${d}`;
        // Update URL to include defaults so backend uses same range
        const params = new URLSearchParams(window.location.search);
        params.set('from_date', fromDate);
        params.set('to_date', toDate);
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        if (!window.location.search.includes('from_date') || !window.location.search.includes('to_date')) {
            window.history.replaceState({}, '', newUrl);
        }
    }

    document.getElementById('fromDate').value = fromDate;
    document.getElementById('toDate').value = toDate;
    if (branch) {
        document.getElementById('ps_branch_filter').value = branch;
        document.getElementById('selectedBranch').textContent = branch;
    }
});
</script>

{% endblock %} 