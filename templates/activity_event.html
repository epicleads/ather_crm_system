{% extends "base.html" %}

{% block title %}Event Leads Entry - Ather CRM{% endblock %}

{% block content %}
<style>
  .alert-sm {
    padding: 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.375rem;
  }
  
  .is-warning {
    border-color: #ffc107 !important;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25) !important;
  }
  
  .is-valid {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
  }
  
  .is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
  }
  
  .duplicate-feedback {
    margin-top: 0.25rem;
  }
</style>
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-info text-white">
            <h4><i class="fas fa-calendar-alt"></i> Event/Activity Lead Entry</h4>
        </div>
        <div class="card-body">
            <form method="POST" id="eventLeadForm">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="activity_name" class="form-label">Activity Name</label>
                        <select class="form-select" id="activity_name" name="activity_name" required>
                            <option value="">Select Activity</option>
                            <option value="Umbrella Event">Umbrella Event</option>
                            <option value="Umbrella Activity">Umbrella Activity</option>
                            <option value="BTL">BTL</option>
                            <option value="Mall Activity">Mall Activity</option>
                            <option value="Corporate Activity">Corporate Activity</option>
                            <option value="Society Activity">Society Activity</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="activity_location" class="form-label">Activity Location</label>
                        <input type="text" class="form-control" id="activity_location" name="activity_location" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="ps_name" class="form-label">PS Name</label>
                        <input type="text" class="form-control" id="ps_name" name="ps_name" value="{{ session.ps_name }}" required readonly>
                    </div>
                    <div class="col-md-6">
                        <label for="location" class="form-label">Location (Branch)</label>
                        <input type="text" class="form-control" id="location" name="location" value="{{ session.branch }}" required readonly>
                    </div>
                </div>
                <hr>
                <h5>Customer Details</h5>
                <div id="customerLeads">
                    <div class="row mb-3 customer-lead-row">
                        <div class="col-md-3">
                            <label class="form-label">Customer Name</label>
                            <input type="text" class="form-control" name="customer_name[]" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Mobile Number</label>
                            <input type="tel" class="form-control" name="customer_phone_number[]" pattern="[0-9]{10}" maxlength="10" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Customer Location</label>
                            <input type="text" class="form-control" name="customer_location[]">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Profession</label>
                            <input type="text" class="form-control" name="customer_profession[]">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Gender</label>
                            <select class="form-select" name="gender[]">
                                <option value="MALE">Male</option>
                                <option value="FEMALE">Female</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Interested Model</label>
                            <select class="form-select" name="interested_model[]">
                                <option value="">Select Model</option>
                                <option>ATHER 450</option>
                                <option>ATHER 450X (2.9 kWh)</option>
                                <option>ATHER 450X (3.7 kWh)</option>
                                <option>ATHER 450X (2.9 kWh) Pro Pack</option>
                                <option>ATHER 450X (3.7 kWh) Pro Pack</option>
                                <option>ATHER 450 Apex STD</option>
                                <option>ATHER RIZTA S Mono (2.9 kWh)</option>
                                <option>ATHER RIZTA S Super Matte (2.9 kWh)</option>
                                <option>ATHER RIZTA Z Mono (2.9 kWh)</option>
                                <option>ATHER RIZTA Z Duo (2.9 kWh)</option>
                                <option>ATHER RIZTA Z Super Matte (2.9 kWh)</option>
                                <option>ATHER RIZTA Z Mono (3.7 kWh)</option>
                                <option>ATHER RIZTA Z Duo (3.7 kWh)</option>
                                <option>ATHER RIZTA Z Super Matte (3.7 kWh)</option>
                                <option>APEX</option>
                            </select>
                        </div>
                        <div class="col-md-2 mt-2">
                            <label class="form-label">Remarks</label>
                            <input type="text" class="form-control" name="remarks[]">
                        </div>
                        <div class="col-md-2 mt-2">
                            <label class="form-label">Lead Status</label>
                            <select class="form-select" name="lead_status[]">
                                <option value="HOT">Hot</option>
                                <option value="WARM">Warm</option>
                                <option value="COLD">Cold</option>
                                <option value="CASUAL ENQUIRY">Casual Enquiry</option>
                            </select>
                        </div>
                        <div class="col-md-1 mt-2">
                            <label class="form-label">Month</label>
                            <input type="text" class="form-control" name="month[]" value="{{ now.strftime('%b') }}">
                        </div>
                        <div class="col-md-2 mt-2">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" name="date[]" value="{{ now.strftime('%Y-%m-%d') }}">
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-danger remove-lead-row" style="display:none;"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <button type="button" class="btn btn-secondary" id="addCustomerLead"><i class="fas fa-plus"></i> Add Another Lead</button>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-info btn-lg" onclick="return checkDuplicateEventLeads(event)">
                        <i class="fas fa-save"></i> Submit Event Leads
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Duplicate Lead Modal -->
<div class="modal fade" id="duplicateEventLeadModal" tabindex="-1" aria-labelledby="duplicateEventLeadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="duplicateEventLeadModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>Duplicate Leads Detected
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="duplicateEventLeadDetails">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-warning" onclick="proceedWithDuplicateEvent()">
          <i class="fas fa-plus-circle me-2"></i>Add as Duplicates
        </button>
      </div>
    </div>
  </div>
</div>
<script>
document.getElementById('addCustomerLead').addEventListener('click', function() {
    const container = document.getElementById('customerLeads');
    const firstRow = container.querySelector('.customer-lead-row');
    const newRow = firstRow.cloneNode(true);
    newRow.querySelectorAll('input, select').forEach(input => {
        input.value = '';
    });
    newRow.querySelector('.remove-lead-row').style.display = 'block';
    container.appendChild(newRow);
    
    // Add duplicate checking to the new phone input field
    const newPhoneInput = newRow.querySelector('input[name="customer_phone_number[]"]');
    if (newPhoneInput) {
        newPhoneInput.addEventListener('blur', function() {
            const phoneNumber = this.value.trim();
            if (phoneNumber) {
                checkDuplicateOnBlur(phoneNumber, this);
            }
        });
    }
});

document.getElementById('customerLeads').addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-lead-row')) {
        e.target.closest('.customer-lead-row').remove();
    }
});

// Duplicate lead checking functions
function normalizePhoneNumber(phone) {
    // Remove all non-digit characters
    return phone.replace(/\D/g, '');
}

function getLast10Digits(phone) {
    // Get last 10 digits for duplicate checking (handles +91, 91, etc.)
    const normalized = normalizePhoneNumber(phone);
    return normalized.slice(-10);
}

async function checkDuplicateEventLeads(event) {
    event.preventDefault();
    
    // Get all phone numbers from the form
    const phoneInputs = document.querySelectorAll('input[name="customer_phone_number[]"]');
    const nameInputs = document.querySelectorAll('input[name="customer_name[]"]');
    
    let duplicates = [];
    let validLeads = [];
    
    // Check each phone number for duplicates
    for (let i = 0; i < phoneInputs.length; i++) {
        const phoneNumber = phoneInputs[i].value.trim();
        const customerName = nameInputs[i].value.trim();
        
        if (phoneNumber && customerName) {
            const normalizedPhone = normalizePhoneNumber(phoneNumber);
            const last10Digits = getLast10Digits(phoneNumber);
            
            console.log('üîç Duplicate check details:');
            console.log(`  - Original phone: ${phoneNumber}`);
            console.log(`  - Normalized: ${normalizedPhone}`);
            console.log(`  - Last 10 digits: ${last10Digits}`);
            
            try {
                const response = await fetch('/check_duplicate_event_lead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone_number: last10Digits // Send last 10 digits for better duplicate detection
                    })
                });
                
                const result = await response.json();
                
                                    if (result.is_duplicate) {
                        if (result.duplicate_type === 'exact_match') {
                            duplicates.push({
                                phone: phoneNumber,
                                name: customerName,
                                type: 'exact_match',
                                message: result.message,
                                source: result.source,
                                existing_lead: result.existing_lead
                            });
                    } else {
                        // This is a duplicate with new source - can be added
                        validLeads.push({
                            phone: phoneNumber,
                            name: customerName,
                            type: 'new_source',
                            message: result.message,
                            source: result.source
                        });
                    }
                } else {
                    // No duplicate found
                    validLeads.push({
                        phone: phoneNumber,
                        name: customerName,
                        type: 'new',
                        message: 'No duplicate found'
                    });
                }
            } catch (error) {
                console.error('Error checking duplicate lead:', error);
                // If there's an error, treat as valid lead
                validLeads.push({
                    phone: phoneNumber,
                    name: customerName,
                    type: 'error',
                    message: 'Error checking duplicate'
                });
            }
        }
    }
    
    if (duplicates.length > 0) {
        // Show duplicate lead modal
        const modal = new bootstrap.Modal(document.getElementById('duplicateEventLeadModal'));
        const detailsDiv = document.getElementById('duplicateEventLeadDetails');
        
        let detailsHtml = `
            <div class="alert alert-danger">
                <strong>‚ö†Ô∏è Exact Duplicates Found!</strong><br>
                The following leads cannot be added as they already exist:
            </div>
        `;
        
        duplicates.forEach(duplicate => {
            detailsHtml += `
                <div class="alert alert-warning">
                    <strong>${duplicate.name}</strong> - ${duplicate.phone}<br>
                    <small>${duplicate.message}</small>
                </div>
            `;
            
            // Add detailed duplicate information if available
            if (duplicate.existing_lead) {
                detailsHtml += `
                    <div class="alert alert-info">
                        <strong>Existing Lead Details:</strong><br>
                        <strong>Customer Name:</strong> ${duplicate.existing_lead.customer_name}<br>
                        <strong>Assigned CRE:</strong> ${duplicate.existing_lead.cre_name || 'Unassigned'}<br>
                        <strong>Status:</strong> ${duplicate.existing_lead.lead_status || 'N/A'}<br>
                        <strong>Final Status:</strong> ${duplicate.existing_lead.final_status || 'N/A'}
                    </div>
                `;
                
                // Add CRE assigned timestamp if available
                if (duplicate.existing_lead.cre_assigned_timestamp && duplicate.existing_lead.cre_assigned_timestamp !== 'null') {
                    try {
                        const creTimestamp = new Date(duplicate.existing_lead.cre_assigned_timestamp);
                        if (!isNaN(creTimestamp.getTime())) {
                            const istTimestamp = new Date(creTimestamp.getTime() + (5.5 * 60 * 60 * 1000)); // Add 5:30 hours
                            const formattedCreTime = istTimestamp.toLocaleString('en-IN', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                timeZone: 'Asia/Kolkata'
                            });
                            
                            detailsHtml += `
                                <div class="alert alert-primary">
                                    <strong>CRE Assigned:</strong> ${formattedCreTime}
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.log('Error formatting CRE timestamp:', error);
                    }
                }
                
                // Add Won/Lost timestamp if final status is Won or Lost
                if (duplicate.existing_lead.final_status === 'Won' && duplicate.existing_lead.won_timestamp && duplicate.existing_lead.won_timestamp !== 'null') {
                    try {
                        const wonTimestamp = new Date(duplicate.existing_lead.won_timestamp);
                        if (!isNaN(wonTimestamp.getTime())) {
                            const istWonTime = new Date(wonTimestamp.getTime() + (5.5 * 60 * 60 * 1000)); // Add 5:30 hours
                            const formattedWonTime = istWonTime.toLocaleString('en-IN', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                timeZone: 'Asia/Kolkata'
                            });
                            
                            detailsHtml += `
                                <div class="alert alert-success">
                                    <strong>Won Timestamp:</strong> ${formattedWonTime}
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.log('Error formatting Won timestamp:', error);
                    }
                } else if (duplicate.existing_lead.final_status === 'Lost' && duplicate.existing_lead.lost_timestamp && duplicate.existing_lead.lost_timestamp !== 'null') {
                    try {
                        const lostTimestamp = new Date(duplicate.existing_lead.lost_timestamp);
                        if (!isNaN(lostTimestamp.getTime())) {
                            const istLostTime = new Date(lostTimestamp.getTime() + (5.5 * 60 * 60 * 1000)); // Add 5:30 hours
                            const formattedLostTime = istLostTime.toLocaleString('en-IN', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                timeZone: 'Asia/Kolkata'
                            });
                            
                            detailsHtml += `
                                <div class="alert alert-danger">
                                    <strong>Lost Timestamp:</strong> ${formattedLostTime}
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.log('Error formatting Lost timestamp:', error);
                    }
                }
            }
        });
        
        if (validLeads.length > 0) {
            detailsHtml += `
                <div class="alert alert-info">
                    <strong>‚úÖ Valid Leads:</strong><br>
                    ${validLeads.map(lead => `${lead.name} - ${lead.phone}`).join('<br>')}
                </div>
            `;
        }
        
        detailsHtml += `
            <div class="alert alert-success">
                <strong>üí° You can still submit the form to add the valid leads</strong>
            </div>
        `;
        
        detailsDiv.innerHTML = detailsHtml;
        modal.show();
        return false;
    } else {
        // No exact duplicates found, proceed with form submission
        document.getElementById('eventLeadForm').submit();
        return true;
    }
}

function proceedWithDuplicateEvent() {
    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('duplicateEventLeadModal'));
    modal.hide();
    
    // Submit the form
    document.getElementById('eventLeadForm').submit();
}

// Add real-time duplicate checking on phone number input
document.addEventListener('DOMContentLoaded', function() {
    const phoneInputs = document.querySelectorAll('input[name="customer_phone_number[]"]');
    
    phoneInputs.forEach(input => {
        input.addEventListener('blur', function() {
            const phoneNumber = this.value.trim();
            if (phoneNumber) {
                checkDuplicateOnBlur(phoneNumber, this);
            }
        });
        
        // Clear feedback when user starts typing
        input.addEventListener('input', function() {
            this.classList.remove('is-invalid', 'is-valid', 'is-warning');
            const feedbackDiv = this.parentNode.querySelector('.duplicate-feedback');
            if (feedbackDiv) {
                feedbackDiv.remove();
            }
        });
    });
});

// Function to check duplicates on blur without submitting form
async function checkDuplicateOnBlur(phoneNumber, inputElement) {
    const normalizedPhone = normalizePhoneNumber(phoneNumber);
    const last10Digits = getLast10Digits(phoneNumber);
    
    try {
        const response = await fetch('/check_duplicate_event_lead', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone_number: last10Digits // Use last 10 digits for better duplicate detection
            })
        });
        
        const result = await response.json();
        
        if (result.is_duplicate) {
            if (result.duplicate_type === 'exact_match') {
                // Show error feedback
                inputElement.classList.add('is-invalid');
                inputElement.classList.remove('is-valid', 'is-warning');
                
                // Add feedback below the input
                let feedbackDiv = inputElement.parentNode.querySelector('.duplicate-feedback');
                if (!feedbackDiv) {
                    feedbackDiv = document.createElement('div');
                    feedbackDiv.className = 'duplicate-feedback mt-1';
                    inputElement.parentNode.appendChild(feedbackDiv);
                }
                
                let feedbackMessage = `<i class="fas fa-exclamation-triangle me-1"></i><strong>Duplicate Found!</strong> ${result.message}`;
                
                // Add more details if available
                if (result.existing_lead) {
                    feedbackMessage += `<br><small>Existing: ${result.existing_lead.customer_name} - ${result.existing_lead.lead_status || 'N/A'} - ${result.existing_lead.final_status || 'N/A'}</small>`;
                }
                
                feedbackDiv.innerHTML = `
                    <div class="alert alert-danger alert-sm">
                        ${feedbackMessage}
                    </div>
                `;
            } else {
                // Show warning feedback for new source
                inputElement.classList.add('is-warning');
                inputElement.classList.remove('is-invalid', 'is-valid');
                
                let feedbackDiv = inputElement.parentNode.querySelector('.duplicate-feedback');
                if (!feedbackDiv) {
                    feedbackDiv = document.createElement('div');
                    feedbackDiv.className = 'duplicate-feedback mt-1';
                    inputElement.parentNode.appendChild(feedbackDiv);
                }
                
                let feedbackMessage = `<i class="fas fa-info-circle me-1"></i><strong>Existing Lead Found!</strong> ${result.message}`;
                
                // Add more details if available
                if (result.existing_lead) {
                    feedbackMessage += `<br><small>Existing: ${result.existing_lead.customer_name} - ${result.existing_lead.lead_status || 'N/A'} - ${result.existing_lead.final_status || 'N/A'}</small>`;
                }
                
                feedbackDiv.innerHTML = `
                    <div class="alert alert-warning alert-sm">
                        ${feedbackMessage}
                    </div>
                `;
            }
        } else {
            // No duplicate found
            inputElement.classList.remove('is-invalid', 'is-warning');
            inputElement.classList.add('is-valid');
            
            let feedbackDiv = inputElement.parentNode.querySelector('.duplicate-feedback');
            if (feedbackDiv) {
                feedbackDiv.remove();
            }
        }
    } catch (error) {
        console.error('Error checking duplicate lead:', error);
        // Don't show error feedback on blur, just log it
    }
}
</script>
{% endblock %} 